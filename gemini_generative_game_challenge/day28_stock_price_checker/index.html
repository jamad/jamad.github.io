<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ポートフォリオ差分チェッカー</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- SheetJS (xlsx) for reading Excel/CSV -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body {
            font-family: 'Helvetica Neue', Arial, sans-serif;
            background-color: #111827; /* Dark background */
            color: #e5e7eb;
            -webkit-tap-highlight-color: transparent;
        }
        .glass-panel {
            background: rgba(31, 41, 55, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        /* Mobile touch optimization */
        .touch-btn {
            min-height: 48px;
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-slide-in {
            animation: slideIn 0.3s ease-out forwards;
        }
        
        /* Custom scrollbar for dark mode */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1f2937; 
        }
        ::-webkit-scrollbar-thumb {
            background: #4b5563; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #6b7280; 
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- Sound Engine ---
        const playSound = (type) => {
            try {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                if (!AudioContext) return;
                
                const ctx = new AudioContext();
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();

                osc.connect(gain);
                gain.connect(ctx.destination);

                const now = ctx.currentTime;

                if (type === 'success') {
                    // Futuristic Ping
                    osc.type = 'sine';
                    osc.frequency.setValueAtTime(800, now);
                    osc.frequency.exponentialRampToValueAtTime(1200, now + 0.1);
                    gain.gain.setValueAtTime(0.2, now);
                    gain.gain.exponentialRampToValueAtTime(0.01, now + 0.6);
                    osc.start(now);
                    osc.stop(now + 0.6);
                } else if (type === 'upload') {
                    // Soft Click
                    osc.type = 'triangle';
                    osc.frequency.setValueAtTime(300, now);
                    gain.gain.setValueAtTime(0.1, now);
                    gain.gain.linearRampToValueAtTime(0.01, now + 0.05);
                    osc.start(now);
                    osc.stop(now + 0.05);
                } else if (type === 'error') {
                    // Low Buzz
                    osc.type = 'sawtooth';
                    osc.frequency.setValueAtTime(100, now);
                    osc.frequency.linearRampToValueAtTime(80, now + 0.3);
                    gain.gain.setValueAtTime(0.15, now);
                    gain.gain.linearRampToValueAtTime(0.01, now + 0.3);
                    osc.start(now);
                    osc.stop(now + 0.3);
                }
            } catch (e) {
                console.error("Audio error", e);
            }
        };

        // --- File Upload Component (Dark Mode) ---
        const FileDrop = ({ label, file, setFile, color }) => {
            const inputRef = useRef(null);

            const handleFile = (e) => {
                const selected = e.target.files[0];
                if (selected) {
                    setFile(selected);
                    playSound('upload');
                }
            };

            const borderColor = file ? (color === 'blue' ? 'border-blue-500' : 'border-indigo-500') : 'border-gray-700';
            const bgColor = file ? (color === 'blue' ? 'bg-blue-900/20' : 'bg-indigo-900/20') : 'bg-gray-800/50';
            const iconColor = file ? (color === 'blue' ? 'text-blue-400' : 'text-indigo-400') : 'text-gray-500';

            return (
                <div 
                    onClick={() => inputRef.current.click()}
                    className={`
                        relative overflow-hidden cursor-pointer touch-btn
                        rounded-xl border-2 border-dashed transition-all duration-200
                        flex flex-col items-center justify-center p-6 text-center
                        active:scale-95 hover:bg-gray-800
                        ${borderColor} ${bgColor}
                    `}
                >
                    <input 
                        type="file" 
                        accept=".xlsx,.xls,.csv" 
                        className="hidden" 
                        ref={inputRef}
                        onChange={handleFile}
                    />
                    {file ? (
                        <>
                            <div className={`${iconColor} mb-2`}>
                                <i data-lucide="check-circle" width="32" height="32"></i>
                            </div>
                            <span className="font-bold text-gray-200 text-sm truncate w-full px-2">
                                {file.name}
                            </span>
                            <span className="text-xs text-gray-400 mt-1">タップして変更</span>
                        </>
                    ) : (
                        <>
                            <div className="text-gray-600 mb-2">
                                <i data-lucide="upload-cloud" width="32" height="32"></i>
                            </div>
                            <span className="font-bold text-gray-400">{label}</span>
                            <span className="text-xs text-gray-600 mt-1">タップして選択</span>
                        </>
                    )}
                </div>
            );
        };

        // --- Main Application ---
        const App = () => {
            const [oldFile, setOldFile] = useState(null);
            const [newFile, setNewFile] = useState(null);
            const [differences, setDifferences] = useState([]);
            const [isAnalyzing, setIsAnalyzing] = useState(false);
            const [analyzed, setAnalyzed] = useState(false);

            useEffect(() => {
                lucide.createIcons();
            }, [oldFile, newFile, analyzed]);

            // Helper: Find the header row index
            const findHeaderRow = (data) => {
                for (let i = 0; i < Math.min(data.length, 15); i++) {
                    const row = data[i];
                    if (!row) continue;
                    const rowStr = row.join(' ').toUpperCase();
                    // Look for key columns
                    if (rowStr.includes('NAME') && (rowStr.includes('PRICE') || rowStr.includes('MARKET_VALUE'))) {
                        return i;
                    }
                }
                return 0;
            };

            // Helper: Parse file to JSON
            const parseFile = (file) => {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const data = e.target.result;
                            const workbook = XLSX.read(data, { type: 'binary' });
                            const sheetName = workbook.SheetNames[0];
                            const sheet = workbook.Sheets[sheetName];
                            const jsonData = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: "" });
                            resolve(jsonData);
                        } catch (err) {
                            reject(err);
                        }
                    };
                    reader.readAsBinaryString(file);
                });
            };

            const handleAnalyze = async () => {
                if (!oldFile || !newFile) {
                    playSound('error');
                    alert("新旧両方のファイルを選択してください。");
                    return;
                }

                setIsAnalyzing(true);
                setAnalyzed(false);

                try {
                    const [oldDataRaw, newDataRaw] = await Promise.all([parseFile(oldFile), parseFile(newFile)]);

                    // Process Data with holdings support
                    const processData = (rawData) => {
                        const headerIndex = findHeaderRow(rawData);
                        if (!rawData[headerIndex]) return {};
                        
                        const headers = rawData[headerIndex].map(h => String(h).trim().toUpperCase());
                        
                        // Map column indices flexibly
                        const idxName = headers.indexOf('NAME');
                        // Try multiple variations for ID
                        let idxIsin = headers.indexOf('ISIN');
                        if (idxIsin === -1) idxIsin = headers.indexOf('ID');

                        // Try multiple variations for Price
                        const idxPrice = headers.indexOf('PRICE');

                        // Try multiple variations for Holdings/Quantity
                        let idxHoldings = headers.indexOf('HOLDINGS');
                        if (idxHoldings === -1) idxHoldings = headers.indexOf('SHARE');
                        if (idxHoldings === -1) idxHoldings = headers.indexOf('QUANTITY');
                        if (idxHoldings === -1) idxHoldings = headers.indexOf('QTY');
                        if (idxHoldings === -1) idxHoldings = headers.indexOf('AMOUNT');

                        const result = {};

                        for (let i = headerIndex + 1; i < rawData.length; i++) {
                            const row = rawData[i];
                            const name = row[idxName];
                            const isin = row[idxIsin];
                            
                            // If price is missing, try to calculate from MarketValue / Holdings if available? 
                            // For now, assume PRICE exists based on user sample
                            let price = parseFloat(row[idxPrice]);
                            
                            // Get Holdings (default to 1 if not found, so diff still works as price diff)
                            let holdings = 0;
                            if (idxHoldings !== -1) {
                                holdings = parseFloat(row[idxHoldings]);
                            }

                            if ((name || isin) && !isNaN(price)) {
                                const key = isin || name;
                                result[key] = {
                                    name: name || "Unknown",
                                    price: price,
                                    holdings: isNaN(holdings) ? 0 : holdings,
                                    isin: isin
                                };
                            }
                        }
                        return result;
                    };

                    const oldMap = processData(oldDataRaw);
                    const newMap = processData(newDataRaw);

                    const diffList = [];

                    // Compare
                    Object.keys(newMap).forEach(key => {
                        const newItem = newMap[key];
                        const oldItem = oldMap[key];

                        if (oldItem) {
                            const priceDiff = newItem.price - oldItem.price;
                            
                            // Calculate Profit/Loss: Price Diff * Current Holdings
                            // We use current holdings to show "how much my current assets gained/lost"
                            const totalProfit = priceDiff * newItem.holdings;

                            // Filter small noise
                            if (Math.abs(priceDiff) > 0.0001) { 
                                diffList.push({
                                    name: newItem.name,
                                    isin: key,
                                    oldPrice: oldItem.price,
                                    newPrice: newItem.price,
                                    holdings: newItem.holdings,
                                    diff: priceDiff, // Unit price diff
                                    totalProfit: totalProfit, // Total value diff
                                    percent: (priceDiff / oldItem.price) * 100
                                });
                            }
                        } else {
                            // New Entry
                            diffList.push({
                                name: newItem.name,
                                isin: key,
                                oldPrice: 0,
                                newPrice: newItem.price,
                                holdings: newItem.holdings,
                                diff: newItem.price,
                                totalProfit: 0, // Treated as 0 profit (just new asset) or could be full value
                                percent: 100,
                                isNew: true
                            });
                        }
                    });

                    // Sort: Descending by Total Profit (largest gain first)
                    // If user prefers unit price diff sort, we can change this.
                    // Usually "impact on portfolio" is better represented by totalProfit.
                    diffList.sort((a, b) => b.totalProfit - a.totalProfit);

                    setDifferences(diffList);
                    setAnalyzed(true);
                    playSound('success');

                } catch (error) {
                    console.error(error);
                    playSound('error');
                    alert("ファイルの読み込みに失敗しました。形式を確認してください。");
                } finally {
                    setIsAnalyzing(false);
                }
            };

            const formatCurrency = (num) => {
                return new Intl.NumberFormat('ja-JP', { style: 'currency', currency: 'EUR' }).format(num);
            };
            
            const formatNumber = (num) => {
                return new Intl.NumberFormat('ja-JP').format(num);
            };

            return (
                <div className="min-h-screen pb-12 bg-gray-900 text-gray-100">
                    {/* Header */}
                    <div className="bg-gray-800/80 backdrop-blur-md shadow-lg sticky top-0 z-10 px-4 py-4 border-b border-gray-700 flex items-center justify-between">
                        <div className="flex items-center space-x-2">
                            <div className="p-2 bg-indigo-900/50 rounded-lg text-indigo-400">
                                <i data-lucide="bar-chart-2"></i>
                            </div>
                            <h1 className="text-lg font-bold text-gray-100">ポートフォリオ・チェッカー</h1>
                        </div>
                        {analyzed && (
                             <button 
                                onClick={() => { setAnalyzed(false); setOldFile(null); setNewFile(null); }}
                                className="text-xs font-medium text-gray-400 hover:text-white bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded-full transition-colors"
                            >
                                リセット
                            </button>
                        )}
                    </div>

                    <div className="container mx-auto max-w-2xl p-4 space-y-6">
                        
                        {/* Upload Section */}
                        {!analyzed && (
                            <div className="space-y-4 animate-slide-in">
                                <div className="grid grid-cols-2 gap-4">
                                    <FileDrop 
                                        label="旧ファイル (Old)" 
                                        file={oldFile} 
                                        setFile={setOldFile} 
                                        color="blue"
                                    />
                                    <FileDrop 
                                        label="新ファイル (New)" 
                                        file={newFile} 
                                        setFile={setNewFile} 
                                        color="indigo"
                                    />
                                </div>

                                <button
                                    onClick={handleAnalyze}
                                    disabled={!oldFile || !newFile || isAnalyzing}
                                    className={`
                                        w-full py-4 rounded-xl font-bold text-lg shadow-lg touch-btn
                                        flex items-center justify-center space-x-2
                                        transition-all duration-200 border border-transparent
                                        ${(!oldFile || !newFile) 
                                            ? 'bg-gray-800 text-gray-600 cursor-not-allowed border-gray-700' 
                                            : 'bg-indigo-600 text-white hover:bg-indigo-500 hover:scale-[1.02] shadow-indigo-900/50'}
                                    `}
                                >
                                    {isAnalyzing ? (
                                        <>
                                            <i data-lucide="loader-2" className="animate-spin mr-2"></i>
                                            解析中...
                                        </>
                                    ) : (
                                        <>
                                            <i data-lucide="search" className="mr-2"></i>
                                            比較を開始
                                        </>
                                    )}
                                </button>
                                
                                <div className="text-center text-xs text-gray-500 mt-4">
                                    <p>Excel (.xlsx) または CSV ファイルをアップロード</p>
                                    <p>「NAME」「PRICE」「HOLDINGS」列を自動検出します</p>
                                </div>
                            </div>
                        )}

                        {/* Results Section */}
                        {analyzed && (
                            <div className="space-y-4 animate-slide-in">
                                <div className="flex items-center justify-between px-2">
                                    <h2 className="text-gray-400 font-bold text-sm uppercase tracking-wider">
                                        分析結果: {differences.length}件
                                    </h2>
                                    <span className="text-xs text-indigo-400 font-medium bg-indigo-900/30 px-2 py-1 rounded border border-indigo-500/20">
                                        損益額が大きい順
                                    </span>
                                </div>

                                <div className="space-y-3">
                                    {differences.map((item, idx) => (
                                        <div 
                                            key={idx} 
                                            className="glass-panel p-4 rounded-xl shadow-lg flex flex-col space-y-3 active:bg-gray-800 transition-colors"
                                        >
                                            {/* Row 1: Name & Badge */}
                                            <div className="flex items-start justify-between">
                                                <div className="flex items-center space-x-2 overflow-hidden">
                                                    <h3 className="font-bold text-gray-200 truncate text-base">
                                                        {item.name}
                                                    </h3>
                                                    {item.isNew && (
                                                        <span className="text-[10px] bg-emerald-900 text-emerald-300 px-1.5 py-0.5 rounded border border-emerald-700 uppercase font-bold">NEW</span>
                                                    )}
                                                </div>
                                                <div className="text-right">
                                                     <div className={`text-xl font-bold tracking-tight ${item.totalProfit > 0 ? 'text-emerald-400' : (item.totalProfit < 0 ? 'text-rose-400' : 'text-gray-400')}`}>
                                                        {item.totalProfit > 0 ? '+' : ''}{formatCurrency(item.totalProfit)}
                                                    </div>
                                                </div>
                                            </div>

                                            {/* Row 2: Details Grid */}
                                            <div className="grid grid-cols-2 gap-4 text-sm pt-2 border-t border-gray-700/50">
                                                
                                                {/* Left: Price & Holdings */}
                                                <div className="space-y-1">
                                                    <div className="text-xs text-gray-500 uppercase tracking-wide">価格変動</div>
                                                    <div className="flex items-center space-x-1 text-gray-300">
                                                        <span>{item.oldPrice.toFixed(2)}</span>
                                                        <i data-lucide="arrow-right" className="w-3 h-3 text-gray-600"></i>
                                                        <span className="font-medium text-white">{item.newPrice.toFixed(2)}</span>
                                                    </div>
                                                    <div className="text-xs text-gray-500 mt-1">
                                                        保有数: <span className="text-gray-300 font-mono">{formatNumber(item.holdings)}</span>
                                                    </div>
                                                </div>

                                                {/* Right: Unit Diff & Percent */}
                                                <div className="space-y-1 text-right">
                                                    <div className="text-xs text-gray-500 uppercase tracking-wide">単価差 / 騰落率</div>
                                                    <div className={`${item.diff > 0 ? 'text-emerald-400' : 'text-rose-400'} font-medium`}>
                                                        {item.diff > 0 ? '+' : ''}{item.diff.toFixed(2)}
                                                    </div>
                                                    <div className={`text-xs inline-block px-1.5 rounded ${item.percent > 0 ? 'bg-emerald-900/30 text-emerald-400' : 'bg-rose-900/30 text-rose-400'}`}>
                                                        {item.percent > 0 ? '▲' : '▼'} {Math.abs(item.percent).toFixed(2)}%
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    ))}

                                    {differences.length === 0 && (
                                        <div className="text-center py-12 text-gray-600">
                                            <i data-lucide="check-circle-2" className="mx-auto mb-2 opacity-30" width="48" height="48"></i>
                                            <p>価格の変動は見つかりませんでした</p>
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>