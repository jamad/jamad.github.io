import React, { useState, useEffect, useRef, useCallback } from 'react';
import { BookOpen, Search, Volume2, VolumeX, Download, RefreshCw, Languages, X, Check } from 'lucide-react';

/**
* WordGrower - 単語育成ブラウザ (v1.3)
* * 更新履歴:
* - 長押しメニューが指を離した瞬間に閉じてしまう問題を修正 (リスナー登録の遅延)
* - 長押し完了時にバイブレーション(haptic feedback)を追加（対応デバイスのみ）
*/

// --- Audio System (Web Audio API) ---
const playSound = (type) => {
try {
const AudioContext = window.AudioContext || window.webkitAudioContext;
if (!AudioContext) return;

const ctx = new AudioContext();
const osc = ctx.createOscillator();
const gainNode = ctx.createGain();

osc.connect(gainNode);
gainNode.connect(ctx.destination);

const now = ctx.currentTime;

switch (type) {
case 'tap': // ピコッ
osc.type = 'sine';
osc.frequency.setValueAtTime(800, now);
osc.frequency.exponentialRampToValueAtTime(1200, now + 0.1);
gainNode.gain.setValueAtTime(0.1, now);
gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
osc.start(now);
osc.stop(now + 0.1);
break;

case 'levelup': // キラキラ〜ン
osc.type = 'triangle';
osc.frequency.setValueAtTime(400, now);
osc.frequency.linearRampToValueAtTime(800, now + 0.1);
osc.frequency.linearRampToValueAtTime(1200, now + 0.2);
gainNode.gain.setValueAtTime(0.1, now);
gainNode.gain.linearRampToValueAtTime(0, now + 0.5);
osc.start(now);
osc.stop(now + 0.5);
break;

case 'menu': // シュッ
osc.type = 'sine';
osc.frequency.setValueAtTime(300, now);
osc.frequency.exponentialRampToValueAtTime(600, now + 0.15);
gainNode.gain.setValueAtTime(0.05, now);
gainNode.gain.linearRampToValueAtTime(0, now + 0.15);
osc.start(now);
osc.stop(now + 0.15);
break;

case 'reset': // ヒュ〜ン
osc.type = 'sawtooth';
osc.frequency.setValueAtTime(300, now);
osc.frequency.exponentialRampToValueAtTime(50, now + 0.3);
gainNode.gain.setValueAtTime(0.1, now);
gainNode.gain.linearRampToValueAtTime(0, now + 0.3);
osc.start(now);
osc.stop(now + 0.3);
break;

case 'load': // ジャジャーン
osc.type = 'square';
osc.frequency.setValueAtTime(220, now);
osc.frequency.setValueAtTime(440, now + 0.1);
osc.frequency.setValueAtTime(880, now + 0.2);
gainNode.gain.setValueAtTime(0.05, now);
gainNode.gain.exponentialRampToValueAtTime(0.001, now + 0.6);
osc.start(now);
osc.stop(now + 0.6);
break;

default:
break;
}
} catch (e) {
console.error("Audio play failed", e);
}
};

// --- Helper: Color Interpolation ---
const getWordColor = (count) => {
const maxCount = 10;
const startColor = { r: 239, g: 68, b: 68 }; // Red
const endColor = { r: 31, g: 41, b: 55 }; // Dark Gray

if (count <= 0) return `rgb(${startColor.r}, ${startColor.g}, ${startColor.b})`; if (count>= maxCount) return
    `rgb(${endColor.r}, ${endColor.g}, ${endColor.b})`;

    const ratio = count / maxCount;
    const r = Math.round(startColor.r + (endColor.r - startColor.r) * ratio);
    const g = Math.round(startColor.g + (endColor.g - startColor.g) * ratio);
    const b = Math.round(startColor.b + (endColor.b - startColor.b) * ratio);

    return `rgb(${r}, ${g}, ${b})`;
    };

    // --- Mock Data ---
    const DEMO_TEXT_EN = `Welcome to the WordGrower Browser. This is a prototype designed to help you learn new
    vocabulary.
    When you see a red word, it means you haven't mastered it yet. Tap the word to increase its count.
    As the count goes up, the color changes from red to black.
    Try long-pressing a word to see the menu. You can translate or reset the counter.
    Effect sounds will guide your progress. Enjoy learning!`;

    const DEMO_TEXT_JP = `WordGrowerブラウザへようこそ。これは新しい単語の学習を支援するために設計されたプロトタイプです。
    赤い単語が表示されたら、それはまだ習得していない単語です。単語をタップしてカウントを増やしてください。
    カウントが増えるにつれて、色は赤から黒へと変化します。
    単語を長押しするとメニューが表示されます。翻訳を確認したり、カウンターをリセットしたりできます。
    効果音があなたの学習を盛り上げます。楽しみながら学びましょう！`;

    const DEMO_TEXT_FI = `Tervetuloa WordGrower-selaimeen. Tämä on prototyyppi, joka on suunniteltu auttamaan sinua
    oppimaan uutta sanastoa.
    Kun näet punaisen sanan, se tarkoittaa, että et ole vielä oppinut sitä. Napauta sanaa lisätäksesi sen laskuria.
    Kun laskuri nousee, väri muuttuu punaisesta mustaksi.
    Kokeile painaa sanaa pitkään nähdäksesi valikon. Voit kääntää tai nollata laskurin.
    Äänitehosteet ohjaavat edistymistäsi. Nauti oppimisesta! (Työmarkkinatori demo)`;

    export default function WordGrowerApp() {
    const [url, setUrl] = useState('');
    const [content, setContent] = useState([]);
    const [dictionary, setDictionary] = useState({});
    const [popup, setPopup] = useState({ visible: false, x: 0, y: 0, word: '' });
    const [isLoading, setIsLoading] = useState(false);
    const [soundEnabled, setSoundEnabled] = useState(true);

    useEffect(() => {
    setDictionary({
    "WordGrower": 10,
    "Browser": 5,
    "the": 10,
    "to": 10,
    "is": 10,
    "Tervetuloa": 5
    });
    processText(DEMO_TEXT_EN);
    }, []);

    const processText = (text, lang = 'ja-JP') => {
    setIsLoading(true);
    const segmenter = new Intl.Segmenter(lang, { granularity: 'word' });
    const segments = Array.from(segmenter.segment(text));

    const words = segments.map(seg => ({
    text: seg.segment,
    isWordLike: seg.isWordLike
    }));

    setTimeout(() => {
    setContent(words);
    setIsLoading(false);
    if(soundEnabled) playSound('load');
    }, 600);
    };

    const handleExtract = (e) => {
    e.preventDefault();
    const lowerUrl = url.toLowerCase();
    if (lowerUrl.includes('jp') || lowerUrl.includes('日本')) {
    processText(DEMO_TEXT_JP, 'ja-JP');
    } else if (lowerUrl.includes('fi') || lowerUrl.includes('suomi')) {
    processText(DEMO_TEXT_FI, 'fi-FI');
    } else {
    processText(DEMO_TEXT_EN, 'en-US');
    }
    };

    const handleWordClick = (word) => {
    if (!word) return;
    setDictionary(prev => {
    const currentCount = prev[word] || 0;
    if (currentCount >= 10) return prev;
    const newCount = currentCount + 1;
    if (soundEnabled) {
    if (newCount === 10) playSound('levelup');
    else playSound('tap');
    }
    return { ...prev, [word]: newCount };
    });
    };

    const handleMaster = () => {
    if (!popup.word) return;
    setDictionary(prev => ({ ...prev, [popup.word]: 10 }));
    if (soundEnabled) playSound('levelup');
    setPopup({ ...popup, visible: false });
    };

    const handleReset = () => {
    if (!popup.word) return;
    setDictionary(prev => ({ ...prev, [popup.word]: 0 }));
    if (soundEnabled) playSound('reset');
    setPopup({ ...popup, visible: false });
    };

    const exportDictionary = () => {
    const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(dictionary, null, 2));
    const downloadAnchorNode = document.createElement('a');
    downloadAnchorNode.setAttribute("href", dataStr);
    downloadAnchorNode.setAttribute("download", "my_word_dictionary.json");
    document.body.appendChild(downloadAnchorNode);
    downloadAnchorNode.click();
    downloadAnchorNode.remove();
    };

    // --- 長押し判定ロジック ---
    const longPressTimer = useRef(null);
    const isLongPress = useRef(false);

    const startPress = (e, word) => {
    isLongPress.current = false;
    longPressTimer.current = setTimeout(() => {
    isLongPress.current = true;

    // Haptic Feedback (Mobile)
    if (navigator.vibrate) navigator.vibrate(50);

    let clientX, clientY;
    if (e.touches) {
    clientX = e.touches[0].clientX;
    clientY = e.touches[0].clientY;
    } else {
    clientX = e.clientX;
    clientY = e.clientY;
    }

    setPopup({
    visible: true,
    x: clientX,
    y: clientY,
    word: word
    });
    if (soundEnabled) playSound('menu');
    }, 600);
    };

    const endPress = (e, word) => {
    clearTimeout(longPressTimer.current);
    if (!isLongPress.current) {
    handleWordClick(word);
    }
    // 長押し時は何もしない（メニュー表示済み）
    };

    // メニューの外側クリック判定
    useEffect(() => {
    if (!popup.visible) return;

    const handleClickOutside = () => setPopup(p => ({ ...p, visible: false }));

    // 【重要】長押し終了時の「指を離す動作(click)」を無視するため、
    // リスナーの登録をわずかに遅らせる。これでメニューが即閉じしなくなる。
    const timer = setTimeout(() => {
    window.addEventListener('click', handleClickOutside);
    }, 100);

    return () => {
    clearTimeout(timer);
    window.removeEventListener('click', handleClickOutside);
    };
    }, [popup.visible]);

    return (
    <div className="flex flex-col h-screen bg-gray-50 text-gray-800 font-sans">
        {/* Header */}
        <header className="bg-white shadow-sm p-4 sticky top-0 z-10">
            <div className="max-w-4xl mx-auto flex gap-2 items-center">
                <div className="flex-1 flex items-center bg-gray-100 rounded-lg px-3 py-2">
                    <BookOpen className="w-5 h-5 text-gray-400 mr-2" />
                    <input type="text" placeholder="URLを入力 (.fi でフィンランド語)"
                        className="bg-transparent border-none outline-none w-full text-sm" value={url} onChange={(e)=>
                    setUrl(e.target.value)}
                    />
                </div>
                <button onClick={handleExtract}
                    className="bg-blue-600 text-white p-2 rounded-lg hover:bg-blue-700 active:scale-95 transition">
                    <Search className="w-5 h-5" />
                </button>

                <div className="w-px h-6 bg-gray-300 mx-1"></div>

                <button onClick={()=> setSoundEnabled(!soundEnabled)}
                    className={`p-2 rounded-lg transition ${soundEnabled ? 'text-blue-600 bg-blue-50' :
                    'text-gray-400'}`}
                    >
                    {soundEnabled ?
                    <Volume2 className="w-5 h-5" /> :
                    <VolumeX className="w-5 h-5" />}
                </button>

                <button onClick={exportDictionary} className="p-2 rounded-lg text-gray-600 hover:bg-gray-100"
                    title="辞書をJSONで保存">
                    <Download className="w-5 h-5" />
                </button>
            </div>
        </header>

        {/* Main Content */}
        <main className="flex-1 overflow-y-auto p-4 md:p-8">
            <div
                className="max-w-3xl mx-auto bg-white min-h-[500px] shadow-sm rounded-xl p-6 md:p-10 leading-relaxed text-lg relative">

                {isLoading && (
                <div className="absolute inset-0 bg-white/80 flex flex-col items-center justify-center z-10 rounded-xl">
                    <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mb-4"></div>
                    <p className="text-gray-500 font-medium">テキスト抽出中...</p>
                </div>
                )}

                <div className="text-justify break-words">
                    {content.length > 0 ? content.map((item, index) => {
                    if (!item.isWordLike) return <span key={index}>{item.text}</span>;

                    const count = dictionary[item.text] || 0;
                    const color = getWordColor(count);
                    const isMastered = count >= 10;

                    return (
                    <span key={index} className={` inline-block cursor-pointer select-none transition-colors
                        duration-300 rounded px-0.5 mx-0.5 ${isMastered ? '' : 'font-medium' } active:bg-gray-100 `}
                        style={{ color: color }} onMouseDown={(e)=> startPress(e, item.text)}
                        onMouseUp={(e) => endPress(e, item.text)}
                        onMouseLeave={() => clearTimeout(longPressTimer.current)}

                        onTouchStart={(e) => startPress(e, item.text)}
                        onTouchEnd={(e) => {
                        e.preventDefault();
                        endPress(e, item.text);
                        }}

                        onContextMenu={(e) => e.preventDefault()}
                        >
                        {item.text}
                    </span>
                    );
                    }) : (
                    <div className="text-center text-gray-400 mt-20">
                        <p>URLを入力してボタンを押してください。</p>
                    </div>
                    )}
                </div>
            </div>
        </main>

        {/* Popup Menu */}
        {popup.visible && (
        <div className="fixed z-50 bg-white rounded-lg shadow-xl border border-gray-200 w-64 overflow-hidden animate-in fade-in zoom-in-95 duration-200"
            style={{ top: Math.min(popup.y + 10, window.innerHeight - 250), left: Math.min(popup.x - 100,
            window.innerWidth - 260)> 0 ? Math.min(popup.x - 100, window.innerWidth - 260) : 10
            }}
            onClick={(e) => e.stopPropagation()}
            >
            <div className="bg-gray-50 px-4 py-2 border-b flex justify-between items-center">
                <span className="font-bold text-gray-700 truncate max-w-[120px]">{popup.word}</span>
                <span className="text-xs bg-gray-200 px-2 py-0.5 rounded-full text-gray-600">
                    Lv. {dictionary[popup.word] || 0}
                </span>
            </div>

            <div className="p-2 space-y-2">
                <div className="text-sm text-gray-500 flex items-center mb-1">
                    <Languages className="w-4 h-4 mr-1" /> 翻訳
                </div>
                <div className="grid grid-cols-[auto,1fr] gap-x-3 gap-y-1 text-sm bg-gray-50 p-2 rounded mb-2">
                    <span className="text-gray-400 text-xs">JP:</span>
                    <span className="text-gray-800 text-xs">
                        {popup.word === 'WordGrower' ? '単語育成' : 'サンプル翻訳'}
                    </span>
                </div>

                <button onClick={handleMaster}
                    className="w-full flex items-center justify-center gap-2 p-2 bg-green-50 text-green-700 hover:bg-green-100 rounded-md transition text-sm font-bold border border-green-200">
                    <Check className="w-4 h-4" />
                    Mastered!
                </button>

                <button onClick={handleReset}
                    className="w-full flex items-center justify-center gap-2 p-2 text-gray-500 hover:bg-gray-100 hover:text-red-600 rounded-md transition text-xs border border-transparent hover:border-red-100">
                    <RefreshCw className="w-3 h-3" />
                    リセット
                </button>
            </div>

            <button onClick={()=> setPopup({ ...popup, visible: false })}
                className="absolute top-2 right-2 text-gray-400 hover:text-gray-600"
                >
                <X className="w-4 h-4" />
            </button>
        </div>
        )}
    </div>
    );
    }