<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>光の熱ラボ - シミュレーター</title>
    <!-- React本体のみを読み込み -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes spin-slow { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .animate-spin-slow { animation: spin-slow 8s linear infinite; }
        input[type="range"] { accent-color: #f97316; }
    </style>
</head>
<body class="bg-slate-900">
    <div id="root">
        <div style="display: flex; justify-content: center; align-items: center; height: 100vh; color: white; font-family: sans-serif;">
            <p style="font-size: 20px;">プログラムを起動中...</p>
        </div>
    </div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- アイコンをSVGで自作（外部エラーを防ぐため） ---
        const IconSun = () => (
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m6.34 17.66-1.41 1.41"/><path d="m19.07 4.93-1.41 1.41"/></svg>
        );
        const IconInfo = () => (
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg>
        );
        const IconSearch = () => (
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
        );

        // --- 音声処理 ---
        let audioCtx = null;
        const playTone = (freq, type = 'sine', vol = 0.05) => {
            if (!audioCtx) return;
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = type;
            osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
            gain.gain.setValueAtTime(vol, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.1);
            osc.connect(gain); gain.connect(audioCtx.destination);
            osc.start(); osc.stop(audioCtx.currentTime + 0.1);
        };

        function App() {
            const [started, setStarted] = useState(false);
            const [intensity, setIntensity] = useState(50);
            const [frequency, setFrequency] = useState(50);
            const [albedo, setAlbedo] = useState(50);
            const canvasRef = useRef(null);
            const sharedState = useRef({ hitEnergy: 0, temp: 0 });

            useEffect(() => {
                if (!started) return;
                const canvas = canvasRef.current;
                const ctx = canvas.getContext('2d');
                let animationFrameId;
                let particles = [];

                const render = () => {
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    const { width, height } = canvas;

                    // 1. 太陽
                    const sunX = 80, sunY = 80;
                    const sunRadius = 40 + intensity / 4;
                    const gradient = ctx.createRadialGradient(sunX, sunY, 5, sunX, sunY, sunRadius);
                    gradient.addColorStop(0, '#fffbe6');
                    gradient.addColorStop(1, `rgba(255, 165, 0, ${intensity/100})`);
                    ctx.fillStyle = gradient;
                    ctx.beginPath(); ctx.arc(sunX, sunY, sunRadius, 0, Math.PI * 2); ctx.fill();

                    // 2. 服
                    const clothX = width - 220, clothY = height - 120;
                    const clothW = 180, clothH = 80;
                    const brightness = albedo * 2.55;
                    const heatRed = Math.min(60, sharedState.current.temp * 2);
                    ctx.fillStyle = `rgb(${brightness + heatRed}, ${brightness}, ${brightness})`;
                    ctx.fillRect(clothX, clothY, clothW, clothH);
                    ctx.strokeStyle = '#94a3b8';
                    ctx.lineWidth = 2;
                    ctx.strokeRect(clothX, clothY, clothW, clothH);

                    // 3. ミクロ視点 (虫眼鏡)
                    const zoomX = width - 130, zoomY = height - 220, zoomR = 60;
                    ctx.save();
                    ctx.beginPath(); ctx.arc(zoomX, zoomY, zoomR, 0, Math.PI * 2); ctx.clip();
                    ctx.fillStyle = '#0f172a';
                    ctx.fillRect(zoomX - zoomR, zoomY - zoomR, zoomR * 2, zoomR * 2);
                    for(let i=0; i<3; i++) {
                        const jitter = (Math.random() - 0.5) * (sharedState.current.hitEnergy + 2);
                        ctx.fillStyle = `rgb(${100 + sharedState.current.hitEnergy * 8}, 150, 255)`;
                        ctx.beginPath(); ctx.arc(zoomX - 30 + i * 30 + jitter, zoomY + jitter, 12, 0, Math.PI*2); ctx.fill();
                    }
                    ctx.restore();
                    ctx.strokeStyle = '#475569'; ctx.lineWidth = 4;
                    ctx.beginPath(); ctx.arc(zoomX, zoomY, zoomR, 0, Math.PI*2); ctx.stroke();
                    ctx.fillStyle = '#64748b'; ctx.font = 'bold 10px sans-serif';
                    ctx.fillText("表面の原子", zoomX - 25, zoomY + zoomR + 15);

                    // 4. 光子
                    if (Math.random() < intensity / 150) {
                        particles.push({ 
                            x: sunX, y: sunY, 
                            vx: (clothX + 90 - sunX) / 70, 
                            vy: (clothY - sunY) / 70, 
                            life: 100, reflected: false 
                        });
                    }
                    const hue = 280 - (frequency * 2.8);
                    ctx.lineWidth = 2;
                    for (let i = particles.length - 1; i >= 0; i--) {
                        let p = particles[i]; p.x += p.vx; p.y += p.vy;
                        ctx.strokeStyle = `hsla(${hue}, 100%, 60%, ${p.life/100})`;
                        ctx.beginPath();
                        for(let j=0; j<10; j++) {
                            const sine = Math.sin((p.x + p.y + j*2) * (frequency/15));
                            ctx.lineTo(p.x - p.vx*j*2 + sine*4, p.y - p.vy*j*2);
                        }
                        ctx.stroke();
                        
                        if (!p.reflected && p.y > clothY && p.x > clothX && p.x < clothX + clothW) {
                            if (Math.random() * 100 < albedo) {
                                p.vy *= -1; p.vx *= 1.2; p.reflected = true;
                                if(Math.random() < 0.05) playTone(400 + frequency * 2, 'sine', 0.02);
                            } else {
                                sharedState.current.hitEnergy += (frequency / 8);
                                sharedState.current.temp += (frequency / 40);
                                if(Math.random() < 0.05) playTone(100 + frequency, 'sawtooth', 0.01);
                                particles.splice(i, 1); continue;
                            }
                        }
                        if (p.y < 0 || p.y > height || p.x > width) particles.splice(i, 1);
                    }
                    sharedState.current.hitEnergy *= 0.85;
                    if(sharedState.current.temp > 0) sharedState.current.temp -= 0.05;
                    animationFrameId = window.requestAnimationFrame(render);
                };
                render();
                return () => window.cancelAnimationFrame(animationFrameId);
            }, [started, intensity, frequency, albedo]);

            const handleStart = () => {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                setStarted(true);
            };

            if (!started) {
                return (
                    <div className="min-h-screen bg-slate-900 flex items-center justify-center p-4">
                        <div className="max-w-md w-full bg-white rounded-3xl shadow-2xl p-10 text-center">
                            <div className="text-orange-500 flex justify-center mb-6">
                                <div className="animate-spin-slow"><IconSun /></div>
                            </div>
                            <h1 className="text-3xl font-black text-slate-800 mb-4">光の熱ラボ</h1>
                            <p className="text-slate-600 mb-10">なぜ光には重さがないのに、<br/>太陽の光を浴びると温かいの？</p>
                            <button onClick={handleStart} className="w-full bg-orange-500 hover:bg-orange-600 text-white font-bold py-5 rounded-2xl shadow-lg transition-transform hover:scale-105 active:scale-95 text-lg">
                                実験をスタート
                            </button>
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen bg-slate-100 p-4 sm:p-8 font-sans">
                    <div className="max-w-5xl mx-auto space-y-6">
                        <div className="bg-white rounded-3xl shadow-xl border border-slate-200 overflow-hidden relative">
                            <div className="p-5 bg-sky-50 border-b flex justify-between items-center">
                                <h2 className="font-bold text-slate-700 flex items-center gap-2"><IconSearch /> 統合ビュー (日常とミクロ)</h2>
                                <div className="bg-orange-500 text-white px-4 py-1.5 rounded-full text-sm font-bold shadow-sm">
                                    吸収熱: {Math.floor(sharedState.current.temp * 10)} J
                                </div>
                            </div>
                            <div className="relative bg-sky-100 h-[450px]">
                                <canvas ref={canvasRef} width={1000} height={450} className="w-full h-full" />
                                <div className="absolute top-6 left-28 w-56 bg-white/80 backdrop-blur p-4 rounded-2xl shadow-md space-y-4">
                                    <div>
                                        <label className="text-[11px] font-black text-slate-500 uppercase block mb-1.5">太陽の強さ</label>
                                        <input type="range" value={intensity} onChange={(e)=>setIntensity(Number(e.target.value))} className="w-full" />
                                    </div>
                                    <div>
                                        <label className="text-[11px] font-black text-slate-500 uppercase block mb-1.5">光の振動数 (エネルギー)</label>
                                        <input type="range" value={frequency} onChange={(e)=>setFrequency(Number(e.target.value))} className="w-full" />
                                    </div>
                                </div>
                                <div className="absolute bottom-6 right-6 w-56 bg-white/80 backdrop-blur p-4 rounded-2xl shadow-md">
                                    <label className="text-[11px] font-black text-slate-500 uppercase block mb-2">服の明るさ (反射率)</label>
                                    <input type="range" value={albedo} onChange={(e)=>setAlbedo(Number(e.target.value))} className="w-full" />
                                </div>
                            </div>
                        </div>
                        <div className="grid md:grid-cols-2 gap-6">
                            <div className="bg-white p-8 rounded-3xl border shadow-sm">
                                <h3 className="font-black text-xl mb-4 text-green-700">理論：なぜ熱が生まれる？</h3>
                                <div className="bg-slate-900 p-5 rounded-2xl text-white text-center font-serif text-2xl mb-6">E² = (pc)² + (mc²)²</div>
                                <p className="text-sm text-slate-600 leading-relaxed">
                                    光には質量(m)がないため、右の項はゼロ。しかし振動数に比例した「勢い(p)」があります。吸収されるとその勢いが原子を震わせ、それが「熱」になります。
                                </p>
                            </div>
                            <div className="bg-blue-600 text-white p-8 rounded-3xl shadow-xl">
                                <h3 className="font-black text-2xl mb-5 flex items-center gap-3"><IconInfo /> まとめ</h3>
                                <ul className="space-y-4 text-slate-100 text-sm">
                                    <li>・白い服は光を「反射」し、原子はあまり叩かれません。</li>
                                    <li>・黒い服は光を「吸収」し、勢いを原子の振動（熱）に変えます。</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>