<!DOCTYPE html>
<html lang="ja" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Helsinki Street Translator</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS with Config -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        slate: { 850: '#151e2e' }
                    }
                }
            }
        }
    </script>
    
    <!-- Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        html, body, #root { height: 100%; margin: 0; padding: 0; overflow: hidden; }

        .custom-scrollbar::-webkit-scrollbar { width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .dark .custom-scrollbar::-webkit-scrollbar-thumb { background: #475569; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .dark .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #64748b; }
        
        #map { height: 100%; width: 100%; z-index: 0; }
        
        /* Popup Styles */
        .leaflet-popup-content-wrapper, .leaflet-popup-tip {
            background: #ffffff;
            color: #1e293b;
            border: 1px solid #e2e8f0;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
        }
        .dark .leaflet-popup-content-wrapper, .dark .leaflet-popup-tip {
            background: #1e293b;
            color: #e2e8f0;
            border: 1px solid #475569;
            box-shadow: none;
        }
        .leaflet-popup-content { margin: 12px; line-height: 1.6; }
        .leaflet-container a.leaflet-popup-close-button { color: #64748b; }
        .dark .leaflet-container a.leaflet-popup-close-button { color: #94a3b8; }
    </style>
</head>
<body class="bg-gray-50 dark:bg-slate-900 text-slate-800 dark:text-slate-200 font-sans transition-colors duration-300">

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // --- Audio Logic ---
        const playSound = (type) => {
            const AudioContext = window.AudioContext || window.webkitAudioContext;
            if (!AudioContext) return;
            const ctx = new AudioContext();
            const osc = ctx.createOscillator();
            const gainNode = ctx.createGain();
            osc.connect(gainNode);
            gainNode.connect(ctx.destination);
            const now = ctx.currentTime;

            if (type === 'select') {
                osc.type = 'sine'; osc.frequency.setValueAtTime(800, now); osc.frequency.exponentialRampToValueAtTime(1200, now + 0.05);
                gainNode.gain.setValueAtTime(0.05, now); gainNode.gain.exponentialRampToValueAtTime(0.001, now + 0.1);
                osc.start(now); osc.stop(now + 0.1);
            } else if (type === 'sort') {
                osc.type = 'sawtooth'; osc.frequency.setValueAtTime(150, now); osc.frequency.linearRampToValueAtTime(300, now + 0.15);
                gainNode.gain.setValueAtTime(0.02, now); gainNode.gain.linearRampToValueAtTime(0, now + 0.15);
                const filter = ctx.createBiquadFilter(); filter.type = "lowpass"; filter.frequency.value = 1000;
                osc.disconnect(); osc.connect(filter); filter.connect(gainNode);
                osc.start(now); osc.stop(now + 0.15);
            } else if (type === 'highlight') {
                osc.type = 'triangle'; osc.frequency.setValueAtTime(220, now); osc.frequency.exponentialRampToValueAtTime(440, now + 0.2);
                gainNode.gain.setValueAtTime(0.05, now); gainNode.gain.linearRampToValueAtTime(0, now + 0.3);
                osc.start(now); osc.stop(now + 0.3);
            } else if (type === 'toggle') {
                osc.type = 'sine'; osc.frequency.setValueAtTime(400, now);
                gainNode.gain.setValueAtTime(0.05, now); gainNode.gain.exponentialRampToValueAtTime(0.001, now + 0.05);
                osc.start(now); osc.stop(now + 0.05);
            }
        };

        const SortIcon = ({ active, direction }) => {
            if (!active) return <span className="text-slate-400 ml-1">â†•</span>;
            return direction === 'asc' ? <span className="text-blue-500 ml-1">â†‘</span> : <span className="text-blue-500 ml-1">â†“</span>;
        };

        const App = () => {
            const [streetData, setStreetData] = useState([]);
            const [selectedId, setSelectedId] = useState(null);
            const [sortConfig, setSortConfig] = useState({ key: 'fi', direction: 'asc' });
            
            // Dark Mode State
            const [isDarkMode, setIsDarkMode] = useState(() => {
                const saved = localStorage.getItem('theme');
                return saved ? saved === 'dark' : true;
            });

            const mapRef = useRef(null);
            const tileLayerRef = useRef(null);
            const layersRef = useRef({});

            // Toggle Theme
            const toggleTheme = () => {
                playSound('toggle');
                const newMode = !isDarkMode;
                setIsDarkMode(newMode);
                localStorage.setItem('theme', newMode ? 'dark' : 'light');
            };

            // Apply Theme to HTML
            useEffect(() => {
                if (isDarkMode) {
                    document.documentElement.classList.add('dark');
                } else {
                    document.documentElement.classList.remove('dark');
                }
            }, [isDarkMode]);

            // Load Data
            useEffect(() => {
                // metadata ã¨ geometry ã®2ã¤ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’åŒæ™‚ã«èª­ã¿è¾¼ã‚€
                Promise.all([
                    fetch('./streets_metadata.json').then(res => res.json()),
                    fetch('./streets_geometry.json').then(res => res.json())
                ])
                .then(([metadata, geometry]) => {
                    // IDã‚’ã‚­ãƒ¼ã«ã—ã¦åˆä½“
                    const mergedData = metadata.map(item => ({
                        ...item,
                        path: geometry[item.id] || [] // geometryãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰åº§æ¨™ã‚’å¼•ã£å¼µã‚‹
                    }));
                    setStreetData(mergedData);
                })
                .catch(e => console.error("ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:", e));
            }, []);

            // Initialize Map
            useEffect(() => {
                if (!mapRef.current) {
                    mapRef.current = L.map('map', {
                        center: [60.1699, 24.9384],
                        zoom: 14,
                        zoomControl: false,
                        attributionControl: false 
                    });
                    
                    // Add Tile Layer
                    tileLayerRef.current = L.tileLayer('', {
                        attribution: '&copy; CARTO', subdomains: 'abcd', maxZoom: 20
                    }).addTo(mapRef.current);
                    
                    L.control.zoom({ position: 'bottomright' }).addTo(mapRef.current);

                    // â˜…é‡è¦: åœ°å›³ã®è¡¨ç¤ºã‚ºãƒ¬ã‚’ç›´ã™ãŸã‚ã€åˆæœŸåŒ–å¾Œã«ã‚µã‚¤ã‚ºã‚’å†è¨ˆç®—ã•ã›ã‚‹
                    setTimeout(() => {
                        mapRef.current.invalidateSize();
                    }, 200);
                }
            }, []);

            // Update Map Tiles
            useEffect(() => {
                if (tileLayerRef.current) {
                    const url = isDarkMode 
                        ? 'https://{s}.basemaps.cartocdn.com/rastertiles/dark_all/{z}/{x}/{y}{r}.png'
                        : 'https://{s}.basemaps.cartocdn.com/rastertiles/light_all/{z}/{x}/{y}{r}.png';
                    tileLayerRef.current.setUrl(url);
                }
            }, [isDarkMode]);

            // Render Layers
            useEffect(() => {
                if (!mapRef.current || streetData.length === 0) return;

                Object.values(layersRef.current).forEach(l => l.remove());
                layersRef.current = {};

                streetData.forEach(street => {
                    const baseColor = isDarkMode ? '#64748b' : '#94a3b8';

                    const polyline = L.polyline(street.path, {
                        color: baseColor, weight: 4, opacity: 0.7, className: 'transition-all duration-300'
                    }).addTo(mapRef.current);
                    
                    const clickArea = L.polyline(street.path, {
                        color: 'transparent', weight: 25, opacity: 0
                    }).addTo(mapRef.current);

                    const popupContent = `
                        <div class="font-sans">
                            <h3 class="text-lg font-bold mb-1 border-b border-gray-200 dark:border-slate-600 pb-1">${street.fi}</h3>
                            <p class="text-sm text-slate-600 dark:text-blue-300 mb-2">${street.en} / ${street.ja}</p>
                            <p class="text-xs bg-gray-100 dark:bg-slate-800 p-2 rounded text-slate-700 dark:text-slate-300">
                                <span class="mr-1">ðŸ’¡</span>${street.desc}
                            </p>
                        </div>
                    `;
                    
                    [polyline, clickArea].forEach(layer => {
                        layer.bindPopup(popupContent, { closeButton: false, autoPan: true });
                        layer.on('click', () => { handleMapClick(street.id); layer.openPopup(); });
                        if (layer === polyline) layersRef.current[street.id] = polyline;
                    });
                });
            }, [streetData]);

            // Handle Selection Style
            useEffect(() => {
                streetData.forEach(street => {
                    const layer = layersRef.current[street.id];
                    if (layer) {
                        if (street.id === selectedId) {
                            layer.setStyle({ color: "#3b82f6", weight: 6, opacity: 1 });
                            layer.bringToFront();
                            const bounds = layer.getBounds();
                            mapRef.current.fitBounds(bounds, { padding: [100, 100], maxZoom: 16, animate: true });
                            layer.openPopup();
                        } else {
                            const baseColor = isDarkMode ? '#64748b' : '#94a3b8';
                            layer.setStyle({ color: baseColor, weight: 4, opacity: 0.7 });
                            layer.closePopup();
                        }
                    }
                });
            }, [selectedId, streetData, isDarkMode]);

            const handleMapClick = (id) => {
                playSound('highlight');
                setSelectedId(id);
                const el = document.getElementById(`row-${id}`);
                if (el) el.scrollIntoView({ behavior: 'smooth', block: 'center' });
            };
            const handleListClick = (id) => {
                playSound('select');
                setSelectedId(id);
            };
            const handleSort = (key) => {
                playSound('sort');
                setSortConfig(prev => ({ key, direction: prev.key === key && prev.direction === 'asc' ? 'desc' : 'asc' }));
            };

            const sortedData = useMemo(() => {
                return [...streetData].sort((a, b) => {
                    if (a[sortConfig.key] < b[sortConfig.key]) return sortConfig.direction === 'asc' ? -1 : 1;
                    if (a[sortConfig.key] > b[sortConfig.key]) return sortConfig.direction === 'asc' ? 1 : -1;
                    return 0;
                });
            }, [streetData, sortConfig]);

            return (
                <div className="flex flex-col h-full bg-gray-50 dark:bg-slate-900 transition-colors duration-300">
                    
                    {/* Header */}
                    <header className="flex-none bg-white dark:bg-slate-800 border-b border-gray-200 dark:border-slate-700 p-4 flex justify-between items-center shadow-sm z-20 h-16 transition-colors duration-300">
                        <div className="flex items-center gap-3">
                            <div className="w-8 h-8 bg-blue-600 rounded flex items-center justify-center text-white font-bold shadow-lg shadow-blue-500/30">Fi</div>
                            <h1 className="text-xl font-bold text-slate-800 dark:text-slate-100">Helsinki Street Lingo</h1>
                        </div>
                        
                        {/* Custom Toggle Switch (Pill Shape) */}
                        <div className="flex items-center gap-3">
                            <span className="text-xs text-slate-500 dark:text-slate-400 font-medium hidden sm:block">
                                {isDarkMode ? 'DARK' : 'LIGHT'}
                            </span>
                            <div 
                                onClick={toggleTheme}
                                className={`
                                    w-14 h-7 flex items-center rounded-full p-1 cursor-pointer transition-colors duration-300
                                    ${isDarkMode ? 'bg-slate-600' : 'bg-gray-300'}
                                `}
                            >
                                {/* Switch Knob */}
                                <div 
                                    className={`
                                        bg-white w-5 h-5 rounded-full shadow-md transform transition-transform duration-300 ease-in-out
                                        ${isDarkMode ? 'translate-x-7' : 'translate-x-0'}
                                    `}
                                ></div>
                            </div>
                        </div>
                    </header>

                    {/* Main Content */}
                    <div className="flex-1 flex flex-col md:flex-row min-h-0 relative">
                        {/* Map Area */}
                        <div className="w-full h-1/2 md:h-full md:w-3/5 relative z-0 bg-gray-200 dark:bg-slate-900">
                            <div id="map"></div>
                        </div>

                        {/* List Area */}
                        <div className="w-full h-1/2 md:h-full md:w-2/5 flex flex-col bg-white dark:bg-slate-800 z-10 border-t border-gray-200 dark:border-slate-700 md:border-t-0 md:border-l shadow-2xl transition-colors duration-300">
                            {/* Table Header */}
                            <div className="flex-none grid grid-cols-3 bg-gray-50 dark:bg-slate-800 border-b border-gray-200 dark:border-slate-700 font-semibold text-sm text-slate-500 dark:text-slate-400">
                                <div onClick={() => handleSort('fi')} className="p-3 cursor-pointer hover:bg-gray-100 dark:hover:bg-slate-700 flex items-center transition-colors">
                                    Suomi <SortIcon active={sortConfig.key === 'fi'} direction={sortConfig.direction} />
                                </div>
                                <div onClick={() => handleSort('en')} className="p-3 cursor-pointer hover:bg-gray-100 dark:hover:bg-slate-700 flex items-center border-l border-gray-200 dark:border-slate-700 transition-colors">
                                    English <SortIcon active={sortConfig.key === 'en'} direction={sortConfig.direction} />
                                </div>
                                <div onClick={() => handleSort('ja')} className="p-3 cursor-pointer hover:bg-gray-100 dark:hover:bg-slate-700 flex items-center border-l border-gray-200 dark:border-slate-700 transition-colors">
                                    æ—¥æœ¬èªž <SortIcon active={sortConfig.key === 'ja'} direction={sortConfig.direction} />
                                </div>
                            </div>

                            {/* List Content */}
                            <div className="flex-1 overflow-y-auto custom-scrollbar">
                                {sortedData.map((street) => (
                                    <div 
                                        key={street.id}
                                        id={`row-${street.id}`}
                                        onClick={() => handleListClick(street.id)}
                                        className={`
                                            grid grid-cols-3 text-sm border-b border-gray-100 dark:border-slate-700 cursor-pointer transition-all duration-200
                                            ${selectedId === street.id 
                                                ? 'bg-blue-50 dark:bg-blue-900/30 border-l-4 border-l-blue-500' 
                                                : 'hover:bg-gray-50 dark:hover:bg-slate-700 border-l-4 border-l-transparent'}
                                        `}
                                    >
                                        <div className="p-3 font-bold text-slate-700 dark:text-slate-200">{street.fi}</div>
                                        <div className="p-3 text-slate-500 dark:text-slate-400 border-l border-dashed border-gray-200 dark:border-slate-700/50">{street.en}</div>
                                        <div className="p-3 text-slate-500 dark:text-slate-400 border-l border-dashed border-gray-200 dark:border-slate-700/50">{street.ja}</div>
                                    </div>
                                ))}
                                {sortedData.length === 0 && (
                                    <div className="p-8 text-center text-slate-400 dark:text-slate-500">
                                        Loading data...
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>