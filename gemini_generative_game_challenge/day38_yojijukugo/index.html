<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YoJiJuku GO! / 四字熟GO!</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@700;900&family=Orbitron:wght@500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --gate-color: #1a1a1a;
            --gate-border: #d4af37;
            --bg-color: #050505;
            --neon: #00ffcc;
            --red-seal: #c41e3a;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; user-select: none; }

        body {
            background-color: var(--bg-color);
            color: #fff;
            font-family: 'Noto Serif JP', serif;
            overflow: hidden;
            height: 100vh;
            width: 100vw;
            perspective: 1200px;
        }

        /* --- UI & Footer --- */
        #shared-footer, shared-footer { position: fixed !important; bottom: 0; width: 100%; z-index: 3000; background: rgba(0,0,0,0.8); pointer-events: auto; }
        #ui-layer { position: fixed; top: 0; width: 100%; padding: 20px; display: flex; justify-content: space-between; z-index: 1000; pointer-events: none; }

        .hud-text { 
            font-family: 'Orbitron', sans-serif; 
            font-size: 1.2rem; /* 少し小さく */
            text-shadow: 0 0 10px var(--neon); 
            color: var(--neon);
            letter-spacing: 0.1em;
        }

        /* --- 3D Scene --- */
        #world {
            position: absolute;
            width: 100%; height: 100%;
            transform-style: preserve-3d;
            transition: transform 1.2s cubic-bezier(0.45, 0.05, 0.55, 0.95);
            pointer-events: none;
        }

        .gate-wrapper {
            position: absolute;
            
            top: 60% !important; /* ★ここに !important を追加 */
            
            left: 50%;
            width: 800px; height: 600px;
            margin: -300px 0 0 -400px;
            transform-style: preserve-3d;
            display: flex; justify-content: center;
        }

        /* --- 扉の演出（左右高速スライド） --- */
        .gate-door {
            position: absolute; width: 50%; height: 100%;
            background: var(--gate-color);
            border: 4px solid var(--gate-border);
            box-shadow: inset 0 0 50px #000;
            display: grid; grid-template: repeat(6, 1fr) / 1fr 1fr;
            padding: 15px; gap: 10px;
            transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.6s;
            z-index: 5;
        }
        .gate-left { left: 0; border-radius: 8px 0 0 8px; }
        .gate-right { right: 0; border-radius: 0 8px 8px 0; }

        .gate-wrapper.open .gate-left { transform: translateX(-1200px); opacity: 0; }
        .gate-wrapper.open .gate-right { transform: translateX(1200px); opacity: 0; }

        /* --- 問題プレート --- */
        .question-plate {
            position: absolute; 
            /* ★扉と被らないよう、さらに上に配置 (Padding/余白を確保) */
            top: -200px; 
            width: 100%;
            text-align: center; background: rgba(0,0,0,0.85);
            border: 2px solid var(--gate-border); padding: 20px;
            border-radius: 8px; z-index: 10;
            box-shadow: 0 0 30px rgba(0,0,0,1);
        }
        .jp-meaning { font-size: 1.8rem; margin-bottom: 5px; font-weight: 900; }
        .jp-reading { font-size: 1.1rem; color: #ddd; margin-bottom: 12px; }
        .en-box { 
            border-top: 1px solid #555; 
            padding-top: 12px; 
            color: var(--gate-border); 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            font-size: 0.95rem; 
            font-style: italic;
            line-height: 1.4;
        }

        .gate-wrapper.open .question-plate { display: none; }

        /* ボタン */
        .door-btn {
            background: #000; border: 1px solid #555; color: #e0e0e0;
            font-size: 1.2rem; cursor: pointer;
            display: flex; justify-content: center; align-items: center;
            box-shadow: 0 4px 0 #222;
            pointer-events: auto !important;
            transform: translateZ(5px); transition: all 0.2s;
        }
        .door-btn:hover { color: var(--gate-border); border-color: var(--gate-border); transform: translateZ(15px); }
        .door-btn.wrong-shake { animation: shake 0.4s; background: #500; }

        @keyframes shake { 
            0%, 100% { transform: translateZ(5px) translateX(0); }
            25% { transform: translateZ(5px) translateX(-5px); }
            75% { transform: translateZ(5px) translateX(5px); }
        }

        /* --- Overlays --- */
        .overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.95);
            z-index: 2000; display: flex; flex-direction: column;
            justify-content: center; align-items: center; backdrop-filter: blur(5px);
        }
        .hidden { display: none !important; }
        h1 { font-size: 4rem; margin-bottom: 1rem; color: var(--gate-border); text-shadow: 0 0 20px rgba(212,175,55,0.5); }
        .btn-primary { padding: 15px 40px; font-size: 1.5rem; background: var(--red-seal); color: #fff; border: 2px solid var(--gate-border); cursor: pointer; margin-top: 20px; font-weight: bold; border-radius: 4px; }

        /* デバッグ用 */
        #internal-debugger { 
            position: fixed; top: 120px; right: 10px; 
            color: #0f0; background: rgba(0,0,0,0.7); 
            padding: 10px; font-family: monospace; 
            
            /* ★修正：iPad枠(5000)より手前に表示する */
            z-index: 6000; 
            
            pointer-events: none; display: none; 
        }


        /* 扉の横の飾り（イラスト代わり） */
        .zodiac-deco {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            font-size: 80px;
            font-weight: 900;
            color: var(--gate-border);
            text-shadow: 0 0 30px var(--gate-border);
            opacity: 0.4;
            pointer-events: none;
            z-index: 1;
            font-family: 'Noto Serif JP', serif;

            
            /* ★最重要：絶対にクリックを邪魔させない */
            pointer-events: none !important; 
        }
        .deco-left { left: -120px; }
        .deco-right { right: -120px; }

        /* iPad / タブレット用の調整 */

        /* ★iPad用の修正：中身をまとめて縮小する箱の設定 */
        .gate-scaler {
            position: relative;
            width: 800px; height: 600px;
            transform-style: preserve-3d;
            display: flex; justify-content: center;
        }

        /* ★修正：画面が狭い時 OR デバッグモード(Alt+D)の時に適用する */
        /* iPad / タブレット / デバッグモード用の調整 */
        @media (max-width: 1024px), body.debug-mode {
            
            /* 1. 指定の 58% に設定 */
            .gate-wrapper {
                top: 58%; 
            }

            /* 縮小率はそのまま */
            .gate-scaler {
                transform: scale(0.65);
            }

            /* 2. 指定の -200px に設定
               4. 幅を扉（100%）に合わせてピッタリにする */
            .question-plate {
                top: -200px;
                width: 100%; /* 120%から100%に戻して扉幅に合わせる */
                left: 0;     /* 中心ズレを直す */
            }

            .zodiac-deco {
                font-size: 80px;
            }
            
            /* 3. 青い文字（HUD）が枠に入りきるように余白を広げる */
            #ui-layer {
                padding: 60px 50px; /* 余白を増やして、文字を内側に押し込む */
            }
        }


        /* --- iPadシミュレーターの枠設定 --- */
        #ipad-frame {
            position: fixed;
            top: 50%; left: 50%;
            width: 834px; height: 1194px; /* iPad Pro 11" 縦サイズ */
            transform: translate(-50%, -50%) scale(0.6); /* PCで見れるサイズに縮小 */

            /* ★修正：背景を透明にする（重要！） */
            background: transparent;

            border: 20px solid #444;
            border-radius: 30px;
            pointer-events: none;
            z-index: 5000;
            display: none;

            /* 外側を暗くして、iPad画面を際立たせる */
            box-shadow: 0 0 0 100vmax rgba(0, 0, 0, 0.85);
        }

        /* デバッグモード中のみ枠を表示 */
        body.debug-mode #ipad-frame { display: block; }

        /* ★iPad Pro (縦) 用のレイアウト微調整 */
        @media (max-width: 1024px), body.debug-mode {
            .gate-wrapper {
                top: 50%; /* 縦長画面では60%だと下すぎるので50%に戻す */
            }
            .gate-scaler {
                transform: scale(0.65); /* 扉を画面内に収める */
            }
            .question-plate {
                top: -180px; /* プレートの位置を調整 */
            }
        }

    </style>
</head>
<body>
    <div id="ipad-frame"></div> <!-- シミュレーターの箱を追加 -->

    <div id="internal-debugger">Hit: <span id="hit-target">---</span></div>
    <div id="world"></div>

    <div id="ui-layer">
        <div class="hud-text">GATE: <span id="current-q">1</span>/12</div>
        <div class="hud-text" id="timer-display">00:00.000</div>
    </div>

    <div id="start-screen" class="overlay">
        <h1>YoJiJuku GO!</h1>
        <p>一気呵成：十二支の試練を突破せよ</p>
        <p><small style="color:#aaa;">(Complete at a stretch)</small></p>
        <button class="btn-primary" onclick="game.start()">勇往邁進 <small style="color:#ddd;">(Dash forward)</small></button>
    </div>

    <div id="penalty-screen" class="overlay hidden">
        <h2 style="color:var(--red-seal); font-size:3rem; margin-bottom: 10px;">多岐亡羊</h2>

        <p><small style="color:#aaa; font-size:1.5rem;">(At a loss)</small></p>

        <div style="width:100px; height:50px; background:#fff; margin:20px; display:flex; justify-content:center; align-items:center; color:#333; font-weight: bold;">[ 鋭意制作 (WIP)]</div>

        <button class="btn-primary" onclick="game.closePenalty()">改過自新<br><small style="color:#ddd;">(Repent and start anew)</small></button>
    </div>

    <div id="result-screen" class="overlay hidden">
        <h1>完全突破</h1>
        <p style="margin-bottom:10px;">十二支を統べし者</p>
        <div style="font-size: 2rem; font-family: 'Orbitron';">TIME: <span id="final-time" style="color:var(--neon);"></span></div>
        <button class="btn-primary" onclick="location.reload()">心機一転 <small style="color:#ddd;">(A fresh start)</small></button>
    </div>


    <script>
        class Game {
            constructor() {
                this.idioms = [];
                this.questions = [];
                this.currentIndex = 0;
                this.maxQuestions = 12;
                this.startTime = 0;
                this.timerInterval = null;
                this.gateDistance = 1000;
                this.isAnimating = false;
                this.isPenaltyActive = false;

                // 追加：十二支の定義
                this.zodiacs = [
                    {k: "子", e: "Rat"}, {k: "丑", e: "Ox"}, {k: "寅", e: "Tiger"},
                    {k: "卯", e: "Rabbit"}, {k: "辰", e: "Dragon"}, {k: "巳", e: "Snake"},
                    {k: "午", e: "Horse"}, {k: "未", e: "Goat"}, {k: "申", e: "Monkey"},
                    {k: "酉", e: "Rooster"}, {k: "戌", e: "Dog"}, {k: "亥", e: "Boar"}
                ];
            }

            async loadData() {
                const response = await fetch('idioms.json');
                const data = await response.json();
                this.idioms = data.filter(item => item.word.length === 4);
            }

            getPerms(str) {
                if (str.length <= 1) return [str];
                let perms = [];
                for (let i = 0; i < str.length; i++) {
                    let char = str[i];
                    let remaining = str.slice(0, i) + str.slice(i + 1);
                    for (let p of this.getPerms(remaining)) perms.push(char + p);
                }
                return perms;
            }

            shuffle(arr) { return arr.sort(() => Math.random() - 0.5); }

            initQuestions() {
                const pool = this.shuffle([...this.idioms]);
                this.questions = pool.slice(0, this.maxQuestions).map(target => ({
                    target,
                    buttons: this.shuffle(this.getPerms(target.word))
                }));
            }

            start() {
                this.initQuestions();
                document.getElementById('start-screen').classList.add('hidden');
                document.getElementById('world').innerHTML = '';
                this.currentIndex = 0;
                this.renderGate(0);
                this.updateActive();
                document.getElementById('world').style.transform = `translateZ(100px)`;
                this.startTime = performance.now();
                this.timerInterval = requestAnimationFrame(this.updateTimer.bind(this));
            }

            renderGate(idx) {
                if (idx >= this.maxQuestions || document.getElementById(`gate-${idx}`)) return;
                const q = this.questions[idx];
                const z = this.zodiacs[idx]; 
                const gate = document.createElement('div');
                gate.className = 'gate-wrapper';
                gate.id = `gate-${idx}`;
                gate.style.transform = `translateZ(-${idx * this.gateDistance}px)`;

                const btnHtml = (start, end) => q.buttons.slice(start, end).map(word => 
                    `<button class="door-btn" onmousedown="game.check('${word}',this)">${word}</button>`).join('');

                const enMeaning = q.target.meaning_en || "[ English Meaning ]";
                const enReading = q.target.reading_en || "[ English Pronunciation ]";

                gate.innerHTML = `

                    <div class="gate-scaler"> <!-- ★この箱で包む -->
                        <div class="question-plate" style="pointer-events: none;">

                            <!-- ここを z.kanji から z.k に修正（データと合わせるため） -->
                            <div style="position:absolute; top:10px; left:15px; font-size:2.5rem; opacity:0.1; color:var(--gate-border); font-weight:900;">${z.k}</div>
                        
                            <div class="jp-meaning">${q.target.meaning}</div>
                            <div class="jp-reading">(${q.target.reading})</div>
                            <div class="en-box">
                                <div>${enMeaning}</div>
                                <div style="font-size:0.8rem; margin-top:3px;">${enReading}</div>
                            </div>
                        </div>


                        <!-- 文字を扉（gate-door）の中に入れることで、扉と一緒にスライドさせます -->
                        <div class="gate-door gate-left" style="pointer-events: none;">
                            <div class="zodiac-deco deco-left" style="pointer-events: none;">${z.k}</div>
                            ${btnHtml(0, 12)}
                        </div>
                        <div class="gate-door gate-right" style="pointer-events: none;">
                            <div class="zodiac-deco deco-right" style="pointer-events: none;">${z.k}</div>
                            ${btnHtml(12, 24)}
                        </div>
                    </div>`;


                document.getElementById('world').appendChild(gate);
            }

            updateActive() {
                document.querySelectorAll('.gate-wrapper').forEach(el => el.classList.remove('active-gate'));
                document.getElementById(`gate-${this.currentIndex}`)?.classList.add('active-gate');

                // ★ id="current-q" を消さないように HTML を作成する
                const z = this.zodiacs[this.currentIndex];
                const hudElem = document.querySelector('.hud-text:first-child');
                if (z && hudElem) {
                    hudElem.innerHTML = `<span id="current-q">${this.currentIndex + 1}</span>/12 <small>(${z.e})</small> `;
                }
            }

            check(selected, btn) {
                if (this.isAnimating || this.isPenaltyActive) return;
                if (selected === this.questions[this.currentIndex].target.word) {
                    this.next();
                } else {
                    btn.classList.add('wrong-shake');
                    setTimeout(() => {
                        btn.classList.remove('wrong-shake');
                        this.isPenaltyActive = true;
                        document.getElementById('penalty-screen').classList.remove('hidden');
                    }, 400);
                }
            }

            closePenalty() {
                this.isPenaltyActive = false;
                document.getElementById('penalty-screen').classList.add('hidden');
            }

            next() {
                if (this.isAnimating) return;
                this.isAnimating = true;
                
                const current = document.getElementById(`gate-${this.currentIndex}`);
                current.classList.add('open');
                
                setTimeout(() => {
                    this.currentIndex++;
                    if (this.currentIndex < this.maxQuestions) {
                        this.renderGate(this.currentIndex);
                        const nextZ = (this.currentIndex * this.gateDistance) + 100;
                        document.getElementById('world').style.transform = `translateZ(${nextZ}px)`;
                        document.getElementById('current-q').textContent = this.currentIndex + 1;

                        setTimeout(() => {
                            this.isAnimating = false;
                            this.updateActive();
                            setTimeout(() => current.remove(), 1000);
                        }, 1200);
                    } else {
                        this.finish();
                    }
                }, 100);
            }

            updateTimer() {
                if (this.currentIndex >= this.maxQuestions) return;
                const diff = performance.now() - this.startTime;
                const min = Math.floor(diff / 60000).toString().padStart(2,'0');
                const sec = Math.floor((diff % 60000) / 1000).toString().padStart(2,'0');
                const ms = Math.floor(diff % 1000).toString().padStart(3,'0');
                document.getElementById('timer-display').textContent = `${min}:${sec}.${ms}`;
                this.timerInterval = requestAnimationFrame(this.updateTimer.bind(this));
            }

            finish() {
                cancelAnimationFrame(this.timerInterval);
                document.getElementById('final-time').textContent = document.getElementById('timer-display').textContent;
                document.getElementById('result-screen').classList.remove('hidden');
            }

            initDebugger() {
                if (typeof DebugOverlay !== 'undefined') {
                    new DebugOverlay({ target: this, props: ['currentIndex', 'isAnimating', 'worldZ'], title: 'Game Debug' });
                }
                const debugDiv = document.getElementById('internal-debugger');
                const hitSpan = document.getElementById('hit-target');
                document.addEventListener('keydown', e => {
                    if (e.altKey && e.key.toLowerCase() === 'd') {
                        e.preventDefault();


                        // 現在の body が debug-mode かどうかで判定する（確実な方法）
                        const isNowDebug = document.body.classList.contains('debug-mode');
                        const willShow = !isNowDebug;
                        
                        // デバッグ窓の表示切り替え
                        debugDiv.style.display = willShow ? 'block' : 'none';
                        // iPad枠とiPadレイアウトの切り替え
                        document.body.classList.toggle('debug-mode', willShow);

                    }
                });
            }
        }

        const game = new Game();
        window.onload = async () => {
            await game.loadData();
            game.initDebugger();
        };
    </script>


    <script src="https://shared-components-be4c86.gitlab.io/ga.js"></script>
    <script src="https://shared-components-be4c86.gitlab.io/debug-overlay.js"></script>
    <script src="https://shared-components-be4c86.gitlab.io/footer.js"></script>
    <shared-footer version="v20260216.6" project="yojijuku_go"></shared-footer>
</body>
</html>