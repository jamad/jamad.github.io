<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Deep Kanji Fishing - 漢字深海釣り</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background-color: #000;
            font-family: 'Hiragino Mincho ProN', 'Yu Mincho', serif;
            touch-action: none;
            user-select: none;
            -webkit-user-select: none;
        }
        canvas {
            display: block;
        }
        #ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; /* UIレイヤー全体はクリックを透過 */
            display: flex; flex-direction: column; justify-content: space-between;
            z-index: 10;
        }
        #depth-meter {
            position: absolute; top: 20px; right: 20px;
            color: rgba(255, 255, 255, 0.9);
            font-family: monospace; font-size: 24px; text-align: right;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
        }
        #message-area {
            position: absolute; top: 20%; width: 100%; text-align: center;
        }
        .msg-box {
            display: inline-block; background: rgba(0, 0, 0, 0.6); color: #fff;
            padding: 10px 30px; border-radius: 30px; font-size: 20px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
            border: 1px solid rgba(255,255,255,0.3);
            animation: fadeIn 0.3s;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* 結果画面 */
        #result-modal {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 10, 30, 0.95);
            display: none; flex-direction: column; justify-content: center; align-items: center;
            color: white; 
            pointer-events: auto; /* モーダルは操作可能 */
            z-index: 100;
        }
        .fish-card {
            background: #f0f0f0; color: #222; padding: 30px;
            border-radius: 12px; text-align: center; width: 85%; max-width: 380px;
            box-shadow: 0 0 40px rgba(0, 191, 255, 0.2); position: relative;
            border: 4px solid #0277bd;
            user-select: text; -webkit-user-select: text;
        }
        .fish-kanji {
            font-size: 100px; line-height: 1.1; margin: 10px 0;
            color: #004d40; font-family: 'HiraMinProN-W6', 'YuMincho', serif;
            text-shadow: 4px 4px 0px rgba(0,0,0,0.1);
        }
        .fish-reading { font-size: 22px; font-weight: bold; margin-bottom: 5px; }
        .fish-en { font-size: 18px; color: #e65100; font-style: italic; font-family: sans-serif; margin-bottom: 15px;}
        .fish-desc {
            font-size: 14px; color: #444; text-align: left; background: #e0f7fa;
            padding: 12px; border-radius: 6px; line-height: 1.6;
        }
        .btn-close {
            margin-top: 20px; padding: 12px 50px;
            background: #0277bd; color: white; border: none;
            border-radius: 25px; font-size: 18px; font-weight: bold;
            cursor: pointer; user-select: none;
        }
        .badge-rare {
            position: absolute; top: -15px; right: -15px;
            background: #ffd700; color: #000; padding: 5px 15px;
            border-radius: 20px; font-weight: bold; transform: rotate(15deg);
            box-shadow: 0 2px 5px rgba(0,0,0,0.3); pointer-events: none;
        }
        
        /* フッターエリア */
        #footer {
            position: absolute; bottom: 10px; width: 100%; text-align: center;
            color: rgba(255,255,255,0.4); font-size: 11px; font-family: sans-serif;
            pointer-events: auto; 
            z-index: 20;
        }
        #footer a {
            color: rgba(255,255,255,0.6); text-decoration: none; margin: 0 8px;
            transition: color 0.2s;
        }
        #footer a:hover { color: #fff; text-decoration: underline; }
        
        .tutorial {
            position: absolute; bottom: 40px; width: 100%; text-align: center;
            color: rgba(255,255,255,0.6); font-size: 14px; line-height: 1.5;
            text-shadow: 0 1px 2px rgba(0,0,0,0.8);
            pointer-events: none;
        }
        .zone-label {
            position: absolute; top: 50%; transform: translateY(-50%);
            font-size: 60px; font-weight: bold; color: rgba(255,255,255,0.05);
            pointer-events: none; writing-mode: vertical-rl;
        }
    </style>
</head>
<body>

<div id="ui-layer">
    <div id="depth-meter">0.0 m</div>
    <div id="message-area"><div class="msg-box" id="msg-text">TAP WATER TO CAST</div></div>
    
    <div class="zone-label" style="left: 20px;">RIVER (淡水)</div>
    <div class="zone-label" style="right: 20px;">OCEAN (海水)</div>

    <div class="tutorial">
        Tap to Cast / Tap again to Cancel<br>
        タップでキャスト / 停止中にタップでキャンセル
    </div>

    <div id="footer">
        <span>v20260211.1</span><span style="margin: 0 5px;">|</span>
        <a href="https://junichiyamada.gitlab.io/" target="_blank">Home</a><span style="margin: 0 5px;">|</span>
        <a href="https://gitlab.com/junichiyamada/kanji_fishing/-/issues" target="_blank">Bug Report</a>
    </div>
</div>

<div id="result-modal">
    <div class="fish-card">
        <div id="badge" class="badge-rare">RARE</div>
        <div style="font-size:12px; color:#666; letter-spacing:1px; margin-bottom:5px;">FISHING LOG</div>
        <div id="res-kanji" class="fish-kanji">魚</div>
        <div id="res-reading" class="fish-reading">さかな</div>
        <div id="res-en" class="fish-en">Fish</div>
        <div id="res-desc" class="fish-desc">解説</div>
        <button class="btn-close" onclick="closeModal()">OK</button>
    </div>
</div>

<canvas id="gameCanvas"></canvas>

<script>
/**
 * 拡張漢字魚辞書 (約250種以上)
 */
const FISH_DB = {
    // === 基本・初級 (Common) ===
    '魚': {y:'さかな', e:'Fish', d:'全ての魚の基本となる字。', t:'fresh'},
    '鮮': {y:'あざやか', e:'Fresh', d:'魚が新しいこと。「新鮮」の鮮。', t:'salt'},
    '鮎': {y:'あゆ', e:'Sweetfish', d:'清流の女王。独特の香りがあるため香魚とも。', t:'fresh'},
    '鯉': {y:'こい', e:'Carp', d:'滝を登って龍になるという伝説がある。', t:'fresh'},
    '鮒': {y:'ふな', e:'Crucian Carp', d:'「釣りはフナに始まりフナに終わる」。', t:'fresh'},
    '鱒': {y:'ます', e:'Trout', d:'サケ科の魚。渓流釣りの人気ターゲット。', t:'fresh'},
    '鯛': {y:'たい', e:'Sea Bream', d:'「めでたい」魚の王様。', t:'salt'},
    '鰯': {y:'いわし', e:'Sardine', d:'陸に揚げるとすぐ弱ることから「弱い魚」。', t:'salt'},
    '鯵': {y:'あじ', e:'Horse Mackerel', d:'味が良いからアジと言われる。', t:'salt'},
    '鯖': {y:'さば', e:'Mackerel', d:'「鯖を読む」の語源。数が多くて数えるのが面倒だった。', t:'salt'},
    '鮭': {y:'さけ', e:'Salmon', d:'川で生まれ海で育ち、川へ戻る。', t:'fresh'},
    '鮪': {y:'まぐろ', e:'Tuna', d:'泳ぎ続けないと死んでしまう回遊魚。', t:'salt'},
    '鮫': {y:'さめ', e:'Shark', d:'鋭い歯を持つ海のハンター。', t:'salt'},
    '鯨': {y:'くじら', e:'Whale', d:'哺乳類だが、かつては最大の魚とされていた。', t:'salt'},
    '鰻': {y:'うなぎ', e:'Eel', d:'土用の丑の日に食べるスタミナ源。', t:'fresh'},
    '鯰': {y:'なまず', e:'Catfish', d:'地震を予知すると言われる川の主。', t:'fresh'},
    '鱈': {y:'たら', e:'Cod', d:'雪の降る季節に美味しくなる。', t:'salt'},
    '鰹': {y:'かつお', e:'Bonito', d:'身が堅いことから「堅魚(かたうお)」。', t:'salt'},
    '鮃': {y:'ひらめ', e:'Flounder', d:'「左ヒラメに右カレイ」。魚食性。', t:'salt'},
    '鰈': {y:'かれい', e:'Flatfish', d:'「左ヒラメに右カレイ」。', t:'salt'},
    
    // === 中級・難読 (Uncommon/Rare) ===
    '鮟': {y:'あんこう', e:'Monkfish', d:'海底で待ち伏せする深海魚。', t:'salt'},
    '鱇': {y:'あんこう', e:'Monkfish', d:'鮟鱇（あんこう）の「こう」。', t:'salt'},
    '鰤': {y:'ぶり', e:'Yellowtail', d:'出世魚（ワカシ→イナダ→ワラサ→ブリ）。', t:'salt'},
    '鰆': {y:'さわら', e:'Spanish Mackerel', d:'春を告げる魚。', t:'salt'},
    '鱸': {y:'すずき', e:'Sea Bass', d:'夏が旬の白身魚。出世魚。', t:'salt'},
    '鱚': {y:'きす', e:'Sillago', d:'砂浜の女王。天ぷらが美味。', t:'salt'},
    '鰒': {y:'ふぐ', e:'Pufferfish', d:'毒を持つが味は絶品。「腹」が膨れる。', t:'salt'},
    '鱧': {y:'はも', e:'Pike Conger', d:'鋭い歯を持つ。京都の夏の味覚。', t:'salt'},
    '鰍': {y:'かじか', e:'Sculpin', d:'秋に美味しい川魚。', t:'fresh'},
    '鮠': {y:'はや', e:'Dace', d:'動きが速い小魚の総称。', t:'fresh'},
    '鮴': {y:'ごり', e:'Gori', d:'川底の石に張り付く小魚。', t:'fresh'},
    '鯣': {y:'するめ', e:'Dried Squid', d:'イカを干したもの。', t:'salt'},
    '鰣': {y:'はす', e:'Hasu', d:'コイ科の魚。', t:'fresh'},
    '鰰': {y:'はたはた', e:'Sandfish', d:'雷（神なり）の季節に獲れる魚。', t:'salt'},
    '鯑': {y:'かずのこ', e:'Herring Roe', d:'ニシンの卵。「カド（ニシン）の子」。', t:'salt'},
    '鯒': {y:'こち', e:'Flathead', d:'平たい体を持つ底生魚。', t:'salt'},
    '鯔': {y:'ぼら', e:'Mullet', d:'「とどのつまり」の語源となった出世魚。', t:'salt'},
    '鰊': {y:'にしん', e:'Herring', d:'春告魚（はるつげうお）。', t:'salt'},
    '鮗': {y:'このしろ', e:'Gizzard Shad', d:'コハダの成魚。武士は切腹を連想し避けた。', t:'salt'},
    '鰕': {y:'えび', e:'Shrimp', d:'「海老」とも書く。腰が曲がっている。', t:'salt'},
    '蟹': {y:'かに', e:'Crab', d:'横歩きする甲殻類。', t:'salt'},
    '蝦': {y:'えび', e:'Prawn', d:'大型のエビ。', t:'salt'},
    '鯱': {y:'しゃち', e:'Orca', d:'海の猛獣。魚偏に虎。', t:'salt'},
    '鰐': {y:'わに', e:'Crocodile/Shark', d:'古事記ではサメを指した。', t:'salt'},
    '鱶': {y:'ふか', e:'Large Shark', d:'大型のサメ。フカヒレの原料。', t:'salt'},
    '鮖': {y:'かじか', e:'Sculpin', d:'石に張り付く魚。カジカ。', t:'fresh'},
    '鮇': {y:'いわな', e:'Char', d:'イワナの別表記。', t:'fresh'},
    '鱆': {y:'たこ', e:'Octopus', d:'タコの別表記。', t:'salt'},
    '蛸': {y:'たこ', e:'Octopus', d:'海に住むクモ（海蜘蛛）。', t:'salt'},
    '鮨': {y:'すし', e:'Sushi', d:'魚が旨いと書いて寿司。', t:'salt'},
    '鮓': {y:'すし', e:'Sushi', d:'発酵させた寿司（なれずし）。', t:'salt'},
    '鰺': {y:'あじ', e:'Horse Mackerel', d:'アジの旧字体。', t:'salt'},
    '鰮': {y:'いわし', e:'Sardine', d:'イワシの別表記。', t:'salt'},
    '鱪': {y:'しいら', e:'Mahi-mahi', d:'ハワイの高級魚。万引（シイラ）とも。', t:'salt'},
    '鱰': {y:'しいら', e:'Dolphin Fish', d:'シイラの別表記。', t:'salt'},
    '鰪': {y:'いわし', e:'Sardine', d:'イワシの異体字。', t:'salt'},
    '鱠': {y:'なます', e:'Namasu', d:'魚肉を細かく刻んで酢で和えた料理。', t:'fresh'},
    '鰑': {y:'するめ', e:'Dried Squid', d:'スルメの別表記。', t:'salt'},
    '鯷': {y:'かたくちいわし', e:'Anchovy', d:'アンチョビの原料。', t:'salt'},
    '鮤': {y:'たちうお', e:'Cutlassfish', d:'刀のような魚。タチウオ。', t:'salt'},
    '魛': {y:'たちうお', e:'Cutlassfish', d:'刀の形をした魚。', t:'salt'},
    '鰝': {y:'いせえび', e:'Spiny Lobster', d:'立派なヒゲを持つエビ。', t:'salt'},
    '鰩': {y:'えい', e:'Ray', d:'海中を飛ぶように泳ぐ。', t:'salt'},
    '鱝': {y:'えい', e:'Ray', d:'エイの別表記。', t:'salt'},
    '鱉': {y:'すっぽん', e:'Soft-shell Turtle', d:'美味なカメ。', t:'fresh'},
    '鰔': {y:'かれい', e:'Flatfish', d:'カレイの一種。', t:'salt'},
    '鰉': {y:'ひがい', e:'Higai', d:'明治天皇が好んだため「皇」の字がついた。', t:'fresh'},
    '鱄': {y:'たなご', e:'Bitterling', d:'タナゴの一種。', t:'fresh'},
    '鱅': {y:'れんぎょ', e:'Silver Carp', d:'中国原産の大型淡水魚。', t:'fresh'},
    '鰱': {y:'れんぎょ', e:'Silver Carp', d:'レンギョの一種。', t:'fresh'},
    '鰂': {y:'いか', e:'Squid', d:'イカの別表記。', t:'salt'},
    '魷': {y:'いか', e:'Squid', d:'イカ（特にスルメイカ）。', t:'salt'},
    '鮬': {y:'ごり', e:'Gori', d:'幼魚、またはゴリ。', t:'fresh'},
    '鮘': {y:'たなご', e:'Bitterling', d:'タナゴの別表記。', t:'fresh'},
    '鯪': {y:'せんざんこう', e:'Dace var.', d:'コイ科の魚、またはセンザンコウ。', t:'fresh'},
    '鯳': {y:'すけとうだら', e:'Pollock', d:'カマボコの原料になるタラ。', t:'salt'},
    '鰾': {y:'うきぶくろ', e:'Swim Bladder', d:'魚が浮力を調整する器官。', t:'salt'},
    '鰭': {y:'ひれ', e:'Fin', d:'魚が泳ぐための器官。', t:'salt'},
    '鱗': {y:'うろこ', e:'Scale', d:'魚の体を守る硬い薄片。', t:'salt'},
    '鰓': {y:'えら', e:'Gills', d:'魚の呼吸器官。', t:'salt'},
    '鮞': {y:'はららご', e:'Roe', d:'魚の卵。', t:'salt'},
    '鮣': {y:'こばんざめ', e:'Remora', d:'大型魚にくっつく魚。', t:'salt'},
    '鯆': {y:'いるか', e:'Dolphin', d:'海豚（イルカ）の別表記。', t:'salt'},
    '鮧': {y:'なまず', e:'Catfish', d:'ナマズの別表記。', t:'fresh'},
    '鰢': {y:'とど', e:'Sea Lion', d:'トド、またはボラの老成魚。', t:'salt'},
    '鱨': {y:'ぎぎ', e:'Pelteobagrus', d:'ナマズの一種。ギーギー鳴く。', t:'fresh'},
    '鰳': {y:'ひら', e:'Ilisha', d:'ニシン科の魚。骨が多い。', t:'salt'},
    '鱫': {y:'むつ', e:'Gnomefish', d:'脂っこいことを「むつこい」と言う。', t:'salt'},
    '鱁': {y:'たけ', e:'Minnow', d:'コイ科の小魚。', t:'fresh'},
    '鱻': {y:'せん', e:'Fresh (Ancient)', d:'魚が3匹で新鮮さを表す古代文字。', t:'salt'},
    '鱺': {y:'ながすじ', e:'Eel-like', d:'長い魚を表す。', t:'salt'},
    '鱘': {y:'ちょうざめ', e:'Sturgeon', d:'キャビアの親魚。サメではない。', t:'fresh'},
    '鰸': {y:'しまあじ', e:'Striped Jack', d:'アジの王様。', t:'salt'},
    '鰘': {y:'むろあじ', e:'Scad', d:'干物（くさや）に使われるアジ。', t:'salt'},
    '鰙': {y:'わかさぎ', e:'Smelt', d:'氷上の穴釣りで有名。', t:'fresh'},
    '鱩': {y:'はたはた', e:'Sandfish', d:'カミナリウオ。', t:'salt'},
    '鮠': {y:'はや', e:'Dace', d:'ハヤ。動きが速い魚。', t:'fresh'},
    '鯏': {y:'あさり', e:'Clam', d:'魚偏だがアサリ（貝）を指すことがある。', t:'salt'},
    '鯐': {y:'すばしり', e:'Mullet young', d:'ボラの幼魚。', t:'salt'},
    '鰂': {y:'いか', e:'Squid', d:'イカ。則（きまり）正しく並ぶ吸盤から。', t:'salt'},
    '鮙': {y:'かれい', e:'Flatfish', d:'カレイの別字。', t:'salt'},
    '鯁': {y:'骨がのどにつかえる', e:'Fish bone stuck', d:'魚の骨が喉に刺さること。', t:'salt'},
    '鮱': {y:'ぼら', e:'Mullet', d:'ボラの老成魚（トド）。', t:'salt'},
    '鱐': {y:'しゃちほこ', e:'Shachihoko', d:'城の屋根にある想像上の魚。', t:'salt'},
    '鱥': {y:'はやか', e:'Minnow', d:'コイ科の小魚。', t:'fresh'},
    '鱮': {y:'たなご', e:'Bitterling', d:'タナゴ。', t:'fresh'},
    '鮐': {y:'ふぐ', e:'Pufferfish', d:'フグの別名（またはサバ）。', t:'salt'},
    '鮤': {y:'たちうお', e:'Cutlassfish', d:'タチウオ。', t:'salt'},
    '鯙': {y:'うつぼ', e:'Moray Eel', d:'岩礁に住む獰猛な魚。', t:'salt'},
    '鯚': {y:'きす', e:'Sillago', d:'キスの別字。', t:'salt'},
    '鯧': {y:'まながつお', e:'Butterfish', d:'西日本で珍重される高級魚。', t:'salt'},
    '鰨': {y:'うしごち', e:'Flatfish', d:'シタビラメやコチを指す。', t:'salt'},
    '鰩': {y:'えい', e:'Ray', d:'エイ。', t:'salt'},
    '鱊': {y:'たなご', e:'Bitterling', d:'タナゴの一種。', t:'fresh'},
    '鯽': {y:'ふな', e:'Crucian Carp', d:'フナの異体字。', t:'fresh'},
    '鰶': {y:'このしろ', e:'Gizzard Shad', d:'コノシロ。', t:'salt'},
    '鰷': {y:'はへ', e:'Dace', d:'ハヤやオイカワなどの小魚。', t:'fresh'},
    '鱇': {y:'あんこう', e:'Monkfish', d:'アンコウのコウ。', t:'salt'},
    '鱵': {y:'さより', e:'Halfbeak', d:'下顎が針のように長い。', t:'salt'},
    '鱦': {y:'すくも', e:'Small fish', d:'小魚の群れ。', t:'salt'},
    '鱢': {y:'しいら', e:'Mahi-mahi', d:'シイラ。', t:'salt'},
    '鱭': {y:'えつ', e:'Grenadier Anchovy', d:'筑後川に生息するカタクチイワシ科の魚。', t:'fresh'},
    '鱰': {y:'しいら', e:'Mahi-mahi', d:'シイラ。', t:'salt'},
    '鱳': {y:'このしろ', e:'Gizzard Shad', d:'コノシロの別字。', t:'salt'},
    '鱴': {y:'たちうお', e:'Cutlassfish', d:'タチウオ。', t:'salt'},
    '鱶': {y:'ふか', e:'Shark', d:'サメ（特に大型）。', t:'salt'},
    '鱹': {y:'いとう', e:'Sakhalin Taimen', d:'日本最大の淡水魚。幻の魚。', t:'fresh'},
    '鱺': {y:'うなぎ', e:'Eel', d:'ウナギやアナゴなどの長魚。', t:'fresh'},
    '鲡': {y:'うなぎ', e:'Eel', d:'ウナギ（簡体字）。', t:'fresh'},
    '鱷': {y:'わに', e:'Crocodile', d:'ワニ。', t:'fresh'},
    '鰄': {y:'かいらぎ', e:'Shark skin', d:'サメの皮。刀の柄に巻く。', t:'salt'},
    '鯥': {y:'むつ', e:'Gnomefish', d:'ムツ。', t:'salt'},
    '鯪': {y:'いさざ', e:'Isaza', d:'琵琶湖固有のハゼ科の魚。', t:'fresh'},
    '鯫': {y:'みご', e:'Small fish', d:'小魚。', t:'fresh'},
    '鯬': {y:'いなだ', e:'Young Yellowtail', d:'ブリの若魚。', t:'salt'},
    '鯭': {y:'めじな', e:'Girella', d:'磯釣りの人気対象魚。グレ。', t:'salt'},
    '鯮': {y:'そう', e:'Sogyo', d:'ソウギョ。中国四大家魚の一つ。', t:'fresh'},
    '鯯': {y:'さっぱ', e:'Sappa', d:'ママカリ（飯借り）とも呼ばれる。', t:'salt'},
    '鯲': {y:'どじょう', e:'Loach', d:'ドジョウ。', t:'fresh'},
    '鯳': {y:'すけとうだら', e:'Pollock', d:'スケトウダラ。', t:'salt'},
    '鯴': {y:'ふな', e:'Crucian Carp', d:'フナ。', t:'fresh'},
    '鯷': {y:'かたくちいわし', e:'Anchovy', d:'カタクチイワシ。', t:'salt'},
    '鯸': {y:'ふぐ', e:'Pufferfish', d:'フグ。', t:'salt'},
    '鯹': {y:'なまぐさい', e:'Fishy smell', d:'魚の生臭さ。', t:'salt'},
    '鯺': {y:'ふぐ', e:'Pufferfish', d:'フグ。', t:'salt'},
    '鯻': {y:'ほね', e:'Bone', d:'魚の骨。', t:'salt'},
    '鯼': {y:'そう', e:'Sogyo', d:'ソウギョの別字。', t:'fresh'},
    '鯾': {y:'あみ', e:'Krill', d:'アミ類。', t:'salt'},
    '鯿': {y:'ひら魚', e:'Bream var', d:'ヒラウオ。', t:'fresh'},
    '鰀': {y:'かん', e:'Big fish', d:'大きな魚。', t:'salt'},
    '鰁': {y:'うぐい', e:'Dace', d:'ウグイ。川魚。', t:'fresh'},
    '鰂': {y:'いか', e:'Squid', d:'イカ。', t:'salt'},
    '鰃': {y:'まつかさうお', e:'Pineconefish', d:'マツカサウオ。', t:'salt'},
    '鰄': {y:'かいらぎ', e:'Shark skin', d:'サメの皮。', t:'salt'},
    '鰅': {y:'ごり', e:'Gori', d:'ゴリ。', t:'fresh'},
    '鰇': {y:'いか', e:'Squid', d:'イカ。柔魚。', t:'salt'},
    '鰉': {y:'ひがい', e:'Higai', d:'ヒガイ。', t:'fresh'},
    '鰊': {y:'にしん', e:'Herring', d:'ニシン。', t:'salt'},
    '鰋': {y:'なまず', e:'Catfish', d:'ナマズ。', t:'fresh'},
    '鰌': {y:'どじょう', e:'Loach', d:'ドジョウ。', t:'fresh'},
    '鰎': {y:'かつお', e:'Bonito', d:'カツオ。', t:'salt'},
    '鰏': {y:'ひらぎ', e:'Ponyfish', d:'ヒイラギ。', t:'salt'},
    '鰑': {y:'するめ', e:'Dried Squid', d:'スルメ。', t:'salt'},
    '鰒': {y:'あわび', e:'Abalone', d:'アワビ（またはフグ）。', t:'salt'},
    '鰔': {y:'かれい', e:'Flatfish', d:'カレイ。', t:'salt'},
    '鰗': {y:'ひげだら', e:'Cod var', d:'ヒゲダラ。', t:'salt'},
    '鰘': {y:'むろあじ', e:'Scad', d:'ムロアジ。', t:'salt'},
    '鰙': {y:'わかさぎ', e:'Smelt', d:'ワカサギ。', t:'fresh'},
    '鰚': {y:'はらか', e:'Trout var', d:'ハラカ（マスの一種）。', t:'fresh'},
    '鰛': {y:'いわし', e:'Sardine', d:'イワシ。', t:'salt'},
    '鰜': {y:'かれい', e:'Flatfish', d:'カレイ。', t:'salt'},
    '鰝': {y:'いせえび', e:'Lobster', d:'イセエビ。', t:'salt'},
    '鰞': {y:'からす', e:'Crow?', d:'イカの一種（烏賊）。', t:'salt'},
    '鰟': {y:'たなご', e:'Bitterling', d:'タナゴ。', t:'fresh'},
    '鰠': {y:'えび', e:'Shrimp', d:'エビ。', t:'salt'},
    '鰡': {y:'ぼら', e:'Mullet', d:'ボラ。', t:'salt'},
    '鰣': {y:'はす', e:'Hasu', d:'ハス。', t:'fresh'},
    '鰦': {y:'なまず', e:'Catfish', d:'ナマズの一種。', t:'fresh'},
    '鰧': {y:'おこぜ', e:'Stonefish', d:'オコゼ。', t:'salt'},
    '鰨': {y:'かれい', e:'Flatfish', d:'カレイ、シタビラメ。', t:'salt'},
    '鰪': {y:'いわし', e:'Sardine', d:'イワシ。', t:'salt'},
    '鰫': {y:'れんぎょ', e:'Carp var', d:'レンギョ。', t:'fresh'},
    '鰬': {y:'まぐろ', e:'Tuna', d:'マグロ。', t:'salt'},
    '鰮': {y:'いわし', e:'Sardine', d:'イワシ。', t:'salt'},
    '鰰': {y:'はたはた', e:'Sandfish', d:'ハタハタ。', t:'salt'},
    '鰱': {y:'たなご', e:'Bitterling', d:'タナゴ（またはレンギョ）。', t:'fresh'},
    '鰲': {y:'おおがめ', e:'Giant Turtle', d:'伝説の大亀。', t:'salt'},
    '鰳': {y:'ひら', e:'Ilisha', d:'ヒラ。', t:'salt'},
    '鰴': {y:'ふぐ', e:'Pufferfish', d:'フグ。', t:'salt'},
    '鰵': {y:'いしもち', e:'Drum fish', d:'イシモチ（ニベ）。', t:'salt'},
    '鰶': {y:'このしろ', e:'Gizzard Shad', d:'コノシロ。', t:'salt'},
    '鰷': {y:'はや', e:'Dace', d:'ハヤ。', t:'fresh'},
    '鰸': {y:'しまあじ', e:'Striped Jack', d:'シマアジ。', t:'salt'},
    '鰼': {y:'どじょう', e:'Loach', d:'ドジョウ。', t:'fresh'},
    '鰽': {y:'このしろ', e:'Gizzard Shad', d:'コノシロ。', t:'salt'},
    '鰾': {y:'うきぶくろ', e:'Swim Bladder', d:'浮き袋。', t:'salt'},
    '鰿': {y:'するめ', e:'Dried Squid', d:'スルメ。', t:'salt'},
    '鱀': {y:'いるか', e:'Dolphin', d:'イルカ（カワイルカ）。', t:'fresh'},
    '鱁': {y:'たけ', e:'Minnow', d:'タケ（コイ科の小魚）。', t:'fresh'},
    '鱂': {y:'めだか', e:'Medaka', d:'メダカ。', t:'fresh'},
    '鱃': {y:'どじょう', e:'Loach', d:'ドジョウ。', t:'fresh'},
    '鱄': {y:'たなご', e:'Bitterling', d:'タナゴ。', t:'fresh'},
    '鱅': {y:'はれんこ', e:'Carp var', d:'ハレンコ（レンギョの一種）。', t:'fresh'},
    '鱆': {y:'たこ', e:'Octopus', d:'タコ。', t:'salt'},
    '鱇': {y:'あんこう', e:'Monkfish', d:'アンコウのコウ。', t:'salt'},
    '鳖': {y:'すっぽん', e:'Soft-shell Turtle', d:'スッポン。', t:'fresh'},
    '鱊': {y:'たなご', e:'Bitterling', d:'タナゴ。', t:'fresh'},
    '鱋': {y:'はす', e:'Hasu', d:'ハス。', t:'fresh'},
    '鱌': {y:'ごり', e:'Gori', d:'ゴリ。', t:'fresh'},
    '鱍': {y:'はねる', e:'Splash', d:'魚が跳ねる様子。', t:'fresh'},
    '鱎': {y:'い', e:'Topmouth Culter', d:'カワヒラの古称。銀色の細長い淡水魚。', t:'fresh'},
    '鱏': {y:'えい', e:'Ray', d:'エイ。', t:'salt'},
    '鱐': {y:'しゃちほこ', e:'Shachihoko', d:'シャチホコ。', t:'salt'},
    '鱑': {y:'ふか', e:'Shark', d:'フカ（サメ）。黄色い魚。', t:'salt'},
    '鱓': {y:'うつぼ', e:'Moray Eel', d:'ウツボ。', t:'salt'},
    '鱔': {y:'たうなぎ', e:'Swamp Eel', d:'タウナギ。', t:'fresh'},
    '鱕': {y:'ふか', e:'Shark', d:'フカ。', t:'salt'},
    '鱖': {y:'さけ', e:'Salmon', d:'サケ（またはケツギョ）。', t:'fresh'},
    '鱘': {y:'ちょうざめ', e:'Sturgeon', d:'チョウザメ。', t:'fresh'},
    '鱙': {y:'うぐい', e:'Dace', d:'ウグイ。', t:'fresh'},
    '鱚': {y:'きす', e:'Sillago', d:'キス。', t:'salt'},
    '鱛': {y:'えそ', e:'Lizardfish', d:'エソ。カマボコの原料。', t:'salt'},
    '鱜': {y:'はや', e:'Dace', d:'ハヤ。', t:'fresh'},
    '鱝': {y:'えい', e:'Ray', d:'エイ。', t:'salt'},
    '鱞': {y:'やもめ', e:'Lone fish', d:'独り身の魚（大魚）。', t:'fresh'},
    '鱟': {y:'かぶとがに', e:'Horseshoe Crab', d:'カブトガニ。生きた化石。', t:'salt'},
    '鱡': {y:'えそ', e:'Lizardfish', d:'エソ。', t:'salt'},
    '鱢': {y:'しいら', e:'Mahi-mahi', d:'シイラ。', t:'salt'},
    '鱣': {y:'ちょうざめ', e:'Sturgeon', d:'チョウザメ。', t:'fresh'},
    '鱤': {y:'かん', e:'Yellowcheek', d:'中国の大型淡水肉食魚。', t:'fresh'},
    '鱥': {y:'はやか', e:'Minnow', d:'ハヤカ。', t:'fresh'},
    '鱦': {y:'すくも', e:'Small fish', d:'小魚。', t:'salt'},
    '鱨': {y:'ぎぎ', e:'Catfish var', d:'ギギ。', t:'fresh'},
    '鱩': {y:'はたはた', e:'Sandfish', d:'ハタハタ。', t:'salt'},
    '鱪': {y:'しいら', e:'Mahi-mahi', d:'シイラ。', t:'salt'},
    '鱫': {y:'むつ', e:'Gnomefish', d:'ムツ。', t:'salt'},
    '鱬': {y:'いるか', e:'Dolphin', d:'イルカ。', t:'salt'},
    '鱭': {y:'えつ', e:'Grenadier Anchovy', d:'エツ。', t:'fresh'},
    '鱮': {y:'たなご', e:'Bitterling', d:'タナゴ。', t:'fresh'},
    '鱯': {y:'なまず', e:'Catfish', d:'ナマズ。', t:'fresh'},
    '鱰': {y:'しいら', e:'Mahi-mahi', d:'シイラ。', t:'salt'},
    '鱱': {y:'らいぎょ', e:'Snakehead', d:'ライギョ。', t:'fresh'},
    '鱲': {y:'からすみ', e:'Mullet Roe', d:'カラスミ（ボラの卵巣）。', t:'salt'},
    '鱳': {y:'このしろ', e:'Gizzard Shad', d:'コノシロ。', t:'salt'},
    '鱴': {y:'たちうお', e:'Cutlassfish', d:'タチウオ。', t:'salt'},
    '鱵': {y:'さより', e:'Halfbeak', d:'サヨリ。', t:'salt'},
    '鱶': {y:'ふか', e:'Shark', d:'フカ（サメ）。', t:'salt'},
    '鱷': {y:'わに', e:'Crocodile', d:'ワニ。', t:'fresh'},
    '鱸': {y:'すずき', e:'Sea Bass', d:'スズキ。', t:'salt'},
    '鱹': {y:'いとう', e:'Sakhalin Taimen', d:'イトウ。', t:'fresh'},
    '鱺': {y:'うなぎ', e:'Eel', d:'ウナギ。', t:'fresh'}
};

// 辞書にない場合のフォールバック（基本的に発生しないように網羅）
function getFishData(kanji, type) {
    if (FISH_DB[kanji]) {
        return FISH_DB[kanji];
    }
    return {
        y: '？？？',
        e: 'Ancient Mystery',
        d: `深海で発見された古代魚。「${kanji}」の読みは失われている...`,
        t: type
    };
}

// 辞書のキー配列をプールとして使用
const FISH_POOL = Object.keys(FISH_DB);

// --- Audio System ---
const AudioSys = {
    ctx: null, gain: null,
    init: function() {
        if (!this.ctx) {
            this.ctx = new (window.AudioContext || window.webkitAudioContext)();
            this.gain = this.ctx.createGain();
            this.gain.gain.value = 0.3;
            this.gain.connect(this.ctx.destination);
        }
        if(this.ctx.state === 'suspended') this.ctx.resume();
    },
    play: function(freq, type, dur, slide=null) {
        if (!this.ctx) return;
        const o = this.ctx.createOscillator(); const g = this.ctx.createGain();
        o.type = type; o.frequency.setValueAtTime(freq, this.ctx.currentTime);
        if(slide) o.frequency.exponentialRampToValueAtTime(slide, this.ctx.currentTime+dur);
        g.gain.setValueAtTime(0.5, this.ctx.currentTime);
        g.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime+dur);
        o.connect(g); g.connect(this.gain);
        o.start(); o.stop(this.ctx.currentTime+dur);
    },
    cast: () => AudioSys.play(600, 'sine', 0.5, 200),
    bite: () => { AudioSys.play(800, 'square', 0.1); setTimeout(()=>AudioSys.play(800,'square',0.1), 100); },
    reel: () => AudioSys.play(300, 'triangle', 0.05),
    catch: () => [0,100,200,400].forEach((t,i)=>setTimeout(()=>AudioSys.play(440*[1,1.25,1.5,2][i], 'square', 0.3), t)),
    cancel: () => AudioSys.play(150, 'sawtooth', 0.2),
    escape: () => AudioSys.play(100, 'sawtooth', 0.5)
};

// --- Game Engine Variables ---
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
let width, height;

// Game State
let state = 'IDLE'; 
let hook = { x: 0, y: 0, depth: 0, speed: 0, biteY: 0 };
let fishes = [];
let cameraY = 0;
let targetFish = null;
let fightProgress = 0;

// Config
const CAST_SPEED = 12;
const MAX_DEPTH = 7000;
const VIEW_BUFFER = 1600;

// --- Initialize Logic ---
// 1. Resize First
function resize() {
    width = window.innerWidth;
    height = window.innerHeight;
    canvas.width = width;
    canvas.height = height;
    hook.x = width / 2;
}
window.addEventListener('resize', resize);
resize(); // Call immediately to set width/height

// 2. Define Classes (Now width/height are available)
class Bubble {
    constructor() {
        this.worldX = Math.random() * width;
        this.worldY = Math.random() * height; // 画面の高さ範囲内で初期化
        this.size = 1.5 + Math.random() * 2.5; 
        this.riseSpeed = 0.4 + Math.random() * 0.8;
        this.parallaxFactor = 0.6; // 魚よりゆっくり動く（奥にいる演出）
        this.sinOffset = Math.random() * Math.PI * 2;
        this.sinSpeed = 0.02 + Math.random() * 0.03;
        this.amplitude = 10 + Math.random() * 15;
    }

    update() {
        this.worldY -= this.riseSpeed; // 上に昇る
        this.sinOffset += this.sinSpeed; // ゆらゆら更新
    }

    draw(ctx, camY) {
        // カメラの動き（camY）に合わせて上下にループさせる計算
        // Modulo (%) を使って、画面上端に消えたら下から出てくるようにする
        let screenY = (this.worldY - camY * this.parallaxFactor) % height;
        if (screenY < 0) screenY += height;

        // サインカーブによる横揺れ
        const swayX = Math.sin(this.sinOffset) * this.amplitude;
        const renderX = (this.worldX + swayX) % width;

        ctx.save();
        ctx.translate(renderX, screenY);
        
        // 透明感のある泡の描画
        ctx.beginPath();
        ctx.strokeStyle = 'rgba(255, 255, 255, 0.4)';
        ctx.lineWidth = 1.2;
        ctx.arc(0, 0, this.size, 0, Math.PI * 2);
        ctx.stroke();

        // 泡のハイライト（光の点）
        ctx.beginPath();
        ctx.fillStyle = 'rgba(255, 255, 255, 0.5)';
        ctx.arc(-this.size * 0.3, -this.size * 0.3, this.size * 0.2, 0, Math.PI * 2);
        ctx.fill();

        ctx.restore();
    }
}

class Fish {
    constructor() { this.reset(true); }
    reset(isInit = false) {
        this.depth = Math.random() * (MAX_DEPTH - 150);
        this.char = FISH_POOL[Math.floor(Math.random() * FISH_POOL.length)];
        const dbData = FISH_DB[this.char] || {t:'salt'};
        this.type = dbData.t;
        this.size = 40 + Math.random() * 60;
        
        if (isInit) {
            this.y = this.depth;
        } else {
            if (state === 'CASTING') {
                this.y = cameraY + height + VIEW_BUFFER + Math.random() * 1000;
            } else if (state === 'REELING' || state === 'RETRIEVING') {
                this.y = cameraY - VIEW_BUFFER - Math.random() * 1000;
            } else {
                this.y = cameraY + height + VIEW_BUFFER;
            }
        }
        if (this.y > MAX_DEPTH - 150) this.y = Math.random() * (MAX_DEPTH - 200);

        const border = width / 2;
        if (this.type === 'fresh') {
            this.minX = 0; this.maxX = border;
            this.x = Math.random() * (border - 50);
        } else {
            this.minX = border; this.maxX = width;
            this.x = border + Math.random() * (width/2 - 50);
        }
        
        this.vx = (Math.random() * 2 + 0.5) * (Math.random()<0.5 ? 1 : -1);
        this.state = 'SWIM';
    }

    update() {
        if (this.state === 'SWIM') {
            this.x += this.vx;
            if (this.x < this.minX + 20 || this.x > this.maxX - 20) this.vx *= -1;
            
            const screenY = this.y - cameraY;
            
            // 画面外（上）に消えたら下へ再配置
            if (screenY < -VIEW_BUFFER) {
                this.y = cameraY + height + VIEW_BUFFER + Math.random() * 500;
                if (this.y > MAX_DEPTH) {
                    this.y = cameraY - VIEW_BUFFER - Math.random() * 500;
                }
                this.resetX();
            } 
            // 画面外（下）に消えたら上へ再配置
            else if (screenY > height + VIEW_BUFFER) {
                this.y = cameraY - VIEW_BUFFER - Math.random() * 500;
                this.resetX();
            }

            // 針との当たり判定
            if (state === 'HOLDING' && Math.abs(this.y - hook.y) < 70 && Math.abs(this.x - hook.x) < 70) {
                if (Math.random() < 0.2) startBite(this);
            }
        } 
        // === ここから下の処理が消えていました ===
        else if (this.state === 'HOOKED') {
            // 釣られている間は針の位置（hook.x, hook.y）に固定する
            // 少し揺らして暴れている演出を入れる
            this.x = hook.x + (Math.random() - 0.5) * 15;
            this.y = hook.y + 25;
        }
    }
    
    resetX() {
        this.char = FISH_POOL[Math.floor(Math.random() * FISH_POOL.length)];
        const dbData = FISH_DB[this.char];
        this.type = dbData ? dbData.t : 'salt';
        const border = width / 2;
        if (this.type === 'fresh') {
            this.minX = 0; this.maxX = border;
            this.x = Math.random() * (border - 50);
        } else {
            this.minX = border; this.maxX = width;
            this.x = border + Math.random() * (width/2 - 50);
        }
    }

    draw() {
        const screenY = this.y - cameraY;
        if (screenY < -100 || screenY > height + 100) return;

        ctx.save();
        ctx.translate(this.x, screenY);
        ctx.fillStyle = 'rgba(0,0,0,0.3)';
        ctx.font = `bold ${this.size}px serif`;
        ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
        ctx.fillText(this.char, 8, 8);
        ctx.fillStyle = this.type === 'fresh' ? '#b2dfdb' : '#e1f5fe';
        ctx.fillText(this.char, 0, 0);
        ctx.restore();
    }
}

// 3. Initialize Objects
const bubbles = [];
for(let i=0; i<50; i++) bubbles.push(new Bubble());

for(let i=0; i<35; i++) fishes.push(new Fish());

// --- Input Handling ---
function handleInput(e) {
    if (e.target.tagName === 'BUTTON' || e.target.tagName === 'A') return;
    if (document.getElementById('result-modal').style.display === 'flex') return;

    AudioSys.init();
    let clientX = (e.touches && e.touches[0]) ? e.touches[0].clientX : e.clientX;
    
    if (state === 'IDLE') {
        hook.x = Math.max(20, Math.min(width - 20, clientX));
        state = 'CASTING';
        hook.y = 0; hook.speed = CAST_SPEED;
        setMessage("TAP TO STOP");
        AudioSys.cast();
    } else if (state === 'CASTING') {
        state = 'HOLDING'; hook.speed = 0;
        setMessage("WAITING... / TAP TO CANCEL");
    } else if (state === 'HOLDING') {
        // キャンセル（高速回収）モードへ
        state = 'RETRIEVING';
        AudioSys.cancel();
        setMessage("CANCELED / RETRIEVING...");
    } else if (state === 'BITE') {
        state = 'REELING';
        fightProgress = 0;
        hook.biteY = hook.y; // 逃げられる判定の基準点を記録
        AudioSys.reel();
        setMessage("REEL IT IN! (TAP!)");
    } else if (state === 'REELING') {
        // 釣り上げ。以前の50から200へ（4倍楽に）
        hook.y -= 200; 
        AudioSys.reel();
        if (hook.y <= 0) catchFish();
    }
}

function startBite(fish) {
    state = 'BITE'; targetFish = fish; fish.state = 'HOOKED';
    hook.biteY = hook.y;
    AudioSys.bite(); setMessage("!!! TAP !!!");
    setTimeout(() => {
        if (state === 'BITE') {
            fishEscaped(fish);
        }
    }, 1200);
}

function fishEscaped(fish) {
    state = 'IDLE'; 
    if(fish) { fish.state = 'SWIM'; fish.vx *= 3; }
    AudioSys.escape();
    setMessage("ESCAPED... (TOO DEEP / TOO SLOW)");
    setTimeout(() => { if(state==='IDLE') { hook.y = 0; setMessage("TAP TO CAST"); } }, 2000);
}

function catchFish() {
    state = 'CAUGHT'; AudioSys.catch();
    const f = targetFish;
    const data = getFishData(f.char, f.type);
    
    document.getElementById('result-modal').style.display = 'flex';
    document.getElementById('res-kanji').innerText = f.char;
    document.getElementById('res-reading').innerText = data.y;
    document.getElementById('res-en').innerText = data.e;
    document.getElementById('res-desc').innerText = data.d;
    
    const badge = document.getElementById('badge');
    badge.innerText = "CATCH"; badge.style.background = "#ffd700";
}

window.closeModal = function() {
    document.getElementById('result-modal').style.display = 'none';
    if(targetFish) targetFish.reset();
    state = 'IDLE'; hook.y = 0; cameraY = 0;
    setMessage("TAP TO CAST");
}

function setMessage(msg) { document.getElementById('msg-text').innerText = msg; }

// --- Main Loop ---
function draw() {
    if (state === 'CASTING') {
        hook.y += hook.speed;
        if (hook.y >= MAX_DEPTH) { state = 'HOLDING'; setMessage("MAX DEPTH / TAP TO CANCEL"); }
    } else if (state === 'REELING') {
        hook.y += 2.5; // 自然沈下
        // 噛みついた位置(biteY)から50m(500px)沈んだら失敗
        if (hook.y > hook.biteY + 500) fishEscaped(targetFish);
    }
    else if (state === 'RETRIEVING') {
        hook.y -= 100; // キャンセル時の回収速度
        if (hook.y <= 0) { hook.y = 0; state = 'IDLE'; setMessage("TAP TO CAST"); }
    }

    let targetCamY = hook.y - height * 0.4;
    if (targetCamY < 0) targetCamY = 0;
    cameraY += (targetCamY - cameraY) * 0.1;

    document.getElementById('depth-meter').innerText = (hook.y / 10).toFixed(1) + " m";

    let depthRatio = Math.min(cameraY / MAX_DEPTH, 1);
    let r = Math.floor(0 * (1-depthRatio));
    let g = Math.floor(100 * (1-depthRatio)); 
    let b = Math.floor(200 * (1-depthRatio) + 50); 
    ctx.fillStyle = `rgb(${r},${g},${b})`;
    ctx.fillRect(0, 0, width, height);
    
    bubbles.forEach(b => { b.update(); b.draw(ctx, cameraY); });

    const sunGrad = ctx.createLinearGradient(0, 0, 0, height/2);
    sunGrad.addColorStop(0, 'rgba(255, 255, 255, 0.15)');
    sunGrad.addColorStop(1, 'rgba(255, 255, 255, 0)');
    ctx.fillStyle = sunGrad;
    ctx.fillRect(0, 0, width, height);

    ctx.strokeStyle = 'rgba(255, 255, 255, 0.1)';
    ctx.setLineDash([10, 20]);
    ctx.beginPath(); ctx.moveTo(width/2, 0); ctx.lineTo(width/2, height); ctx.stroke();
    ctx.setLineDash([]);

    ctx.fillStyle = 'rgba(255,255,255,0.1)'; ctx.font = '20px monospace'; ctx.textAlign = 'center';
    const startD = Math.floor(cameraY / 500) * 500;
    for(let d=startD; d<startD + height + 500; d+=500) {
        let sy = d - cameraY;
        ctx.fillText(`- ${d/10}m -`, width/2, sy);
    }

    fishes.forEach(f => { f.update(); f.draw(); });

    let screenHookY = hook.y - cameraY;
    ctx.strokeStyle = 'white'; ctx.lineWidth = 1.5;
    ctx.beginPath(); ctx.moveTo(hook.x, -100); ctx.lineTo(hook.x, screenHookY); ctx.stroke();
    
    ctx.fillStyle = state === 'BITE' ? 'red' : 'silver';
    ctx.beginPath(); ctx.arc(hook.x, screenHookY, 6, 0, Math.PI*2); ctx.fill();
    
    requestAnimationFrame(draw);
}

// Window level listener to catch clicks anywhere
window.addEventListener('mousedown', handleInput);
window.addEventListener('touchstart', handleInput, {passive:false});

requestAnimationFrame(draw);
</script>
</body>
</html>