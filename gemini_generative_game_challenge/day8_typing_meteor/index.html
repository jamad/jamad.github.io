<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <!-- Dark Reader„Å™„Å©„ÅÆÊã°ÂºµÊ©üËÉΩ„Å´„Çà„ÇãËâ≤Â§âÊèõ„Çí„Éñ„É≠„ÉÉ„ÇØ -->
    <meta name="darkreader-lock">
    <title>Finnish Defense</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'VT323', monospace;
            background-color: #0f172a;
            overflow: hidden;
            touch-action: none;
            -webkit-tap-highlight-color: transparent;
        }

        #gameCanvas {
            display: block;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        #bgLayer {
            background-color: #0f172a;
        }

        /* ÈÄöÂ∏∏„ÅÆ„Éç„Ç™„É≥„ÉÜ„Ç≠„Çπ„Éà */
        .neon-text {
            text-shadow: 0 0 2px rgba(255, 255, 255, 0.5), 0 0 10px rgba(255, 0, 222, 0.4);
        }

        /* „Çø„Ç§„Éà„É´Â∞ÇÁî®„Çπ„Çø„Ç§„É´ */
        .title-style {
            -webkit-text-stroke: 1px rgba(255, 255, 255, 0.5);
            filter: drop-shadow(0 0 5px rgba(255, 0, 222, 0.5)) drop-shadow(0 0 10px rgba(255, 0, 222, 0.3));
        }

        #defeatedList::-webkit-scrollbar {
            width: 4px;
        }

        #defeatedList::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.3);
        }

        #defeatedList::-webkit-scrollbar-thumb {
            background: #4ade80;
        }

        #inputArea {
            pointer-events: auto;
            background: rgba(15, 23, 42, 0.9);
            border-top: 2px solid #334155;
        }

        @keyframes shake {
            0% { transform: translate(1px, 1px) rotate(0deg); }
            10% { transform: translate(-1px, -2px) rotate(-1deg); }
            20% { transform: translate(-3px, 0px) rotate(1deg); }
            30% { transform: translate(3px, 2px) rotate(0deg); }
            40% { transform: translate(1px, -1px) rotate(1deg); }
            50% { transform: translate(-1px, 2px) rotate(-1deg); }
            100% { transform: translate(1px, -2px) rotate(-1deg); }
        }

        .shake {
            animation: shake 0.5s;
            animation-iteration-count: 1;
        }

        .fade-in {
            animation: fadeIn 0.5s ease-in forwards;
            opacity: 0;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @media (max-height: 500px) {
            .hide-on-keyboard {
                display: none !important;
            }
            .ui-layer-left {
                padding-top: 5px !important;
            }
        }

        @media (max-width: 768px) {
            .playing-mode #logContainer {
                display: none !important;
            }
        }

        #playerInput {
            caret-color: #22d3ee;
        }

        /* „Éï„ÉÉ„Çø„Éº„É™„É≥„ÇØ„ÅÆ„Çπ„Çø„Ç§„É´ */
        #globalFooter a {
            text-decoration: none;
            transition: color 0.2s;
        }
        #globalFooter a:hover {
            color: #22d3ee;
            text-decoration: underline;
        }

        /* Âæ©Ê¥ª: „Éá„Éê„ÉÉ„Ç∞ÊÉÖÂ†±Áî®„ÅÆ„Çπ„Çø„Ç§„É´ */
        #debugInfo {
            position: fixed;
            top: 60px;
            left: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: #00ff00;
            padding: 5px 10px;
            font-family: monospace;
            font-size: 12px;
            border-radius: 4px;
            z-index: 100;
            display: none; /* „Éá„Éï„Ç©„É´„Éà„ÅØÈùûË°®Á§∫ */
            pointer-events: none;
        }
    </style>
</head>

<body class="text-white h-[100dvh] w-screen flex flex-col relative overflow-hidden">
    
    <!-- ËÉåÊôØ (z-0) -->
    <div id="bgLayer" class="absolute inset-0 z-0"></div>

    <!-- Âæ©Ê¥ª: „Éá„Éê„ÉÉ„Ç∞Áî®„Ç≥„É≥„ÉÜ„Éä -->
    <div id="debugInfo">FPS: 0</div>

    <!-- UI Â∑¶ÂÅ¥ (z-10) -->
    <div class="absolute top-0 left-0 w-full px-4 pt-[max(1rem,env(safe-area-inset-top))] flex justify-between items-start z-10 ui-layer-left pointer-events-none">
        <div class="flex flex-col">
            <div class="text-sm font-bold text-yellow-600 mt-2">HI-SCORE: <span id="highScoreDisplay">0</span></div>
            <div class="text-xl">SCORE: <span id="scoreDisplay" class="text-cyan-400">0</span></div>
            <div class="text-lg">SISU SHIELD: <span id="healthDisplay" class="text-green-400">100%</span></div>
        </div>
    </div>

    <!-- „Ç≠„É£„É≥„Éê„Çπ (z-20) -->
    <canvas id="gameCanvas" class="absolute inset-0 z-20"></canvas>

    <!-- UI Âè≥ÂÅ¥ („É™„Çπ„Éà) (z-60) -->
    <div class="absolute top-0 right-0 p-4 pt-[max(1rem,env(safe-area-inset-top))] z-[60] pointer-events-none">
        <div id="logContainer"
            class="w-48 h-64 bg-slate-900/80 border border-slate-600 rounded p-2 flex flex-col relative hide-on-keyboard transition-all duration-500 pointer-events-auto">
            <div class="text-xs text-slate-400 border-b border-slate-600 mb-1 pb-1">DEFEATED WORDS LOG</div>
            <ul id="defeatedList" class="flex-1 overflow-y-auto text-sm space-y-1 font-mono text-green-400"></ul>
        </div>
    </div>

    <!-- „Çπ„Çø„Éº„ÉàÁîªÈù¢ (z-50) -->
    <div id="startScreen"
        class="absolute inset-0 z-50 bg-black/80 flex flex-col items-center justify-center pointer-events-auto">
        <h1 class="text-6xl md:text-8xl font-bold text-transparent bg-clip-text bg-gradient-to-b from-purple-400 to-pink-600 mb-4 text-center title-style">
            FINNISH<br>DEFENSE
        </h1>
        <p class="text-xl md:text-2xl text-cyan-400 tracking-widest mb-8 font-bold">TYPE TO SURVIVE</p>
        
        <p class="text-lg mb-8 text-center px-4 text-slate-300">Protect the city from falling meteors.<br>Type the words to activate lasers.</p>
        
        <button id="startButton"
            class="px-8 py-4 bg-cyan-600 hover:bg-cyan-500 text-white text-2xl rounded border-b-4 border-cyan-800 active:border-0 active:translate-y-1 transition-all">
            <span id="loadingText">LOADING...</span>
            <span id="startText" class="hidden">START DEFENSE</span>
        </button>
    </div>

    <!-- „Ç≤„Éº„É†„Ç™„Éº„Éê„ÉºÁîªÈù¢ (z-50) -->
    <div id="gameOverScreen"
        class="hidden absolute inset-0 z-50 bg-red-900/90 flex flex-col items-center justify-center pointer-events-auto">
        <h1 class="text-6xl font-bold text-white mb-4">GAME OVER</h1>
        <p class="text-2xl mb-8">City Destroyed.</p>
        <div class="text-3xl mb-8">Final Score: <span id="finalScore">0</span></div>

        <div class="text-xl text-yellow-400 mb-8 font-bold">High Score: <span id="finalHighScore">0</span></div>

        <div id="restartContainer" class="hidden flex flex-col items-center gap-4">
            <button id="restartButton"
                class="w-64 py-4 bg-white text-red-900 text-2xl rounded font-bold hover:bg-gray-200 shadow-lg transition-transform active:scale-95 text-center">
                TRY AGAIN <span class="text-sm font-normal block text-gray-500">(PRESS ENTER)</span>
            </button>

            <button id="shareButton"
                class="w-64 py-3 bg-black text-white border border-slate-600 rounded hover:bg-slate-800 transition-colors flex items-center justify-center gap-2 font-bold">
                <svg class="w-4 h-4 fill-current" viewBox="0 0 24 24"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>
                POST SCORE
            </button>

            <button id="nativeShareButton" class="hidden w-64 py-3 bg-slate-700 text-white border border-slate-500 rounded hover:bg-slate-600 transition-colors flex items-center justify-center gap-2 font-bold">
                <svg class="w-4 h-4 fill-current" viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9c-1.66 0-3 1.34-3 3s1.34 3 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65 0 1.61 1.31 2.92 2.92 2.92 1.61 0 2.92-1.31 2.92-2.92s-1.31-2.92-2.92-2.92z"/></svg>
                SHARE
            </button>

            <button id="titleButton"
                class="w-64 py-3 bg-transparent text-slate-400 border border-slate-700 rounded hover:bg-slate-800 hover:text-white transition-colors font-mono font-bold">
                BACK TO TITLE
            </button>
        </div>
    </div>

    <div id="inputArea" class="absolute bottom-6 w-full p-4 z-40 flex justify-center items-center border-none" style="background: rgba(15, 23, 42, 0.95); border-top: 2px solid #334155;">
        <div class="relative w-full max-w-2xl">
            <div
                class="absolute bottom-full left-1/2 -translate-x-1/2 w-16 h-8 bg-slate-700 rounded-t-lg border-t-2 border-x-2 border-slate-500 flex justify-center">
                <div class="w-2 h-4 bg-cyan-500 rounded-full mt-1 animate-pulse"></div>
            </div>
            
            <form id="gameForm" action="#" onsubmit="return false;" class="w-full">
                <input type="text" id="playerInput"
                    class="w-full bg-slate-800 text-cyan-400 text-2xl px-4 py-3 rounded border-2 border-slate-600 focus:border-cyan-500 focus:outline-none focus:ring-2 focus:ring-cyan-500/50 uppercase placeholder-slate-600 text-center"
                    placeholder="TYPE THE METEOR NAME..." 
                    autocomplete="one-time-code" 
                    autocorrect="off" 
                    autocapitalize="off"
                    spellcheck="false">
            </form>
        </div>
    </div>

    <div id="globalFooter" class="fixed bottom-0 left-0 w-full text-center text-xs text-slate-500 py-1 z-[100] font-mono pointer-events-auto bg-slate-900/90 backdrop-blur-sm border-t border-slate-800"></div>

    <script>
        class SoundManager {
            constructor() { this.ctx = null; this.masterGain = null; }
            init() {
                if (!this.ctx) {
                    this.ctx = new (window.AudioContext || window.webkitAudioContext)();
                    this.masterGain = this.ctx.createGain();
                    this.masterGain.gain.value = 0.3;
                    this.masterGain.connect(this.ctx.destination);
                }
                if (this.ctx.state === 'suspended') this.ctx.resume();
            }
            playLaser() {
                if (!this.ctx) return;
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(880, this.ctx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(110, this.ctx.currentTime + 0.2);
                gain.gain.setValueAtTime(0.5, this.ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + 0.2);
                osc.connect(gain);
                gain.connect(this.masterGain);
                osc.start(); osc.stop(this.ctx.currentTime + 0.2);
            }
            playExplosion() {
                if (!this.ctx) return;
                const bufferSize = this.ctx.sampleRate * 0.5;
                const buffer = this.ctx.createBuffer(1, bufferSize, this.ctx.sampleRate);
                const data = buffer.getChannelData(0);
                for (let i = 0; i < bufferSize; i++) data[i] = Math.random() * 2 - 1;
                const noise = this.ctx.createBufferSource();
                noise.buffer = buffer;
                const filter = this.ctx.createBiquadFilter();
                filter.type = 'lowpass';
                filter.frequency.setValueAtTime(1000, this.ctx.currentTime);
                filter.frequency.linearRampToValueAtTime(100, this.ctx.currentTime + 0.5);
                const gain = this.ctx.createGain();
                gain.gain.setValueAtTime(0.8, this.ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + 0.5);
                noise.connect(filter); filter.connect(gain); gain.connect(this.masterGain);
                noise.start();
            }
            playType() {
                if (!this.ctx) return;
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.type = 'square';
                osc.frequency.setValueAtTime(1200, this.ctx.currentTime);
                gain.gain.setValueAtTime(0.1, this.ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + 0.05);
                osc.connect(gain); gain.connect(this.masterGain);
                osc.start(); osc.stop(this.ctx.currentTime + 0.05);
            }
            playError() {
                if (!this.ctx) return;
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(150, this.ctx.currentTime);
                gain.gain.setValueAtTime(0.3, this.ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + 0.2);
                osc.connect(gain); gain.connect(this.masterGain);
                osc.start(); osc.stop(this.ctx.currentTime + 0.2);
            }
        }

        const FALLBACK_WORDS = {
            "6aaef8c3-sample1": { "lemma": "huomenta", "en": "Good morning", "forms": ["huomenta"] },
            "09f2bd8b-sample2": { "lemma": "kirja", "en": "book", "forms": ["kirjan", "kirja"] },
            "db9e7f8d-sample3": { "lemma": "henkil√∂", "en": "person", "forms": ["henkil√∂t", "henkil√∂kohtaisesti"] },
            "simple-koti": { "lemma": "koti", "en": "home", "forms": ["koti"] },
            "simple-koulu": { "lemma": "koulu", "en": "school", "forms": ["koulu"] },
            "simple-aurinko": { "lemma": "aurinko", "en": "sun", "forms": ["aurinko"] }
        };

        let WORD_LIST = []; 

        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const scoreDisplay = document.getElementById('scoreDisplay');
        const healthDisplay = document.getElementById('healthDisplay');
        const defeatedList = document.getElementById('defeatedList');
        const inputElement = document.getElementById('playerInput');
        const debugInfo = document.getElementById('debugInfo');
        const sound = new SoundManager();

        const GAME_VERSION = "v20260119.3";

        let gameState = 'start';
        let animationFrameId; 
        let score = 0, health = 100, frameCount = 0;
        let cityShakeTimer = 0; 
        let highScore = localStorage.getItem('finnishMeteorHighScore') || 0;
        let wordCollection = JSON.parse(localStorage.getItem('finnishWordCollection')) || {};

        let meteors = [], particles = [], lasers = [], stars = [], buildings = [];
        let spawnRate = 120, difficultyMultiplier = 1.0;
        
        let cachedHeight = window.visualViewport ? window.visualViewport.height : window.innerHeight;

        // „Éá„Éê„ÉÉ„Ç∞Áî®
        let lastTime = 0;
        let showDebug = false;
        let lastDebugUpdateTime = 0;

        class Meteor {
            constructor() {
                const wordObj = WORD_LIST[Math.floor(Math.random() * WORD_LIST.length)];
                this.word = wordObj.fi;
                this.translation = wordObj.en;

                const margin = canvas.width * 0.1;
                this.x = Math.random() * (canvas.width - margin * 2) + margin;

                this.y = -50;
                const baseSpeed = 0.25 * difficultyMultiplier;
                const lengthFactor = Math.max(0, 10 - this.word.length) * 0.06;
                this.speed = baseSpeed + lengthFactor + (Math.random() * 0.2);

                if (/[√§√∂]/.test(this.word)) {
                    this.speed *= 0.7;
                }

                this.radius = 5; 
                this.isHit = false; 
                this.hitTimer = 0; 
                this.isDying = false; 
            }

            update() {
                if (this.isDying) {
                    this.hitTimer++; 
                    return 'dying';
                }

                if (this.isHit) { this.hitTimer++; return 'active'; }

                const heightRatio = canvas.height / 800;
                this.y += this.speed * heightRatio;

                if (this.y > canvas.height - 100) { takeDamage(15); createExplosion(this.x, this.y, '#ef4444'); return 'destroyed'; }
                return 'active';
            }

            draw() {
                const trailAlpha = this.isDying ? Math.max(0, 1.0 - (this.hitTimer / 20)) : 1.0;
                
                if (trailAlpha > 0) {
                    const tailLength = 100; 
                    const grad = ctx.createLinearGradient(this.x, this.y, this.x, this.y - tailLength);
                    grad.addColorStop(0, `rgba(255, 100, 0, ${trailAlpha})`); 
                    grad.addColorStop(1, `rgba(255, 100, 0, 0)`);           
                    
                    ctx.beginPath();
                    ctx.moveTo(this.x, this.y);
                    ctx.lineTo(this.x, this.y - tailLength);
                    ctx.strokeStyle = grad;
                    ctx.lineWidth = 4;
                    ctx.stroke();
                }

                if (!this.isHit) {
                    ctx.beginPath(); ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
                    let grad = ctx.createRadialGradient(this.x, this.y, 1, this.x, this.y, this.radius);
                    grad.addColorStop(0, '#fdba74'); grad.addColorStop(1, '#dc2626');
                    ctx.fillStyle = grad; ctx.fill();

                    ctx.font = '24px "VT323"';
                    const text = this.word.toUpperCase();
                    
                    const inputVal = inputElement.value.toLowerCase().trim();
                    let matchLength = 0;
                    let isMismatch = false;

                    if (inputVal.length > 0) {
                        if (this.word.startsWith(inputVal)) {
                            matchLength = inputVal.length;
                        } else {
                            matchLength = Math.min(inputVal.length, text.length);
                            isMismatch = true;
                        }
                    }

                    const highlightText = text.substring(0, matchLength);
                    const restText = text.substring(matchLength);

                    const highlightWidth = ctx.measureText(highlightText).width;
                    const restWidth = ctx.measureText(restText).width;
                    const totalWidth = highlightWidth + restWidth;

                    const startX = this.x - (totalWidth / 2);
                    const textY = this.y + 25;

                    if (matchLength > 0) {
                        if (isMismatch) {
                            ctx.fillStyle = '#6b7280'; 
                            ctx.shadowBlur = 0; 
                        } else {
                            ctx.fillStyle = '#22d3ee'; 
                            ctx.shadowColor = '#22d3ee';
                            ctx.shadowBlur = 15; 
                        }
                        
                        ctx.textAlign = 'left'; 
                        ctx.fillText(highlightText, startX, textY);
                        ctx.shadowBlur = 0; 
                    }

                    ctx.fillStyle = '#ffffff';
                    ctx.shadowColor = 'black';
                    ctx.shadowBlur = 4;
                    ctx.textAlign = 'left'; 
                    ctx.fillText(restText, startX + highlightWidth, textY);

                } 
                else {
                    const alpha = 1.0 - (this.hitTimer / 180);
                    if (alpha > 0) {
                        const scale = 1.0 + (this.hitTimer / 180) * 0.5; 
                        
                        ctx.save();
                        ctx.translate(this.x, this.y + 30);
                        ctx.scale(scale, scale);
                        
                        ctx.font = 'bold 28px "VT323"'; 
                        ctx.fillStyle = `rgba(74, 222, 128, ${alpha})`;
                        ctx.textAlign = 'center'; 
                        ctx.fillText(this.translation.toUpperCase(), 0, 0); 
                        
                        ctx.restore();
                    }
                }
            }
        }

        class Laser {
            constructor(tx, ty) { this.sx = canvas.width / 2; this.sy = canvas.height - 80; this.tx = tx; this.ty = ty; this.p = 0; this.v = 0.15; this.active = true; }
            update() { this.p += this.v; if (this.p >= 1) { this.active = false; return 'hit'; } return 'active'; }
            draw() {
                if (!this.active) return;
                const cx = this.sx + (this.tx - this.sx) * this.p;
                const cy = this.sy + (this.ty - this.sy) * this.p;

                ctx.beginPath(); ctx.moveTo(this.sx, this.sy); ctx.lineTo(cx, cy);
                ctx.strokeStyle = 'rgba(34, 211, 238, 0.4)'; ctx.lineWidth = 10; ctx.stroke();
                ctx.strokeStyle = '#ffffff'; ctx.lineWidth = 2; ctx.shadowBlur = 10; ctx.shadowColor = '#22d3ee';
                ctx.stroke(); ctx.shadowBlur = 0;
            }
        }

        class Particle {
            constructor(x, y, color) {
                this.x = x; this.y = y;
                const angle = Math.random() * Math.PI * 2;
                const speed = Math.random() * 3 + 2; 
                this.vx = Math.cos(angle) * speed;
                this.vy = Math.sin(angle) * speed;
                
                this.life = 1.0;
                this.color = color;
                this.decay = Math.random() * 0.015 + 0.01; 
                this.gravity = 0.05; 
            }
            update() {
                this.x += this.vx;
                this.y += this.vy;
                this.vy += this.gravity; 
                this.life -= this.decay;
                return this.life > 0;
            }
            draw() {
                ctx.globalAlpha = this.life;
                ctx.fillStyle = this.color;
                ctx.beginPath();
                ctx.arc(this.x, this.y, 2, 0, Math.PI * 2);
                ctx.fill();
                ctx.globalAlpha = 1.0; 
            }
        }

        function generateCity() {
            buildings = [];
            let cx = 0;
            while (cx < canvas.width) {
                const w = Math.random() * 30 + 30;
                const h = Math.random() * 60 + 40;
                const windows = [];
                for (let wy = 5; wy < h - 5; wy += 10) {
                    for (let wx = 5; wx < w - 5; wx += 8) {
                        if (Math.random() > 0.4) windows.push({ x: wx, y: wy });
                    }
                }
                buildings.push({ x: cx, y: canvas.height - 80 - h, w: w, h: h, windows: windows });
                cx += w;
            }
        }

        function drawCity() {
            let shakeX = 0;
            let shakeY = 0;

            if (cityShakeTimer > 0) {
                cityShakeTimer--;
                shakeX = (Math.random() - 0.5) * 10;
                shakeY = (Math.random() - 0.5) * 10;
            }

            let color;
            if (health <= 0) {
                color = '#991b1b';
            } else {
                color = health > 30 ? '#4ade80' : `rgba(239, 68, 68, ${0.5 + Math.sin(frameCount * 0.2) * 0.5})`;
            }

            ctx.globalAlpha = 0.5;
            
            ctx.fillStyle = color;
            ctx.fillRect(0 + shakeX, canvas.height - 80 + shakeY, canvas.width, 80);

            buildings.forEach(b => {
                ctx.fillStyle = color;
                ctx.fillRect(b.x + shakeX, b.y + shakeY, b.w, b.h);
                ctx.fillStyle = 'rgba(0,0,0,0.4)';
                b.windows.forEach(win => {
                    ctx.fillRect(b.x + win.x + shakeX, b.y + win.y + shakeY, 4, 6);
                });
            });

            ctx.globalAlpha = 1.0;
        }

        function startGame() {
            if (animationFrameId) cancelAnimationFrame(animationFrameId);
            sound.init();

            document.body.classList.add('playing-mode');

            document.getElementById('startScreen').classList.add('hidden');
            document.getElementById('gameOverScreen').classList.add('hidden');
            document.getElementById('restartContainer').classList.add('hidden');

            const logContainer = document.getElementById('logContainer');
            logContainer.classList.add('h-64');
            logContainer.classList.remove('h-[60vh]');

            gameState = 'playing';
            score = 0; health = 100; frameCount = 0; difficultyMultiplier = 1.0; 
            meteors = []; lasers = []; particles = [];
            defeatedList.innerHTML = ''; inputElement.value = ''; inputElement.focus();

            document.getElementById('highScoreDisplay').textContent = highScore;

            updateUI(); generateCity(); gameLoop();
        }

        function processInput() {
            const val = inputElement.value.toLowerCase().trim();
            if (!val) return;
            
            const targets = meteors.filter(m => !m.isHit && !m.isDying && m.word === val);
            
            if (targets.length > 0) {
                sound.playLaser(); 
                
                targets.forEach(target => {
                    lasers.push(new Laser(target.x, target.y));
                    
                    target.isHit = true;
                    target.isDying = true;

                    createExplosion(target.x, target.y, '#4ade80');

                    score += target.word.length * 100;
                    addDefeatedWord(target.word, target.translation);

                    if (!wordCollection[target.word]) {
                        wordCollection[target.word] = {
                            en: target.translation,
                            count: 0
                        };
                    }
                    wordCollection[target.word].count++;
                });
                
                localStorage.setItem('finnishWordCollection', JSON.stringify(wordCollection));

                inputElement.value = '';
            } else {
                sound.playError();
                cityShakeTimer = 5;
            }
        }

        function addDefeatedWord(fi, en) {
            const li = document.createElement('li');
            li.innerHTML = `<span class="text-white">${fi}</span> <span class="text-gray-400 text-xs">-> ${en}</span>`;
            defeatedList.prepend(li);
            if (defeatedList.children.length > 20) defeatedList.removeChild(defeatedList.lastChild);
        }

        function takeDamage(amt) {
            health -= amt;
            sound.playExplosion();
            cityShakeTimer = 20;

            if (health <= 0) { health = 0; endGame(); }
            updateUI();
        }

        function updateUI() {
            scoreDisplay.textContent = score;
            healthDisplay.textContent = health + '%';
            healthDisplay.className = health < 30 ? 'text-red-500 animate-pulse font-bold shadow-red-500' : 'text-green-400';
        }

        function createExplosion(x, y, c) { for (let i = 0; i < 30; i++) particles.push(new Particle(x, y, c)); }

        function endGame() {
            gameState = 'gameover';

            document.body.classList.remove('playing-mode');
            
            inputElement.blur();

            if (score > highScore) {
                highScore = score;
                localStorage.setItem('finnishMeteorHighScore', highScore);
            }

            document.getElementById('finalScore').textContent = score;
            document.getElementById('finalHighScore').textContent = highScore;
            document.getElementById('highScoreDisplay').textContent = highScore;

            document.getElementById('gameOverScreen').classList.remove('hidden');

            const logContainer = document.getElementById('logContainer');
            logContainer.classList.remove('h-64');
            logContainer.classList.add('h-[60vh]');

            setTimeout(() => {
                document.getElementById('restartContainer').classList.remove('hidden');
                document.getElementById('restartContainer').classList.add('fade-in');
                gameState = 'waiting_restart';
            }, 1000);
        }

        function gameLoop(timestamp) {
            if (gameState === 'start') return;
            
            if (!lastTime) lastTime = timestamp;
            
            // Debug Update (0.5s interval)
            if (showDebug && timestamp - lastDebugUpdateTime > 500) {
                const currentFPS = Math.round(1000 / (timestamp - lastTime + 0.001));
                debugInfo.innerHTML = `FPS: ${currentFPS}<br>Meteors: ${meteors.length}<br>Particles: ${particles.length}`;
                lastDebugUpdateTime = timestamp;
            }
            lastTime = timestamp;

            ctx.clearRect(0, 0, canvas.width, canvas.height);
            frameCount++;
            drawCity();
            
            if (gameState === 'playing') {
                if (frameCount > 0 && frameCount % 600 === 0) difficultyMultiplier += 0.12;
                let curRate = Math.max(25, Math.floor(spawnRate / difficultyMultiplier));

                if (frameCount % curRate === 0) meteors.push(new Meteor());
                for (let i = meteors.length - 1; i >= 0; i--) {
                    const status = meteors[i].update();
                    meteors[i].draw();
                    
                    if (status === 'destroyed') {
                        meteors.splice(i, 1);
                    }
                    else if (status === 'dying') {
                        if (meteors[i].hitTimer > 180) {
                            meteors.splice(i, 1);
                        }
                    }
                }
                for (let i = lasers.length - 1; i >= 0; i--) {
                    if (lasers[i].update() === 'hit') lasers.splice(i, 1);
                    else lasers[i].draw();
                }
                for (let i = particles.length - 1; i >= 0; i--) {
                    if (!particles[i].update()) particles.splice(i, 1);
                    else particles[i].draw();
                }
            } else {
                meteors.forEach(m => m.draw()); lasers.forEach(l => l.draw()); particles.forEach(p => p.draw());
            }
            animationFrameId = requestAnimationFrame(gameLoop); 
        }

        function parseWordData(data) {
            const list = [];
            Object.values(data).forEach(entry => {
                if (entry.lemma && entry.en) {
                    list.push({ fi: entry.lemma, en: entry.en });
                }
                if (entry.forms && Array.isArray(entry.forms)) {
                    entry.forms.forEach(form => {
                        list.push({ fi: form, en: entry.en });
                    });
                }
            });
            return list;
        }

        async function init() {
            document.title = `Finnish Defense ${GAME_VERSION}`;
            
            const repoUrl = "https://gitlab.com/junichiyamada/finnish-defense"; 
            const issueTitle = encodeURIComponent(`Bug Report ${GAME_VERSION}`);
            const issueUrl = `${repoUrl}/-/issues/new?issue[title]=${issueTitle}`;

            const footer = document.getElementById('globalFooter');
            footer.innerHTML = `
                <a href="https://junichiyamada.gitlab.io/" class="hover:text-cyan-400">HOME</a>
                <span class="mx-1">|</span>
                ${GAME_VERSION} 
                <span class="mx-1">|</span> 
                <a href="${issueUrl}" target="_blank" class="hover:text-cyan-400" title="Report a bug via GitLab">
                    Report Bug
                </a>
            `;

            const loadingText = document.getElementById('loadingText');
            const startText = document.getElementById('startText');

            try {
                const response = await fetch('words.json');
                if (!response.ok) throw new Error("words.json not found");
                const jsonData = await response.json();
                WORD_LIST = parseWordData(jsonData);
                console.log(`Loaded ${WORD_LIST.length} words from words.json`);
            } catch (error) {
                console.warn("Failed to load words.json, using fallback data.", error);
                WORD_LIST = parseWordData(FALLBACK_WORDS);
            }

            loadingText.classList.add('hidden');
            startText.classList.remove('hidden');
            
            if (WORD_LIST.length === 0) {
                WORD_LIST = [{fi: "koti", en: "home"}, {fi: "sisu", en: "guts"}];
            }

            const randomName = 'input_' + Math.random().toString(36).substring(2, 15);
            inputElement.setAttribute('name', randomName);

            const resizeGame = () => {
                const width = window.visualViewport ? window.visualViewport.width : window.innerWidth;
                const height = window.visualViewport ? window.visualViewport.height : window.innerHeight;

                if (Math.abs(height - cachedHeight) < 100 && gameState === 'playing') {
                    return; 
                }
                cachedHeight = height;

                canvas.width = width;
                canvas.height = height;

                document.body.style.height = `${height}px`;
                document.body.style.width = `${width}px`;

                window.scrollTo(0, 0);

                generateCity();
            };

            resizeGame();

            if (window.visualViewport) {
                window.visualViewport.addEventListener('resize', resizeGame);
                window.visualViewport.addEventListener('scroll', () => window.scrollTo(0, 0)); 
            } else {
                window.addEventListener('resize', resizeGame);
            }

            window.addEventListener('click', (e) => {
                if (e.target.closest('button') || e.target.closest('#inputArea') || e.target.closest('#globalFooter')) return;
                
                if (gameState === 'playing') {
                    inputElement.focus();
                }
            });

            // ‰øÆÊ≠£: Alt+D „Ç§„Éô„É≥„Éà„Çí window „Å´ÁßªÂãï
            window.addEventListener('keydown', (e) => {
                // Debug Toggle
                if (e.altKey && e.key.toLowerCase() === 'd') {
                    e.preventDefault(); // „Ç¢„Éâ„É¨„Çπ„Éê„Éº„Å∏„ÅÆ„Éï„Ç©„Éº„Ç´„Çπ„ÇíÈòªÊ≠¢
                    showDebug = !showDebug;
                    debugInfo.style.display = showDebug ? 'block' : 'none';
                    return;
                }

                if (e.key === 'Process' || e.isComposing) {
                    // showWarning("‚ö†Ô∏è TURN OFF JAPANESE IME..."); 
                    // ‚Äª showWarningÈñ¢Êï∞„ÅØ‰∏ã„ÅßÂÆöÁæ©„Åï„Çå„Å¶„ÅÑ„Çã„Åü„ÇÅ„ÄÅ„Åì„Åì„Åß„ÅØÁúÅÁï•„Åô„Çã„ÅãÁßªÂãï„ÅåÂøÖË¶Å
                    // Á∞°Áï•Âåñ„ÅÆ„Åü„ÇÅ„Ç≥„É≥„ÇΩ„Éº„É´„É≠„Ç∞„ÅÆ„Åø
                    console.log("IME Detected");
                    return;
                }

                if (e.key === 'Enter' && gameState === 'waiting_restart') {
                    startGame();
                }
            });

            const warningBox = document.createElement('div');
            warningBox.className = "fixed top-20 left-1/2 -translate-x-1/2 bg-red-600 text-white px-4 py-2 rounded shadow-lg z-[70] hidden font-mono text-center";
            document.body.appendChild(warningBox);
            let warningTimeout;

            function showWarning(message) {
                warningBox.textContent = message;
                warningBox.classList.remove('hidden');
                if (warningTimeout) clearTimeout(warningTimeout);
                warningTimeout = setTimeout(() => {
                    warningBox.classList.add('hidden');
                }, 3000);
            }

            inputElement.addEventListener('keydown', (e) => {
                if (gameState === 'playing') {
                    if (e.key === 'Enter') processInput();
                    sound.playType();
                }
                
                if (gameState === 'playing' && e.code === 'Quote') {
                    const char = e.key.toLowerCase();
                    if (char !== '√§' && char !== '√¶') {
                        console.log("Detected Non-FI layout input on Quote key:", char);
                    }
                }
            });

            inputElement.addEventListener('compositionstart', () => {
                showWarning("‚ö†Ô∏è TURN OFF IME");
            });

            inputElement.addEventListener('input', () => {
                if (gameState !== 'playing') return;
                const val = inputElement.value.toLowerCase().trim();
                if (meteors.find(m => !m.isHit && !m.isDying && m.word === val)) processInput();
            });
            
            document.getElementById('startButton').addEventListener('click', startGame);
            document.getElementById('restartButton').addEventListener('click', startGame);

            const nativeShareBtn = document.getElementById('nativeShareButton');
            if (navigator.share) {
                nativeShareBtn.classList.remove('hidden');
                
                nativeShareBtn.addEventListener('click', async () => {
                    const text = `FINNISH DEFENSE\nSCORE: ${score}\nHIGH SCORE: ${highScore}\nCan you save the city? üá´üáÆ‚òÑÔ∏è`;
                    const url = "https://junichiyamada.gitlab.io/finnish-defense/";
                    
                    try {
                        await navigator.share({
                            title: 'Finnish Defense',
                            text: text,
                            url: url
                        });
                    } catch (err) {
                        console.log('Share canceled');
                    }
                });
            }

            document.getElementById('shareButton').addEventListener('click', () => {
                const text = `FINNISH DEFENSE\nSCORE: ${score}\nHIGH SCORE: ${highScore}\n\nCan you save the city with SISU? üá´üáÆ‚òÑÔ∏è\n`;
                const url = "https://junichiyamada.gitlab.io/finnish-defense/";
                const hashtags = "FinnishDefense,TypingGame,IndieDev";
                const shareUrl = `https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}&url=${encodeURIComponent(url)}&hashtags=${hashtags}`;
                window.open(shareUrl, '_blank');
            });

            document.getElementById('titleButton').addEventListener('click', () => {
                location.reload();
            });
        }
        
        // init„ÇíÂëº„Å≥Âá∫„Åô
        init();
    </script>
</body>

</html>