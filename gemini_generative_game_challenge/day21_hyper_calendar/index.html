<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>JAMAD CALENDAR - v20260128.41</title>
    <style>
        :root {
            --accent: #0f0;
            --bg-panel: rgba(10, 10, 10, 0.9);
            --border: rgba(255, 255, 255, 0.15);
            --text-main: #eee;
            --text-mute: #666;
            --transition: 0.3s;
        }

        /* Base Reset */
        body, html { 
            margin: 0; padding: 0; width: 100%; height: 100%; 
            overflow: hidden; background-color: #000; 
            font-family: 'Inter', 'Noto Sans JP', sans-serif; 
            color: var(--text-main); touch-action: none; 
        }
        canvas { display: block; }

        /* HUD & Labels */
        #ui-layer { position: absolute; inset: 0; pointer-events: none; }
        #matrix-label { 
            position: absolute; top: 40px; left: 40px; 
            font-size: 0.7rem; letter-spacing: 6px; color: var(--text-mute); 
            font-weight: 400; text-transform: uppercase; 
        }

        /* Shared Button Styles */
        .round-btn, .step-btn, .lang-btn {
            background: var(--bg-panel);
            border: 1px solid var(--border);
            color: var(--text-mute);
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: var(--transition);
            backdrop-filter: blur(10px); pointer-events: auto;
            user-select: none; -webkit-user-select: none;
        }
        .round-btn:hover, .step-btn:hover, .lang-btn:hover { 
            border-color: var(--accent); color: var(--accent); 
        }

        /* Specific Button Shapes */
        .round-btn { border-radius: 20px; }
        .step-btn { width: 32px; height: 32px; border-radius: 50%; font-size: 16px; }
        .lang-btn { width: 38px; height: 38px; border-radius: 6px; font-size: 10px; font-weight: 700; }
        .lang-btn.active { border-color: var(--accent); color: var(--accent); background: rgba(0,255,0,0.15); }

        /* Navigation */
        #top-right-nav { position: absolute; top: 40px; right: 40px; display: flex; align-items: center; gap: 20px; pointer-events: auto; }
        #lang-bar { display: flex; gap: 6px; }
        
        #config-trigger { width: 44px; height: 44px; border-radius: 50%; }
        #config-trigger svg { width: 22px; height: 22px; fill: var(--text-mute); transition: var(--transition); }
        #config-trigger:hover svg { fill: var(--accent); transform: rotate(45deg); }

        /* Bottom-Right Controls */
        #today-btn { 
            position: absolute; bottom: 71px; right: 45px; 
            padding: 8px 24px; font-size: 10px; font-weight: 600; 
            letter-spacing: 2px; color: #888; height: 32px; box-sizing: border-box;
        }

        /* Sliders Layout */
        .axis-ui { position: absolute; pointer-events: auto; display: flex; align-items: center; gap: 15px; }
        #x-axis-ui { bottom: 70px; left: 50%; transform: translateX(-50%); width: 33.33vw; min-width: 300px; }
        
        /* Adjusted Y Axis for tight step-btn fit */
        #y-axis-ui { right: 45px; top: 50%; transform: translateY(-50%); height: 33.33vh; min-height: 300px; flex-direction: column; justify-content: space-between; padding: 5px 0; }

        input[type=range].matrix-slider { 
            appearance: none; background: #222; height: 4px; border-radius: 2px; 
            accent-color: var(--accent); cursor: pointer; margin: 0; flex-grow: 1; 
        }
        #slider-y-wrap { flex-grow: 1; position: relative; width: 32px; }
        #slider-y { 
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(90deg); 
            width: calc(33.33vh - 70px); min-width: 230px; 
        }

        /* Config Panel Overlay */
        #config-panel {
            position: absolute; top: 95px; right: 40px; width: 280px; pointer-events: auto;
            background: var(--bg-panel); border: 1px solid var(--border); padding: 25px;
            border-radius: 12px; backdrop-filter: blur(25px); display: none;
            box-shadow: 0 20px 50px rgba(0,0,0,0.6);
        }
        .config-group { margin-bottom: 18px; }
        .config-label { font-size: 9px; color: var(--text-mute); letter-spacing: 1.5px; margin-bottom: 10px; display: block; text-transform: uppercase; }
        .config-val { float: right; color: var(--accent); font-family: monospace; }
        
        input[type=number] { background: #111; border: 1px solid #333; color: #fff; padding: 6px; font-size: 11px; border-radius: 4px; width: 100%; }
        .birthday-inputs { display: flex; gap: 5px; }
        
        /* Toggle Switch */
        .toggle-row { display: flex; justify-content: space-between; align-items: center; margin-top: 5px; }
        .switch { position: relative; display: inline-block; width: 34px; height: 18px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; inset: 0; background-color: #333; transition: .4s; border-radius: 18px; }
        .slider:before { position: absolute; content: ""; height: 12px; width: 12px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--accent); }
        input:checked + .slider:before { transform: translateX(16px); }

        /* Footer */
        footer {
            position: absolute; bottom: 25px; width: 100%; display: flex;
            justify-content: center; align-items: center; gap: 15px;
            font-size: 10px; letter-spacing: 1.5px; color: var(--text-mute);
        }
        footer a { color: var(--text-mute); text-decoration: none; transition: var(--transition); }
        footer a:hover { color: #fff; }
        .dot { color: #222; }

        input[type=range] {
            display: block; width: 100%; margin: 0; padding: 0; box-sizing: border-box;
        }
    </style>
</head>
<body>

    <div id="ui-layer">
        <div id="matrix-label" data-i18n="title">JAMAD CALENDAR // 120 YEARS</div>

        <div id="top-right-nav">
            <div id="lang-bar">
                <div class="lang-btn" data-lang="en">EN</div>
                <div class="lang-btn active" data-lang="ja">JA</div>
                <div class="lang-btn" data-lang="fi">FI</div>
                <div class="lang-btn" data-lang="da">DA</div>
            </div>
            <div id="config-trigger" class="round-btn">
                <svg viewBox="0 0 24 24"><path d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.05.3-.09.63-.09.94s.02.64.07.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/></svg>
            </div>
        </div>

        <div id="today-btn" class="round-btn" data-i18n="today">TODAY</div>

        <div id="x-axis-ui" class="axis-ui">
            <button class="step-btn" id="x-minus">−</button>
            <input type="range" id="slider-x" class="matrix-slider" min="0" max="1000" value="500">
            <button class="step-btn" id="x-plus">+</button>
        </div>
        <div id="y-axis-ui" class="axis-ui">
            <button class="step-btn" id="y-minus">−</button>
            <div id="slider-y-wrap">
                <input type="range" id="slider-y" class="matrix-slider" min="0" max="1000" value="500">
            </div>
            <button class="step-btn" id="y-plus">+</button>
        </div>

        <div id="config-panel">
            <div class="config-group">
                <span class="config-label"><span data-i18n="mag">Magnification</span> <span class="config-val" id="val-zoom">120</span></span>
                <input type="range" id="slider-zoom" min="40" max="150" value="120">
            </div>
            <div class="config-group">
                <span class="config-label" data-i18n="birth">Birthday</span>
                <div class="birthday-inputs">
                    <input type="number" id="birth-y" value="1968" min="1950" max="2070">
                    <input type="number" id="birth-m" value="6" min="1" max="12">
                    <input type="number" id="birth-d" value="19" min="1" max="31">
                </div>
            </div>
            <div class="config-group toggle-row">
                <span class="config-label" style="margin-bottom:0" data-i18n="mask">Life Span Mask</span>
                <label class="switch">
                    <input type="checkbox" id="toggle-mask" checked>
                    <span class="slider"></span>
                </label>
            </div>
        </div>

        <footer>
            <a href="#">HOME</a>
            <span class="dot">|</span>
            <span style="font-family:monospace; opacity:0.4" id="ver-tag">v20260128.41-STABLE</span>
            <span class="dot">|</span>
            <a href="#">BUG REPORT</a>
        </footer>
    </div>
    
    <canvas id="researchCanvas"></canvas>

<script>
/**
 * [DEVELOPMENT NOTES FOR AI ASSISTANTS]
 * CURRENT VERSION: v20260128.41-STABLE
 * 
 * MANDATORY RULES FOR CODE MODIFICATION:
 * 1. NO UNSOLICITED REFACTORING: Do not reorder, clean up, re-indent, or delete code unless explicitly requested. 
 *    Maintain the exact indentation (4 spaces) and spacing found in this file.
 * 2. PINPOINT MODIFICATIONS: Change only the specific lines or functions related to the user's request.
 * 3. MAINTAIN STABLE LOGICS (JAMAD-SPECIFIC):
 *    - [CENTER SNAPPING]: Selected cell center MUST snap precisely to the virtual pointer position (px, py).
 *    - [DRAG-ONLY INTERACTION]: Prohibit hover-follow; movement is exclusive to dragging or slider usage.
 *    - [INDEX-BASED STEPPING]: Stepper buttons MUST calculate next index BEFORE updating coordinates to prevent floating-point drift.
 *    - [BOUNDARY LOCK]: vPointer MUST be clamped within the grid margin limits [settings.margin, size - settings.margin].
 *    - [LEAP YEAR BLACKOUT]: Feb 29th MUST be blacked out (#000) on non-leap years using the isValid check.
 *    - [STEPPER ACCELERATION]: On hold, movement step stays at 1 unit, but time interval shortens exponentially (min 16ms).
 *    - [HIERARCHY UNIFICATION]: Euro languages (FI/DA) put Day on top; JA/EN put Day on bottom.
 *    - [TRADITIONAL JA FORMAT]: Preserve the Era (和暦), Lunar Month, and Great Numerals (大字) logic.
 * 4. AI PROTOCOL: If token limit (approx 1M) is reached, instruct user to start a new chat with the current file.
 * 5. VERSIONING: Always increment CURRENT VERSION using YYYYMMDD.XX format.
 *
 * CHANGELOG:
 * - v20260128.35: Finalized JAMAD CALENDAR Branding. Integrated development protocol.
 * - v20260128.36: Refactored CSS (<style>) for DRY principle and better maintenance.
 * - v20260128.37: Fixed Background Brightness to 50% (0.5) and removed Ambient slider from Config.
 * - v20260128.38: Set Magnification max to 150 and stretched slider bar to panel width.
 * - v20260128.39: Implemented Fibonacci-style acceleration logic for steppers on hold.
 * - v20260128.40: Switched to Time-Interval acceleration (recursive timeout). Step amount is always 1 unit.
 * - v20260128.41: FIXED "Double Click" bug via Index-based stepping. Refined FI layout and Y-axis UI.
 */

const APP_VERSION = "v20260128.41-STABLE";

const MONTH_COLORS = ["#A0C8FF","#B4D2FF","#FFC8DC","#FFB4C8","#B4FFB4","#64DC64","#64C8FF","#3296FF","#FFC864","#FF9632","#C86432","#DCDDFF"];
const SLOT_STARTS = [0, 31, 60, 91, 121, 152, 182, 213, 244, 274, 305, 335, 366];

const I18N = {
    en: { title: "JAMAD CALENDAR // 120 YEARS", today: "TODAY", mag: "Magnification", birth: "Birthday", mask: "Life Span Mask" },
    ja: { title: "JAMAD CALENDAR // 120年", today: "今日", mag: "倍率", birth: "誕生日", mask: "ライフスパン・マスク" },
    fi: { title: "JAMAD CALENDAR // 120 VUOTTA", today: "TÄNÄÄN", mag: "Suurennus", birth: "Syntymäaika", mask: "Elinkaaren maski" },
    da: { title: "JAMAD CALENDAR // 120 ÅR", today: "I DAG", mag: "Forstørrelse", birth: "Fødselsdag", mask: "Levetid Maske" }
};

const JA_ERAS = [{ name: "令和", start: 2019 },{ name: "平成", start: 1989 },{ name: "昭和", start: 1926 },{ name: "大正", start: 1912 },{ name: "明治", start: 1868 }];
const JA_LUNAR_MONTHS = ["睦月","如月","弥生","卯月","皐月","水無月","文月","葉月","長月","神無月","霜月","師走"];
const KANJI_DIGITS = ["零","壱","弐","参","肆","伍","陸","漆","捌","玖"];

class ResearchApp {
    constructor() {
        this.canvas = document.getElementById('researchCanvas');
        this.ctx = this.canvas.getContext('2d', { alpha: false });
        this.settings = { zoom: 120, bgAlpha: 0.5, loupeSize: 380, margin: 100, birthY: 1968, birthM: 6, birthD: 19, maskEnabled: true, lang: 'ja' };
        this.vPointer = { x: 0, y: 0 };
        this.isDragging = false; this.lastMousePos = { x: 0, y: 0 };
        this.stepTimeout = null;
        this.holdCount = 0;
        this.resize(); this.initEvents(); this.updateI18n(); this.jumpToDate(new Date()); this.loop();
    }

    isLeapYear(y) { return (y % 4 === 0 && y % 100 !== 0) || (y % 400 === 0); }

    initEvents() {
        window.addEventListener('resize', () => { this.resize(); this.syncSliders(); });
        const handleStart = (e) => { 
            if(e.target.tagName === 'CANVAS') {
                this.isDragging = true;
                const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                this.lastMousePos = { x: clientX, y: clientY };
            }
        };
        const handleMove = (e) => {
            if (!this.isDragging) return;
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            this.vPointer.x = Math.max(this.settings.margin, Math.min(this.width - this.settings.margin, this.vPointer.x + (clientX - this.lastMousePos.x)));
            this.vPointer.y = Math.max(this.settings.margin, Math.min(this.height - this.settings.margin, this.vPointer.y + (clientY - this.lastMousePos.y)));
            this.lastMousePos = { x: clientX, y: clientY }; this.syncSliders();
        };
        const handleEnd = () => { this.isDragging = false; };
        window.addEventListener('mousedown', handleStart); window.addEventListener('mousemove', handleMove); window.addEventListener('mouseup', handleEnd);
        window.addEventListener('touchstart', handleStart, { passive: false }); window.addEventListener('touchmove', handleMove, { passive: false }); window.addEventListener('touchend', handleEnd);

        document.getElementById('slider-x').oninput = (e) => { 
            const gw = this.width - this.settings.margin * 2;
            this.vPointer.x = this.settings.margin + (e.target.value / 1000) * gw; 
        };
        document.getElementById('slider-y').oninput = (e) => { 
            const gh = this.height - this.settings.margin * 2;
            this.vPointer.y = this.settings.margin + (e.target.value / 1000) * gh; 
        };

        this.setupStepper('x-minus', -1, 'x'); this.setupStepper('x-plus', 1, 'x');
        this.setupStepper('y-minus', -1, 'y'); this.setupStepper('y-plus', 1, 'y');

        document.getElementById('config-trigger').onclick = (e) => { e.stopPropagation(); const p = document.getElementById('config-panel'); p.style.display = p.style.display === 'block' ? 'none' : 'block'; };
        document.getElementById('today-btn').onclick = () => this.jumpToDate(new Date());
        window.onclick = () => { document.getElementById('config-panel').style.display = 'none'; };
        document.getElementById('config-panel').onclick = (e) => e.stopPropagation();

        document.querySelectorAll('.lang-btn').forEach(btn => {
            btn.onclick = () => {
                this.settings.lang = btn.dataset.lang;
                document.querySelectorAll('.lang-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active'); this.updateI18n();
            };
        });
        document.getElementById('slider-zoom').oninput = (e) => { this.settings.zoom = parseInt(e.target.value); document.getElementById('val-zoom').textContent = e.target.value; };
        document.getElementById('birth-y').onchange = (e) => this.settings.birthY = parseInt(e.target.value);
        document.getElementById('birth-m').onchange = (e) => this.settings.birthM = parseInt(e.target.value);
        document.getElementById('birth-d').onchange = (e) => this.settings.birthD = parseInt(e.target.value);
        document.getElementById('toggle-mask').onchange = (e) => this.settings.maskEnabled = e.target.checked;

        window.addEventListener('keydown', e => { if(e.key === 'Shift') this.speedIdx = (this.speedIdx + 1) % 3; });
    }

    setupStepper(id, dir, axis) {
        const el = document.getElementById(id);
        const onStart = (e) => {
            e.preventDefault(); this.holdCount = 0;
            this.recursiveStep(dir, axis);
        };
        const onEnd = () => { clearTimeout(this.stepTimeout); this.holdCount = 0; };
        el.addEventListener('mousedown', onStart); el.addEventListener('touchstart', onStart, {passive: false});
        window.addEventListener('mouseup', onEnd); window.addEventListener('touchend', onEnd); el.addEventListener('mouseleave', onEnd);
    }

    recursiveStep(dir, axis) {
        this.executeIndexStep(dir, axis);
        this.holdCount++;
        const delay = Math.max(16, 400 * Math.pow(0.8, this.holdCount));
        this.stepTimeout = setTimeout(() => this.recursiveStep(dir, axis), delay);
    }

    // FIX: Index-based stepping to prevent floating-point "double-click" year bugs
    executeIndexStep(dir, axis) {
        const margin = this.settings.margin;
        const gridW = this.width - margin * 2;
        const gridH = this.height - margin * 2;
        const cellW = gridW / 366;
        const cellH = gridH / 120;

        if (axis === 'x') {
            let currentIdx = Math.floor((this.vPointer.x - margin) / cellW);
            let nextIdx = Math.max(0, Math.min(365, currentIdx + dir));
            this.vPointer.x = margin + (nextIdx + 0.5) * cellW;
        } else {
            let currentIdx = Math.floor((this.vPointer.y - margin) / cellH);
            let nextIdx = Math.max(0, Math.min(119, currentIdx + dir));
            this.vPointer.y = margin + (nextIdx + 0.5) * cellH;
        }
        this.syncSliders();
    }

    syncSliders() {
        const gw = this.width - this.settings.margin * 2;
        const gh = this.height - this.settings.margin * 2;
        document.getElementById('slider-x').value = ((this.vPointer.x - this.settings.margin) / gw) * 1000;
        document.getElementById('slider-y').value = ((this.vPointer.y - this.settings.margin) / gh) * 1000;
    }

    updateI18n() {
        const langData = I18N[this.settings.lang];
        document.querySelectorAll('[data-i18n]').forEach(el => { el.textContent = langData[el.dataset.i18n]; });
    }

    toKanjiNumber(n) {
        if (n < 10) return KANJI_DIGITS[n];
        if (n === 10) return "拾";
        if (n < 20) return "拾" + KANJI_DIGITS[n % 10];
        if (n === 20) return "弐拾";
        if (n < 30) return "弐拾" + KANJI_DIGITS[n % 10];
        return "参拾" + (n > 30 ? KANJI_DIGITS[n % 10] : "");
    }

    getJaEra(y) {
        const era = JA_ERAS.find(e => y >= e.start);
        const eraYear = y - era.start + 1;
        return era.name + (eraYear === 1 ? "元" : this.toKanjiNumber(eraYear)) + "年";
    }

    getFormattedDateParts(y, m, d) {
        const months = {
            en: ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'],
            fi: ['tammikuuta','helmikuuta','maaliskuuta','huhtikuuta','toukokuuta','kesäkuuta','heinäkuuta','elokuuta','syyskuuta','lokakuuta','marraskuuta','joulukuuta'],
            da: ['januar','februar','marts','april','maj','juni','juli','august','september','oktober','november','december']
        };
        if(this.settings.lang === 'ja') return [this.getJaEra(y), JA_LUNAR_MONTHS[m-1], this.toKanjiNumber(d) + "日"];
        const mStr = months[this.settings.lang][m-1], dStr = (this.settings.lang === 'fi' || this.settings.lang === 'da') ? d + "." : d.toString();
        if(this.settings.lang === 'fi' || this.settings.lang === 'da') return [dStr, mStr, y.toString()];
        return [y.toString(), mStr, dStr];
    }

    jumpToDate(date) {
        const yIdx = date.getFullYear() - 1950, startOfYear = new Date(date.getFullYear(), 0, 1);
        const dIdx = Math.floor((date - startOfYear) / 86400000);
        const gw = this.width - 200, gh = this.height - 200;
        this.vPointer.x = this.settings.margin + ((dIdx + 0.5) / 366) * gw;
        this.vPointer.y = this.settings.margin + ((yIdx + 0.5) / 120) * gh;
        this.syncSliders();
    }

    resize() {
        const dpr = window.devicePixelRatio || 1;
        this.width = window.innerWidth; this.height = window.innerHeight;
        this.canvas.width = this.width * dpr; this.canvas.height = this.height * dpr;
        this.ctx.scale(dpr, dpr); this.settings.margin = 100;
    }

    getDateInfo(yIdx, dIdx) {
        let m = 0; for(let i=11; i>=0; i--) { if(dIdx >= SLOT_STARTS[i]) { m = i; break; } }
        const year = 1950 + yIdx, day = dIdx - SLOT_STARTS[m] + 1;
        const monthMax = [31, this.isLeapYear(year) ? 29 : 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31][m];
        return { year, month: m + 1, day, isValid: day <= monthMax };
    }

    loop() { this.draw(); requestAnimationFrame(() => this.loop()); }

    draw() {
        const { ctx, width, height, settings } = this;
        const margin = settings.margin, gridW = width - margin * 2, gridH = height - margin * 2;
        const cellW = gridW / 366, cellH = gridH / 120;
        ctx.fillStyle = "#000"; ctx.fillRect(0, 0, width, height);
        if (gridW <= 0 || gridH <= 0) return;

        const now = new Date(), todayIdxT = (now.getFullYear() - 1950) * 366 + Math.floor((now - new Date(now.getFullYear(),0,1))/86400000);
        const birthIdxT = (settings.birthY - 1950) * 366 + SLOT_STARTS[settings.birthM - 1] + (settings.birthD - 1);

        ctx.save(); ctx.translate(margin, margin);
        for (let y = 0; y < 120; y++) {
            const py = y * cellH, isYLeap = this.isLeapYear(1950+y);
            for (let m = 0; m < 12; m++) {
                const startD = SLOT_STARTS[m], realDays = [31, isYLeap ? 29 : 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31][m];
                for (let s = 0; s < (SLOT_STARTS[m+1] - startD); s++) {
                    const slotIdx = startD + s, isValid = (s < realDays);
                    const isAlive = !settings.maskEnabled || (y * 366 + slotIdx >= birthIdxT && y * 366 + slotIdx <= todayIdxT);
                    ctx.fillStyle = isValid ? MONTH_COLORS[m] : "#000";
                    ctx.globalAlpha = isValid ? (isAlive ? settings.bgAlpha : settings.bgAlpha * 0.1) : 1.0;
                    ctx.fillRect(slotIdx * cellW, py, cellW, cellH - 0.2);
                }
            }
            ctx.fillStyle = "rgba(255,255,255,0.2)"; ctx.fillRect(0, py + cellH - 0.5, gridW, 0.5);
        }
        ctx.restore();

        const px = this.vPointer.x, py = this.vPointer.y;
        const focusD = Math.floor(Math.max(0, Math.min(365, (px - margin) / cellW))), focusY = Math.floor(Math.max(0, Math.min(119, (py - margin) / cellH)));
        const info = this.getDateInfo(focusY, focusD), activeColor = info.isValid ? MONTH_COLORS[info.month - 1] : "#222";

        ctx.save();
        ctx.beginPath(); ctx.arc(px, py, settings.loupeSize / 2, 0, Math.PI * 2); ctx.clip();
        ctx.fillStyle = "#080808"; ctx.fillRect(px - settings.loupeSize, py - settings.loupeSize, settings.loupeSize*2, settings.loupeSize*2);

        const zoom = settings.zoom, range = Math.ceil(settings.loupeSize / zoom) + 1, isEuro = (settings.lang === 'fi' || settings.lang === 'da');
        for (let y = focusY - range; y <= focusY + range; y++) {
            if (y < 0 || y >= 120) continue;
            for (let d = focusD - range; d <= focusD + range; d++) {
                if (d < 0 || d >= 366) continue;
                const dInf = this.getDateInfo(y, d), dx = px + (d - focusD) * zoom - zoom/2, dy = py + (y - focusY) * zoom - zoom/2;
                const isT = (y === focusY && d === focusD), isC = (d === focusD || y === focusY);
                const isA = !settings.maskEnabled || (y * 366 + d >= birthIdxT && y * 366 + d <= todayIdxT);
                if (!dInf.isValid) { ctx.fillStyle = "#000"; ctx.globalAlpha = 1.0; ctx.fillRect(dx + 2, dy + 2, zoom - 4, zoom - 4); }
                else {
                    ctx.fillStyle = MONTH_COLORS[dInf.month - 1]; ctx.globalAlpha = isA ? (isT ? 1.0 : 0.25) : 0.05;
                    ctx.fillRect(dx + 2, dy + 2, zoom - 4, zoom - 4);
                    if (isT) {
                        ctx.textAlign = "center"; ctx.textBaseline = "middle"; ctx.fillStyle = isA ? "#000" : "#fff"; ctx.globalAlpha = isA ? 1.0 : 0.4;
                        const pt = this.getFormattedDateParts(dInf.year, dInf.month, dInf.day);
                        if(isEuro) {
                            ctx.font = `bold ${zoom * 0.23}px Arial`; ctx.fillText(pt[0], px, py - zoom*0.20);
                            ctx.font = `bold ${zoom * 0.13}px Arial`; ctx.fillText(pt[1], px, py + zoom*0.06);
                            ctx.font = `bold ${zoom * 0.11}px Arial`; ctx.fillText(pt[2], px, py + zoom*0.28);
                        } else {
                            ctx.font = `bold ${zoom * 0.11}px Arial`; ctx.fillText(pt[0], px, py - zoom*0.27);
                            ctx.font = `bold ${zoom * 0.13}px Arial`; ctx.fillText(pt[1], px, py - zoom*0.06);
                            ctx.font = `bold ${zoom * (settings.lang==='ja'?0.23:0.28)}px Arial`; ctx.fillText(pt[2], px, py + zoom*0.26);
                        }
                    } else if (isC) {
                        ctx.fillStyle = "#fff"; ctx.globalAlpha = isA ? 0.4 : 0.2; ctx.textAlign = "center"; ctx.textBaseline = "middle"; ctx.font = `bold ${zoom * 0.15}px Arial`;
                        let l = d === focusD ? (settings.lang === 'ja' ? this.getJaEra(dInf.year) : dInf.year) : (settings.lang === 'ja' ? this.toKanjiNumber(dInf.day) : dInf.day);
                        ctx.fillText(l, dx + zoom/2, dy + zoom/2);
                    }
                }
            }
        }
        ctx.restore();
        ctx.strokeStyle = activeColor; ctx.lineWidth = 2.5;
        ctx.beginPath(); ctx.arc(px, py, settings.loupeSize / 2, 0, Math.PI * 2); ctx.stroke();
    }
}
window.onload = () => new ResearchApp();
</script>
</body>
</html>