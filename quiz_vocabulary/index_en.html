<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <title>English Vocabulary Quiz</title>

    <style>
        body {
            font-family: system-ui, sans-serif;
            background: #121212;
            color: #e0e0e0;
            padding: 20px;
        }

        h2 {
            margin-bottom: 6px;
            color: #fff;
        }

        #progress-text {
            color: #aaa;
            margin-bottom: 4px;
        }

        #progress-track {
            font-family: monospace;
            font-size: 1.2em;
            letter-spacing: 4px;
            margin-bottom: 16px;
        }

        #question {
            font-size: 1.2em;
            margin-bottom: 16px;
        }

        #choices {
            display: flex;
            flex-direction: column;
            align-items: stretch;
        }

        #choices button {
            text-align: left;
            margin: 6px 0;
        }

        button {
            background: #1f1f1f;
            color: #e0e0e0;
            border: 1px solid #333;
            border-radius: 6px;
            padding: 10px 14px;
            cursor: pointer;
        }

        button:hover {
            background: #2a2a2a;
        }

        #result {
            margin-top: 10px;
            font-weight: bold;
        }

        .correct {
            color: #4caf50;
        }

        .wrong {
            color: #ff6b6b;
        }

        .result-list {
            margin-top: 16px;
        }

        .word-chip {
            display: inline-block;
            background: #1f1f1f;
            border: 1px solid #333;
            border-radius: 6px;
            padding: 6px 10px;
            margin: 4px;
            font-size: 0.9em;
        }
    </style>
</head>

<body>

    <h2>Ëã±Ë™û„ÇØ„Ç§„Ç∫</h2>
    <div id="progress-text"></div>
    <div id="progress-track"></div>

    <div id="question">Loading...</div>
    <div id="choices"></div>
    <div id="result"></div>

    <button id="issue-btn" onclick="markIssue()">‚ö† ÂïèÈ°å„ÅÇ„Çä</button>

    <script>
        /* =====================
           Ë®≠ÂÆö
        ===================== */
        const TOTAL = 10;
        const STATS_KEY = "quizStats_en";
        const ISSUE_KEY = "quizIssues";

        /* =====================
           Áä∂ÊÖã
        ===================== */
        let entries = [];
        let current = null;
        let index = 0;

        const track = Array(TOTAL).fill("*");
        const correctList = [];
        const wrongList = [];
        const issueList = [];
        const skipped = new Set();

        /* =====================
           ÂàùÊúüÂåñ
        ===================== */
        fetch("concepts.json")
            .then(r => r.json())
            .then(data => {
                entries = Object.values(data).filter(e => e.en && e.ja);
                next();
            });

        /* =====================
           ÂÖ±ÈÄöÂá¶ÁêÜ
        ===================== */
        const $ = id => document.getElementById(id);
        const shuffle = a => a.sort(() => Math.random() - 0.5);

        const load = k => JSON.parse(localStorage.getItem(k) || "{}");
        const save = (k, v) => localStorage.setItem(k, JSON.stringify(v));

        function updateProgress() {
            $("progress-text").textContent =
                `ÂïèÈ°å ${index + 1} / ${TOTAL}`;
            $("progress-track").textContent = track.join("");
        }

        function clearResult() {
            $("result").textContent = "";
            $("result").className = "";
        }

        /* =====================
           Âá∫È°å
        ===================== */
        function next() {
            if (index >= TOTAL) {
                finish();
                return;
            }

            do {
                current = entries[Math.floor(Math.random() * entries.length)];
            } while (skipped.has(current.id));

            updateProgress();
            clearResult();

            $("question").textContent =
                `„Äå${current.ja}„Äç„ÅÆËã±Ë™û„ÅØ„Å©„ÇåÔºü`;

            const options = shuffle(
                entries.map(e => e.en)
            ).slice(0, 4);

            if (!options.includes(current.en)) {
                options[0] = current.en;
                shuffle(options);
            }

            const c = $("choices");
            c.innerHTML = "";

            options.forEach(word => {
                const b = document.createElement("button");
                b.textContent = word;
                b.onclick = () => answer(word);
                c.appendChild(b);
            });
        }

        /* =====================
           ÂõûÁ≠î
        ===================== */
        function answer(word) {
            const stats = load(STATS_KEY);
            stats[current.id] ??= { correct: 0, wrong: 0 };

            if (word === current.en) {
                track[index] = "O";
                stats[current.id].correct++;
                correctList.push(current);

                $("result").textContent = "Ê≠£Ëß£ÔºÅ";
                $("result").className = "correct";

                save(STATS_KEY, stats);
                index++;
                setTimeout(next, 1000);

            } else {
                track[index] = "X";
                stats[current.id].wrong++;
                wrongList.push(current);

                $("result").textContent = `‰∏çÊ≠£Ëß£‚Ä¶ Ê≠£Ëß£„ÅØ„Äå${current.en}„Äç`;
                $("result").className = "wrong";

                save(STATS_KEY, stats);
                index++;
                setTimeout(next, 2000);
            }
        }

        /* =====================
           ÂïèÈ°å„ÅÇ„Çä
        ===================== */
        function markIssue() {
            skipped.add(current.id);
            issueList.push(current);

            const issues = load(ISSUE_KEY);
            issues[current.id] ??= { count: 0 };
            issues[current.id].count++;

            save(ISSUE_KEY, issues);
            index++;
            next();
        }

        /* =====================
           ÁµÇ‰∫Ü
        ===================== */
        function finish() {
            $("progress-text").textContent = "";
            $("question").innerHTML = "<h3>üéâ „Çª„ÉÉ„Ç∑„Éß„É≥ÁµÇ‰∫Ü</h3>";
            $("choices").innerHTML = "";
            $("result").textContent = "";
            $("issue-btn").style.display = "none";

            $("progress-track").textContent = track.join("");

            let html = "";

            html += `<div class="result-list"><strong>‚úî Ê≠£Ëß£„Åó„ÅüÂçòË™û</strong><div>`;
            correctList.forEach(e => {
                html += `<span class="word-chip">${e.en}</span>`;
            });
            html += `</div></div>`;

            if (wrongList.length) {
                html += `<div class="result-list"><strong>‚ùå ÈñìÈÅï„Åà„ÅüÂçòË™û</strong><ul>`;
                wrongList.forEach(e => {
                    html += `<li>${e.en}</li>`;
                });
                html += `</ul></div>`;
            }

            if (issueList.length) {
                html += `<div class="result-list"><strong>‚ö† ÂïèÈ°å„ÅÇ„Çä</strong><div>`;
                issueList.forEach(e => {
                    html += `<span class="word-chip">${e.en}</span>`;
                });
                html += `</div></div>`;
            }

            $("question").insertAdjacentHTML("beforeend", html);
        }
    </script>

</body>

</html>