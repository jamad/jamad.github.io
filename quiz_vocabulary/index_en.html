<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8" />
    <title>English Vocabulary Quiz</title>

    <style>
        body {
            font-family: system-ui, sans-serif;
            background: #121212;
            color: #e0e0e0;
            padding: 20px;
        }

        h2 {
            color: #fff;
        }

        #progress {
            margin-bottom: 12px;
            font-family: monospace;
            letter-spacing: 2px;
            color: #aaa;
        }

        #question {
            font-size: 1.2em;
            margin-bottom: 16px;
        }

        #choices {
            display: flex;
            flex-direction: column;
            align-items: stretch;
        }

        #choices button {
            text-align: left;
            margin: 6px 0;
        }

        button {
            background: #1f1f1f;
            color: #e0e0e0;
            border: 1px solid #333;
            border-radius: 6px;
            padding: 10px 14px;
            cursor: pointer;
        }

        button:hover {
            background: #2a2a2a;
        }

        #result {
            margin-top: 10px;
            font-weight: bold;
        }

        .correct {
            color: #4caf50;
        }

        .wrong {
            color: #ff6b6b;
        }

        .result-list {
            margin-top: 16px;
        }

        .word-chip {
            display: inline-block;
            background: #1f1f1f;
            border: 1px solid #333;
            border-radius: 6px;
            padding: 6px 10px;
            margin: 4px;
            font-size: 0.9em;
        }
    </style>
</head>

<body>

    <h2>Ëã±Ë™û„ÇØ„Ç§„Ç∫</h2>

    <div id="progress"></div>
    <div id="question">Loading...</div>
    <div id="choices"></div>
    <div id="result"></div>

    <button onclick="markIssue()">‚ö† ÂïèÈ°å„ÅÇ„Çä</button>

    <script>
        /* =========================
           Ë®≠ÂÆö
        ========================= */
        const TOTAL_QUESTIONS = 10;
        const STATS_KEY = "quizStats_en";
        const ISSUE_KEY = "quizIssues";

        /* =========================
           Áä∂ÊÖã
        ========================= */
        let entries = [];
        let current = null;
        let questionIndex = 0;

        let answerTrack = Array(TOTAL_QUESTIONS).fill("*");
        let sessionCorrect = [];
        let sessionWrong = [];
        let sessionIssues = [];
        let skippedIds = new Set();

        /* =========================
           ÂàùÊúüÂåñ
        ========================= */
        fetch("concepts.json")
            .then(r => r.json())
            .then(data => {
                entries = Object.values(data).filter(e => e.en && e.ja);
                nextQuestion();
            });

        /* =========================
           „É¶„Éº„ÉÜ„Ç£„É™„ÉÜ„Ç£
        ========================= */
        const shuffle = arr => arr.sort(() => Math.random() - 0.5);

        const loadJSON = key =>
            JSON.parse(localStorage.getItem(key) || "{}");

        const saveJSON = (key, value) =>
            localStorage.setItem(key, JSON.stringify(value));

        /* =========================
           UIÊõ¥Êñ∞
        ========================= */
        function updateProgress() {
            const track = answerTrack.join("");
            document.getElementById("progress").textContent =
                `ÂïèÈ°å ${questionIndex + 1} / ${TOTAL_QUESTIONS}  ${track}`;
        }

        function clearResult() {
            const r = document.getElementById("result");
            r.textContent = "";
            r.className = "";
        }

        /* =========================
           Âá∫È°å
        ========================= */
        function nextQuestion() {
            if (questionIndex >= TOTAL_QUESTIONS) {
                showEndScreen();
                return;
            }

            do {
                current = entries[Math.floor(Math.random() * entries.length)];
            } while (skippedIds.has(current.id));

            updateProgress();
            clearResult();

            document.getElementById("question").textContent =
                `„Äå${current.ja}„Äç„ÅÆËã±Ë™û„ÅØ„Å©„ÇåÔºü`;

            const choices = shuffle(
                entries.map(e => e.en)
            ).slice(0, 4);

            if (!choices.includes(current.en)) {
                choices[0] = current.en;
                shuffle(choices);
            }

            const c = document.getElementById("choices");
            c.innerHTML = "";

            choices.forEach(word => {
                const btn = document.createElement("button");
                btn.textContent = word;
                btn.onclick = () => checkAnswer(word);
                c.appendChild(btn);
            });
        }

        /* =========================
           ÂõûÁ≠îÂá¶ÁêÜ
        ========================= */
        function checkAnswer(answer) {
            const r = document.getElementById("result");
            const stats = loadJSON(STATS_KEY);
            const idx = questionIndex;

            stats[current.id] ??= { correct: 0, wrong: 0 };

            if (answer === current.en) {
                answerTrack[idx] = "O";
                stats[current.id].correct++;
                sessionCorrect.push(current);

                r.textContent = "Ê≠£Ëß£ÔºÅ";
                r.className = "correct";

                saveJSON(STATS_KEY, stats);

                questionIndex++;
                setTimeout(nextQuestion, 1000);

            } else {
                answerTrack[idx] = "X";
                stats[current.id].wrong++;
                sessionWrong.push(current);

                r.textContent = `‰∏çÊ≠£Ëß£‚Ä¶ Ê≠£Ëß£„ÅØ„Äå${current.en}„Äç`;
                r.className = "wrong";

                saveJSON(STATS_KEY, stats);

                questionIndex++;
                setTimeout(nextQuestion, 2000);
            }
        }

        /* =========================
           ÂïèÈ°å„ÅÇ„Çä
        ========================= */
        function markIssue() {
            skippedIds.add(current.id);
            sessionIssues.push(current);

            const issues = loadJSON(ISSUE_KEY);
            issues[current.id] ??= { count: 0 };
            issues[current.id].count++;

            saveJSON(ISSUE_KEY, issues);

            questionIndex++;
            nextQuestion();
        }

        /* =========================
           ÁµÇ‰∫ÜÁîªÈù¢
        ========================= */
        function showEndScreen() {
            document.getElementById("progress").textContent = "";
            document.getElementById("choices").innerHTML = "";
            document.getElementById("result").textContent = "";

            let html = `<h3>üéâ „Çª„ÉÉ„Ç∑„Éß„É≥ÁµÇ‰∫Ü</h3>`;
            html += `<p style="font-size:1.2em; letter-spacing:2px;">
            ${answerTrack.join("")}
           </p>`;

            html += `<div class="result-list"><strong>‚úî Ê≠£Ëß£„Åó„ÅüÂçòË™û</strong><div>`;
            sessionCorrect.forEach(e => {
                html += `<span class="word-chip">${e.en}</span>`;
            });
            html += `</div></div>`;

            if (sessionWrong.length) {
                html += `<div class="result-list"><strong>‚ùå ÈñìÈÅï„Åà„ÅüÂçòË™û</strong><ul>`;
                sessionWrong.forEach(e => {
                    html += `<li>${e.en}</li>`;
                });
                html += `</ul></div>`;
            }

            if (sessionIssues.length) {
                html += `<div class="result-list"><strong>‚ö† ÂïèÈ°å„ÅÇ„Çä</strong><div>`;
                sessionIssues.forEach(e => {
                    html += `<span class="word-chip">${e.en}</span>`;
                });
                html += `</div></div>`;
            }

            document.getElementById("question").innerHTML = html;
        }
    </script>

</body>

</html>