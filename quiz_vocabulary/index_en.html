<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <title>English Vocabulary Quiz</title>

    <style>
        body {
            font-family: system-ui, sans-serif;
            background: #121212;
            color: #e0e0e0;
            padding: 20px;
        }

        h2 {
            color: #fff;
        }

        #progress {
            margin-bottom: 10px;
            color: #aaa;
        }

        #question {
            font-size: 1.2em;
            margin-bottom: 15px;
        }

        button {
            background: #1f1f1f;
            color: #e0e0e0;
            border: 1px solid #333;
            border-radius: 6px;
            padding: 10px 16px;
            margin: 6px 4px;
            cursor: pointer;
        }

        button:hover {
            background: #2a2a2a;
        }

        .correct {
            color: #4caf50;
            font-weight: bold;
        }

        .wrong {
            color: #ff6b6b;
            font-weight: bold;
        }

        .result-list {
            margin-top: 15px;
        }

        .word-chip {
            display: inline-block;
            background: #1f1f1f;
            border: 1px solid #333;
            border-radius: 6px;
            padding: 6px 10px;
            margin: 4px;
            font-size: 0.9em;
        }
    </style>
</head>

<body>

    <h2>Ëã±Ë™û„ÇØ„Ç§„Ç∫</h2>

    <div id="progress"></div>
    <div id="question">Loading...</div>
    <div id="choices"></div>
    <p id="result"></p>

    <button id="issueBtn" onclick="markIssue()">‚ö† ÂïèÈ°å„ÅÇ„Çä</button>

    <script>
        const TOTAL_QUESTIONS = 10;
        const STATS_KEY = "quizStats_en";
        const ISSUE_KEY = "quizIssues";

        let entries = [];
        let current = null;
        let questionCount = 0;
        let skippedIds = new Set();

        let sessionCorrect = [];
        let sessionWrong = [];

        fetch("concepts.json")
            .then(r => r.json())
            .then(data => {
                entries = Object.values(data).filter(e => e.en && e.ja);
                nextQuestion();
            });

        function shuffle(a) {
            return a.sort(() => Math.random() - 0.5);
        }

        function nextQuestion() {
            if (questionCount >= TOTAL_QUESTIONS) {
                showEndScreen();
                return;
            }

            let candidate;
            do {
                candidate = entries[Math.floor(Math.random() * entries.length)];
            } while (skippedIds.has(candidate.id));

            current = candidate;
            questionCount++;

            document.getElementById("progress").textContent =
                `ÂïèÈ°å ${questionCount} / ${TOTAL_QUESTIONS}`;

            document.getElementById("result").textContent = "";
            document.getElementById("question").textContent =
                `„Äå${current.ja}„Äç„ÅÆËã±Ë™û„ÅØ„Å©„ÇåÔºü`;

            let choices = shuffle(entries.map(e => e.en)).slice(0, 4);
            if (!choices.includes(current.en)) {
                choices[0] = current.en;
                shuffle(choices);
            }

            const c = document.getElementById("choices");
            c.innerHTML = "";

            choices.forEach(word => {
                const b = document.createElement("button");
                b.textContent = word;
                b.onclick = () => checkAnswer(word);
                c.appendChild(b);
            });
        }

        function checkAnswer(answer) {
            const r = document.getElementById("result");
            const stats = loadStats();
            stats[current.id] ??= { correct: 0, wrong: 0 };

            if (answer === current.en) {
                r.textContent = "Ê≠£Ëß£ÔºÅ";
                r.className = "correct";
                stats[current.id].correct++;
                sessionCorrect.push(current);
                saveStats(stats);

                // ‚òÖ Ê≠£Ëß£„ÅØ1ÁßíÂæå„Å´Ëá™ÂãïÈÅ∑Áßª
                setTimeout(nextQuestion, 1000);
            } else {
                r.textContent = `‰∏çÊ≠£Ëß£‚Ä¶ Ê≠£Ëß£„ÅØ„Äå${current.en}„Äç`;
                r.className = "wrong";
                stats[current.id].wrong++;
                sessionWrong.push(current);
                saveStats(stats);

                // ‚òÖ ‰∏çÊ≠£Ëß£„ÅØ2ÁßíÂæå„Å´ÈÄ≤„ÇÄ
                setTimeout(nextQuestion, 2000);
            }
        }

        function markIssue() {
            skippedIds.add(current.id);
            const issues = JSON.parse(localStorage.getItem(ISSUE_KEY) || "{}");
            issues[current.id] ??= { count: 0 };
            issues[current.id].count++;
            localStorage.setItem(ISSUE_KEY, JSON.stringify(issues));
            nextQuestion();
        }

        function showEndScreen() {
            document.getElementById("progress").textContent = "";
            document.getElementById("choices").innerHTML = "";
            document.getElementById("result").textContent = "";
            document.getElementById("issueBtn").style.display = "none";

            let html = `<h3>üéâ „Çª„ÉÉ„Ç∑„Éß„É≥ÁµÇ‰∫Ü</h3>`;
            html += `<p>Ê≠£Ëß£ ${sessionCorrect.length} / ${TOTAL_QUESTIONS}</p>`;

            html += `<div class="result-list"><strong>‚úî Ê≠£Ëß£„Åó„ÅüÂçòË™û</strong><div>`;
            sessionCorrect.forEach(e => {
                html += `<span class="word-chip">${e.ja} ‚Üí ${e.en}</span>`;
            });
            html += `</div></div>`;

            html += `<div class="result-list"><strong>‚ùå ÈñìÈÅï„Åà„ÅüÂçòË™û</strong><ul>`;
            sessionWrong.forEach(e => {
                html += `<li>${e.ja} ‚Üí ${e.en}</li>`;
            });
            html += `</ul></div>`;

            document.getElementById("question").innerHTML = html;
        }

        function loadStats() {
            return JSON.parse(localStorage.getItem(STATS_KEY) || "{}");
        }
        function saveStats(data) {
            localStorage.setItem(STATS_KEY, JSON.stringify(data));
        }
    </script>

</body>

</html>