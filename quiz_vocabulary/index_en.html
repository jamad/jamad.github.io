<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>English Quiz</title>

    <style>
        :root {
            --bg: #121212;
            --fg: #e0e0e0;
            --card: #1e1e1e;
            --accent: #4caf50;
            --wrong: #f44336;
            --warn: #ff9800;
        }

        body {
            margin: 0;
            background: var(--bg);
            color: var(--fg);
            font-family: system-ui, sans-serif;
            display: flex;
            justify-content: center;
        }

        #app {
            max-width: 520px;
            width: 100%;
            padding: 20px;
        }

        #progress-track {
            font-family: monospace;
            letter-spacing: 4px;
            margin-bottom: 12px;
        }

        .question-row {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }

        #question {
            flex: 1;
            background: var(--card);
            padding: 24px;
            border-radius: 8px;
            font-size: 1.6em;
            text-align: center;
        }

        #choices {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .choice-row {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        button.answer {
            flex: 1;
            padding: 12px;
            font-size: 1em;
            border-radius: 6px;
            border: none;
            background: #333;
            color: var(--fg);
            cursor: pointer;
        }

        button.answer:hover {
            background: #444;
        }

        button.correct {
            background: var(--accent);
        }

        button.wrong {
            background: var(--wrong);
        }

        button.issue {
            background: var(--warn);
            color: #000;
        }

        .issue-btn {
            background: transparent;
            border: 1px solid #666;
            border-radius: 6px;
            padding: 8px;
            cursor: pointer;
        }

        .issue-btn:hover {
            background: #333;
        }

        .word-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .word-chip {
            padding: 6px 10px;
            border-radius: 6px;
            background: #333;
        }

        .word-chip.issue {
            background: var(--warn);
            color: #000;
            cursor: pointer;
        }
    </style>
</head>

<body>
    <div id="app">
        <h1>English Quiz</h1>
        <h3>ver20251218_1132</h3>
        <div id="progress-text"></div>
        <div id="progress-track"></div>
        <div id="main"></div>
    </div>

    <script>
        const TOTAL = 10;

        const mainEl = document.getElementById("main");
        const progressTextEl = document.getElementById("progress-text");
        const progressTrackEl = document.getElementById("progress-track");

        let words = [];
        let index = 0;

        const track = Array(TOTAL).fill("*");
        const correct = [];
        const wrong = [];
        const issues = [];

        fetch("concepts.json")
            .then(r => r.json())
            .then(data => {
                words = shuffle(Object.values(data)).slice(0, TOTAL);
                updateProgress();
                showQuestion();
            })
            .catch(() => {
                mainEl.textContent = "Failed to load concepts.json";
            });

        function showQuestion() {
            const w = words[index];

            progressTextEl.textContent =
                `Question ${index + 1} / ${TOTAL}`;

            const choices = shuffle([
                w.en,
                ...shuffle(words)
                    .filter(x => x.id !== w.id)
                    .slice(0, 3)
                    .map(x => x.en)
            ]);

            mainEl.innerHTML = `
        <div class="question-row">
          <div id="question">${w.ja}</div>
          <button class="issue-btn" onclick="markQuestionIssue()">‚ö†</button>
        </div>

        <div id="choices">
          ${choices.map(c => `
            <div class="choice-row">
              <button class="answer"
                data-value="${c}"
                onclick="answer(this)">
                ${c}
              </button>
              <button class="issue-btn"
                onclick="markChoiceIssue(this, '${c}')">
                ‚ö†
              </button>
            </div>
          `).join("")}
        </div>
      `;
        }

        function answer(btn) {
            const w = words[index];
            const choice = btn.dataset.value;
            const isCorrect = choice === w.en;

            document.querySelectorAll(".answer").forEach(b => {
                b.disabled = true;
                if (b.dataset.value === w.en) {
                    b.classList.add("correct");
                } else if (!isCorrect && b === btn) {
                    b.classList.add("wrong");
                }
            });

            if (isCorrect) {
                track[index] = "O";
                correct.push(w);
            } else {
                track[index] = "X";
                wrong.push(w);
            }

            updateProgress();
            setTimeout(next, 1000);
        }

        function markQuestionIssue() {
            const w = words[index];

            if (!issues.some(i =>
                i.type === "question" && i.question.id === w.id
            )) {
                issues.push({
                    type: "question",
                    question: w
                });
            }

            notify("ÂïèÈ°åÊñá„ÇíÂïèÈ°å„ÅÇ„Çä„Å®„Åó„Å¶Ë®òÈå≤„Åó„Åæ„Åó„Åü");
        }

        function markChoiceIssue(issueBtn, choice) {
            const row = issueBtn.closest(".choice-row");
            row.querySelector(".answer").classList.add("issue");

            const w = words[index];

            if (!issues.some(i =>
                i.type === "choice" &&
                i.question.id === w.id &&
                i.choice === choice
            )) {
                issues.push({
                    type: "choice",
                    question: w,
                    choice
                });
            }
        }

        function next() {
            index++;
            index >= TOTAL ? showResult() : showQuestion();
        }

        function showResult() {
            progressTextEl.textContent = "üéâ Session Finished";

            mainEl.innerHTML = `
        <h3>Correct</h3>
        <div class="word-list">
          ${correct.map(w =>
                `<span class="word-chip">${w.en}</span>`
            ).join("")}
        </div>

        <h3>Wrong</h3>
        <div class="word-list">
          ${wrong.map(w =>
                `<span class="word-chip">${w.en}</span>`
            ).join("")}
        </div>

        <h3>‚ö† Problems</h3>
        <div class="word-list">
          ${issues.map(i => `
            <span class="word-chip issue"
              onclick="reportIssue(
                '${i.type === "question" ? i.question.en : i.choice}',
                '${i.question.ja}'
              )">
              ${i.type === "question"
                    ? `ÂïèÈ°åÊñá: ${i.question.en}`
                    : `ÈÅ∏ÊäûËÇ¢: ${i.choice}`}
            </span>
          `).join("")}
        </div>
      `;
        }

        function reportIssue(en, ja) {
            const page =
                "https://jamad.github.io/quiz_vocabulary/index_en.html";

            const url =
                "https://github.com/jamad/jamad.github.io/issues/new" +
                "?title=" + encodeURIComponent(`[quiz_vocabulary] ${en}`) +
                "&body=" + encodeURIComponent(
                    `Page: ${page}\n` +
                    `Question (JA): ${ja}\n` +
                    `Choice: ${en}\n\nProblem:`
                );

            window.open(url, "_blank");
        }

        function updateProgress() {
            progressTrackEl.textContent = track.join("");
        }

        function notify(msg) {
            alert(msg);
        }

        function shuffle(arr) {
            const a = [...arr];
            for (let i = a.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [a[i], a[j]] = [a[j], a[i]];
            }
            return a;
        }
    </script>
</body>

</html>