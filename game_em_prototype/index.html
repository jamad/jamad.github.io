<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>2D Electric Field Prototype</title>
    <style>
        body {
            margin: 0;
            background: #000;
        }

        canvas {
            display: block;
            margin: 0 auto;
            background: #111;
        }
    </style>
</head>

<body>
    <canvas id="cv" width="800" height="600"></canvas>

    <script>
        const canvas = document.getElementById("cv");
        const ctx = canvas.getContext("2d");

        // ドラッグ用の変数
        let draggingCharge = null;
        let dragOffsetX = 0;
        let dragOffsetY = 0;

        // マウス座標を取得する関数
        function getMousePos(canvas, evt) {
            const rect = canvas.getBoundingClientRect();
            return {
                x: evt.clientX - rect.left,
                y: evt.clientY - rect.top
            };
        }

        // 電荷をクリックしたか調べる関数
        function pickCharge(mx, my) {
            for (let c of charges) {
                const dx = mx - c.x;
                const dy = my - c.y;
                if (Math.sqrt(dx * dx + dy * dy) < 12) { // 半径12px
                    return c;
                }
            }
            return null;
        }



        const charges = [
            { x: 300, y: 300, q: +100 },   // 赤 = 正電荷
            { x: 500, y: 300, q: -100 },   // 青 = 負電荷
        ];

        // 電場計算
        function electricFieldAt(px, py) {
            let ex = 0, ey = 0;
            charges.forEach(c => {
                const dx = px - c.x;
                const dy = py - c.y;
                const r2 = dx * dx + dy * dy + 0.001;
                const r = Math.sqrt(r2);
                const k = c.q / r2;        // 簡易クーロン
                ex += k * dx / r;
                ey += k * dy / r;
            });
            return { ex, ey };
        }

        // 矢印描画
        function drawVector(x, y, vx, vy, scale = 50) {
            const px = x;
            const py = y;
            const ex = vx * scale;
            const ey = vy * scale;

            ctx.beginPath();
            ctx.moveTo(px, py);
            ctx.lineTo(px + ex, py + ey);
            ctx.strokeStyle = "#0f8";
            ctx.lineWidth = 1;
            ctx.stroke();
        }

        function render() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // 電場ベクトルを描画（格子状）
            const step = 40;
            for (let x = 0; x < canvas.width; x += step) {
                for (let y = 0; y < canvas.height; y += step) {
                    const f = electricFieldAt(x, y);

                    // 正規化
                    const mag = Math.sqrt(f.ex * f.ex + f.ey * f.ey) + 0.0001;
                    const nx = f.ex / mag;
                    const ny = f.ey / mag;

                    drawVector(x, y, nx, ny, 15);
                }
            }

            //マウスイベントの追加
            canvas.addEventListener("mousedown", (e) => {
                const pos = getMousePos(canvas, e);
                const c = pickCharge(pos.x, pos.y);
                if (c) {
                    draggingCharge = c;
                    dragOffsetX = pos.x - c.x;
                    dragOffsetY = pos.y - c.y;
                }
            });

            canvas.addEventListener("mousemove", (e) => {
                if (draggingCharge) {
                    const pos = getMousePos(canvas, e);
                    draggingCharge.x = pos.x - dragOffsetX;
                    draggingCharge.y = pos.y - dragOffsetY;
                }
            });

            canvas.addEventListener("mouseup", () => {
                draggingCharge = null;
            });

            canvas.addEventListener("mouseleave", () => {
                draggingCharge = null;
            });


            // 電荷を描画
            charges.forEach(c => {
                ctx.beginPath();
                ctx.arc(c.x, c.y, 15, 0, Math.PI * 2);
                ctx.fillStyle = c.q > 0 ? "#f44" : "#44f";
                ctx.fill();
            });

            requestAnimationFrame(render);
        }

        render();
    </script>
</body>

</html>