<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>Electric Field Stream Particles - Multi Group</title>
    <style>
        body {
            margin: 0;
            background: #000;
            overflow: hidden;
        }

        canvas {
            display: block;
            margin: 0 auto;
            background: #111;
        }
    </style>
</head>

<body>
    <canvas id="cv" width="800" height="600"></canvas>

    <script>
        const canvas = document.getElementById("cv");
        const ctx = canvas.getContext("2d");

        //=============================================
        // Charges
        //=============================================
        const charges = [
            { x: 300, y: 300, q: +200 },
            { x: 500, y: 300, q: -200 },
        ];

        function electricFieldAt(px, py) {
            let ex = 0, ey = 0;
            for (let c of charges) {
                const dx = px - c.x;
                const dy = py - c.y;
                const r2 = dx * dx + dy * dy + 0.01;
                const r = Math.sqrt(r2);
                const k = c.q / r2;
                ex += k * dx / r;
                ey += k * dy / r;
            }
            return { ex, ey };
        }

        //=============================================
        // GROUP SETTINGS (←ここを変えるだけでOK)
        //=============================================

        // ★ 4, 8, 16 に自由に変更可能  
        const GROUP_COUNT = 16;

        // 粒子の寿命（各グループの周期と同じ）
        const PARTICLE_LIFETIME = 2000;

        //=============================================
        // Particle Groups
        //=============================================
        const groups = [];
        for (let i = 0; i < GROUP_COUNT; i++) {
            groups.push({
                particles: [],
                lastSpawn: performance.now() + (i * (PARTICLE_LIFETIME / GROUP_COUNT)),
                color: `hsl(${(i * 360 / GROUP_COUNT)}, 100%, 60%)` // グループごとに色分け
            });
        }

        const FIELD_W = canvas.width;
        const FIELD_H = canvas.height;
        const GRID_STEP = 16;

        function spawnParticles(list) {
            list.length = 0;
            for (let x = 0; x < FIELD_W + GRID_STEP * 2; x += GRID_STEP) {
                for (let y = 0; y < FIELD_H + GRID_STEP * 2; y += GRID_STEP) {
                    list.push({ x, y, life: PARTICLE_LIFETIME });
                }
            }
        }

        function updateParticles(list, dt) {
            for (let p of list) {
                if (p.life <= 0) continue;

                const f = electricFieldAt(p.x, p.y);
                const mag = Math.sqrt(f.ex * f.ex + f.ey * f.ey) + 0.001;

                p.x += (f.ex / mag) * dt * 0.02;
                p.y += (f.ey / mag) * dt * 0.02;

                p.life -= dt;
            }
        }

        function drawParticles(list, color) {
            ctx.fillStyle = color;
            for (let p of list) {
                if (p.life > 0) {
                    ctx.fillRect(p.x, p.y, 2, 2);
                }
            }
        }

        //=============================================
        // Render Loop
        //=============================================
        let prevTime = performance.now();

        function render() {
            const now = performance.now();
            const dt = now - prevTime;
            prevTime = now;

            ctx.clearRect(0, 0, canvas.width, canvas.height);

            for (let g of groups) {

                // 各グループは等間隔でリセットされる
                if (now - g.lastSpawn >= PARTICLE_LIFETIME) {
                    spawnParticles(g.particles);
                    g.lastSpawn = now;
                }

                updateParticles(g.particles, dt);
                drawParticles(g.particles, g.color);
            }

            // charges
            for (let c of charges) {
                ctx.beginPath();
                ctx.arc(c.x, c.y, 15, 0, Math.PI * 2);
                ctx.fillStyle = c.q > 0 ? "#f44" : "#44f";
                ctx.fill();
            }

            requestAnimationFrame(render);
        }

        render();
    </script>
</body>

</html>